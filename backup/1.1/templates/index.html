<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="utf-t" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aplikasi Pencatatan Keuangan</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      color: #212529;
      padding-bottom: 150px;
      /* Ruang untuk footer */
    }

    .page {
      display: none;
    }

    #login-page {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .menu-card {
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .menu-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .toast-container {
      z-index: 1150;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"] {
      -moz-appearance: textfield;
    }

    .sticky-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: white;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease-in-out;
      transform: translateY(0);
      /* Posisi awal (terbuka) */
    }

    .footer-hidden {
      /* Geser ke bawah sebesar 100% dikurangi tinggi handle (misal 45px) */
      transform: translateY(calc(100% - 35px));
    }

    .btn-action {
      width: 38px;
    }

    .password-cell .form-control {
      border: none;
      background: transparent;
      padding: 0;
    }

    /* Gaya Tabel Baru */
    .table-responsive {
      max-height: 65vh;
    }

    .table thead th {
      position: sticky;
      top: 0;
      background: #e9ecef;
      z-index: 1;
    }

    .input-stok {
      max-width: 90px;
    }

    .product-supplier-info small {
      font-size: 0.8em;
      color: #6c757d;
    }

    /* Invoice Styles */
    .invoice-box {
      max-width: 800px;
      margin: auto;
      padding: 30px;
      border: 1px solid #eee;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
      font-size: 16px;
      line-height: 24px;
      font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif;
      color: #555;
    }

    .invoice-box table {
      width: 100%;
      line-height: inherit;
      text-align: left;
    }

    .invoice-box table td {
      padding: 5px;
      vertical-align: top;
    }

    .invoice-box table tr.top table td {
      padding-bottom: 20px;
    }

    .invoice-box table tr.information table td {
      padding-bottom: 40px;
    }

    .invoice-box table tr.heading td {
      background: #eee;
      border-bottom: 1px solid #ddd;
      font-weight: bold;
    }

    .invoice-box table tr.details td {
      padding-bottom: 20px;
    }

    .invoice-box table tr.item td {
      border-bottom: 1px solid #eee;
    }

    .invoice-box table tr.item.last td {
      border-bottom: none;
    }

    .invoice-box table tr.total td:nth-child(2) {
      border-top: 2px solid #eee;
      font-weight: bold;
    }

    .text-purple {
      color: #6f42c1;
    }

    /* Tambahkan kode ini di dalam tag <style> */
    .footer-hidden #footer-content {
      visibility: hidden;
    }

    /* (Letakkan ini di dalam tag <style>) */

    .report-card {
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      border-left: 5px solid #0d6efd;
      /* Aksen warna biru */
    }

    .report-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    /* (Letakkan ini di dalam tag <style>) */

    .kpi-card {
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .kpi-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    /* --- CSS KHUSUS SUPEROWNER MOBILE --- */

    /* Spacer agar konten tidak tertutup navigasi bawah */
    #superowner-pages {
      padding-bottom: 80px;
    }

    /* Navigasi Bawah Tetap */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #ffffff;
      border-top: 1px solid #dee2e6;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      z-index: 1050;
      /* Lebih tinggi dari konten biasa */
      padding: 0.5rem 0;
      display: none;
      /* Default hidden, dimunculkan via JS */
    }

    .bottom-nav-link {
      color: #6c757d;
      font-size: 0.75rem;
      text-decoration: none;
      background: none;
      border: none;
      flex: 1;
      /* Agar lebar rata */
    }

    .bottom-nav-link:hover {
      color: #0d6efd;
    }

    .bottom-nav-link.active {
      color: #0d6efd;
      font-weight: 500;
    }

    .bottom-nav-link i {
      font-size: 1.5rem;
      display: block;
      margin-bottom: 2px;
    }

    /* Kartu KPI Simple (2x2) */
    .kpi-card-simple {
      background-color: #fff;
      border: 1px solid #dee2e6;
      border-radius: 0.75rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
      transition: transform 0.2s;
    }

    .kpi-card-simple:active {
      transform: scale(0.98);
    }

    /* --- CSS Tambahan untuk Mobile Owner --- */

    /* Spacer agar konten paling bawah tidak tertutup nav bar */
    #owner-pages {
      padding-bottom: 80px;
    }

    /* Navigasi Bawah Tetap (Reused style from Superowner/Alt design) */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #ffffff;
      border-top: 1px solid #dee2e6;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      z-index: 1050;
      padding: 0.5rem 0;
      display: none;
      /* Default hidden, muncul via JS */
    }

    .bottom-nav-link {
      color: #6c757d;
      font-size: 0.75rem;
      text-decoration: none;
      background: none;
      border: none;
      flex: 1;
      /* Agar lebar rata */
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .bottom-nav-link:hover {
      color: #0d6efd;
    }

    .bottom-nav-link.active {
      color: #0d6efd;
      font-weight: 500;
    }

    .bottom-nav-link i {
      font-size: 1.5rem;
      display: block;
      margin-bottom: 2px;
    }

    /* List Group Item Custom Action (Panah di kanan) */
    .list-group-item-action {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    /* --- CSS KHUSUS SUPPLIER MOBILE --- */

    /* Spacer agar konten tidak tertutup navigasi bawah */
    #supplier-pages {
      padding-bottom: 80px;
    }

    /* Container Notifikasi agar bisa di-scroll jika panjang */
    .notification-list-scroll {
      max-height: calc(100vh - 250px);
      /* Menyesuaikan tinggi layar */
      overflow-y: auto;
    }

    /* Style tambahan untuk item notifikasi */
    .list-group-item.notification-new {
      background-color: #fff3cd;
      /* Warna kuning warning bootstrap */
      border-left: 5px solid #ffc107;
    }

    /* --- CSS KHUSUS TAMPILAN BARU LAPAK (MOBILE WIZARD) --- */
    .progress-container {
      position: -webkit-sticky;
      /* Untuk dukungan Safari */
      position: sticky;
      top: 0;
      background-color: #f8f9fa;
      padding: 1rem 0;
      z-index: 1020;
      /* Sedikit di bawah navbar/toast */
      border-bottom: 1px solid #dee2e6;
      margin-bottom: 1.5rem;
    }

    /* Pastikan card langkah terlihat rapi */
    .step-card {
      border: none;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      margin-bottom: 1.5rem;
    }

    .step-header {
      background-color: #fff;
      border-bottom: 1px solid rgba(0, 0, 0, .125);
      padding: 1rem 1.25rem;
    }

    /* --- CSS KHUSUS HISTORY LAPORAN --- */
    .history-card {
      border: 1px solid #dee2e6;
      border-left: 5px solid #6c757d;
      /* Default abu-abu */
      transition: all 0.2s ease-in-out;
      background-color: white;
    }

    .history-card.confirmed {
      border-left-color: #198754;
      /* Hijau untuk terkonfirmasi */
    }

    .history-card.pending {
      border-left-color: #ffc107;
      /* Kuning untuk pending */
    }

    .history-card:hover {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      transform: translateY(-2px);
    }

    .history-header {
      cursor: pointer;
      padding: 1rem;
    }

    .history-detail-table th {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background-color: #f8f9fa;
    }

    .history-detail-table td {
      font-size: 0.9rem;
      vertical-align: middle;
    }

    .badge-supplier {
      font-size: 0.75rem;
      background-color: #e9ecef;
      color: #495057;
      padding: 4px 8px;
      border-radius: 4px;
    }

    /* Tambahkan ini di bagian <style> */
    .clickable-card {
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .clickable-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
    }

    .clickable-card:active {
      transform: scale(0.98);
    }
  </style>
</head>

<body>
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <i id="toast-icon" class="bi me-2"></i>
        <strong class="me-auto" id="toast-title"></strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
      </div>
      <div class="toast-body" id="toast-body"></div>
    </div>
  </div>

  <div id="login-page" class="page">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-5 col-lg-4">
          <div class="card shadow-sm border-0">
            <div class="card-body p-4">
              <div class="text-center mb-4">
                <i class="bi bi-shop-window" style="font-size: 3rem; color: #0d6efd"></i>
                <h3 class="card-title mt-2">Selamat Datang</h3>
                <p class="text-muted">Masuk untuk melanjutkan</p>
              </div>
              <form id="login-form">
                <div class="mb-3">
                  <label for="username" class="form-label">Username</label>
                  <input type="text" class="form-control" id="username" required />
                </div>
                <div class="mb-3">
                  <label for="password" class="form-label">Password</label>
                  <div class="input-group">
                    <input type="password" class="form-control" id="password" required />
                    <button class="btn btn-outline-secondary" type="button"
                      onclick="togglePasswordVisibility(this, 'password')">
                      <i class="bi bi-eye-slash"></i>
                    </button>
                  </div>
                </div>
                <div class="d-grid mt-4">
                  <button type="submit" class="btn btn-primary">Login</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main id="owner-pages">
    <div id="owner-dashboard" class="page container py-4">
      <header class="d-flex justify-content-between align-items-center pb-3 mb-4 border-bottom">
        <div>
          <h4 class="mb-0">Dashboard, <span id="owner-name">Owner</span></h4>
          <p class="text-muted mb-0 small" id="current-date-owner"></p>
        </div>
        <button class="btn btn-outline-danger btn-sm" onclick="handleLogout()">
          <i class="bi bi-box-arrow-right"></i>
        </button>
      </header>

      <h5 class="mb-3">Ringkasan Bulan Ini</h5>
      <div class="row row-cols-2 g-3 mb-4">
        <div class="col">
          <div class="card bg-success text-white shadow-sm h-100" onclick="showPage('owner-laporan-pendapatan-page')"
            style="cursor: pointer;">
            <div class="card-body p-3">
              <h6 class="card-title small"><i class="bi bi-cash-coin"></i> Pendapatan</h6>
              <h4 id="owner-pendapatan-card">Rp 0</h4>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card bg-warning text-dark shadow-sm h-100" onclick="showPage('owner-pembayaran-page')"
            style="cursor: pointer;">
            <div class="card-body p-3">
              <h6 class="card-title small"><i class="bi bi-truck"></i> Biaya</h6>
              <h4 id="owner-biaya-card">Rp 0</h4>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card bg-info text-white shadow-sm h-100" onclick="showPage('owner-manage-reports-page')"
            style="cursor: pointer;">
            <div class="card-body p-3">
              <h6 class="card-title small"><i class="bi bi-person-wallet"></i> Profit Anda</h6>
              <h4 id="owner-profit-card">Rp 0</h4>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card bg-secondary text-white shadow-sm h-100" onclick="showPage('owner-manage-reports-page')"
            style="cursor: pointer;">
            <div class="card-body p-3">
              <h6 class="card-title small"><i class="bi bi-arrow-up-right-circle-fill"></i> Disetor</h6>
              <h4 id="owner-superowner-profit-card">Rp 0</h4>
            </div>
          </div>
        </div>
      </div>

      <h5 class="mb-3">Akses Cepat</h5>
      <div class="card bg-primary text-light shadow-sm mb-4" onclick="showPageAndNav('owner-manage-reports-page')"
        style="cursor: pointer;">
        <div class="card-body p-4 d-flex align-items-center">
          <i class="bi bi-mailbox-flag display-6 me-3"></i>
          <div>
            <h5 class="card-title mb-0 fw-bold">Periksa Laporan Masuk</h5>
            <p class="mb-0 small">Cek laporan baru menunggu konfirmasi hari ini.</p>
          </div>
        </div>
      </div>

      <h5 class="mb-3">Manajemen Data</h5>
      <div class="list-group mb-4 shadow-sm">
        <div class="list-group-item list-group-item-action d-flex align-items-center p-3"
          onclick="showPage('owner-data-admin-page')">
          <i class="bi bi-person-badge-fill text-info fs-4 me-3"></i>
          <div><strong class="mb-0 d-block">Data Admin</strong><small class="text-muted">Kelola akun admin
              pencatat</small></div><i class="bi bi-chevron-right ms-auto text-muted"></i>
        </div>
        <div class="list-group-item list-group-item-action d-flex align-items-center p-3"
          onclick="showPage('owner-data-lapak-page')">
          <i class="bi bi-shop text-success fs-4 me-3"></i>
          <div><strong class="mb-0 d-block">Data Lapak</strong><small class="text-muted">Lokasi & penugasan</small>
          </div><i class="bi bi-chevron-right ms-auto text-muted"></i>
        </div>
        <div class="list-group-item list-group-item-action d-flex align-items-center p-3"
          onclick="showPage('owner-data-supplier-page')">
          <i class="bi bi-truck text-warning fs-4 me-3"></i>
          <div><strong class="mb-0 d-block">Data Supplier</strong><small class="text-muted">Vendor produk &
              kontak</small></div><i class="bi bi-chevron-right ms-auto text-muted"></i>
        </div>
        <div class="list-group-item list-group-item-action d-flex align-items-center p-3"
          onclick="showPage('owner-supplier-history-page')">
          <i class="bi bi-clock-history text-secondary fs-4 me-3"></i>
          <div><strong class="mb-0 d-block">Riwayat Supplier</strong><small class="text-muted">Cek history penjualan
              vendor</small></div><i class="bi bi-chevron-right ms-auto text-muted"></i>
        </div>
      </div>

      <div class="card shadow-sm mb-5 border-0">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
          <h6 class="mb-0 fw-bold"><i class="bi bi-graph-up-arrow text-primary me-2"></i>Analisis Keuangan</h6>
          <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
            data-bs-target="#chartFilters">
            <i class="bi bi-funnel"></i> Filter
          </button>
        </div>

        <div class="collapse border-bottom" id="chartFilters">
          <div class="card-body bg-light">
            <div class="row g-2">
              <div class="col-5">
                <select id="chart-month-select" class="form-select form-select-sm">
                  <option value="1">Januari</option>
                  <option value="2">Februari</option>
                  <option value="3">Maret</option>
                  <option value="4">April</option>
                  <option value="5">Mei</option>
                  <option value="6">Juni</option>
                  <option value="7">Juli</option>
                  <option value="8">Agustus</option>
                  <option value="9">September</option>
                  <option value="10">Oktober</option>
                  <option value="11">November</option>
                  <option value="12">Desember</option>
                </select>
              </div>
              <div class="col-4">
                <select id="chart-year-select" class="form-select form-select-sm"></select>
              </div>
              <div class="col-3 d-grid">
                <button id="chart-filter-btn" class="btn btn-primary btn-sm">Cek</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card-body">
          <div id="chart-loading" class="text-center py-4" style="display: none;">
            <div class="spinner-border spinner-border-sm text-primary"></div>
          </div>

          <div id="chart-content">
            <ul class="nav nav-tabs nav-fill mb-3" id="chartTabs" role="tablist">
              <li class="nav-item">
                <button class="nav-link active small py-1" data-bs-toggle="tab"
                  data-bs-target="#tab-pendapatan">Pendapatan</button>
              </li>
              <li class="nav-item">
                <button class="nav-link small py-1" data-bs-toggle="tab" data-bs-target="#tab-biaya">Biaya</button>
              </li>
            </ul>
            <div class="tab-content">
              <div class="tab-pane fade show active" id="tab-pendapatan">
                <canvas id="pendapatanChart" style="max-height: 250px;"></canvas>
              </div>
              <div class="tab-pane fade" id="tab-biaya">
                <canvas id="biayaChart" style="max-height: 250px;"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="owner-laporan-biaya-page" class="page container py-4">
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <button class="btn btn-light me-3" onclick="showPage('owner-dashboard')">
          <i class="bi bi-arrow-left"></i>
        </button>
        <h4 class="mb-0">Laporan Biaya Supplier Harian</h4>
      </header>
      <div class="row mb-3 align-items-center">
        <div class="col-md-4">
          <label for="laporan-biaya-datepicker" class="form-label">Pilih Tanggal Laporan:</label><input type="date"
            class="form-control" id="laporan-biaya-datepicker" />
        </div>
        <div class="col-md-8">
          <div class="card bg-warning text-dark mt-3">
            <div class="card-body text-end">
              <h6 class="card-title">
                Total Biaya Supplier Tanggal Terpilih
              </h6>
              <h3 class="display-6" id="total-biaya-harian">Rp 0</h3>
            </div>
          </div>
        </div>
      </div>
      <div class="accordion" id="laporan-biaya-accordion">
        <div class="text-center p-5">
          <div class="spinner-border text-warning"></div>
          <p class="mt-2 text-muted">Memuat data...</p>
        </div>
      </div>
    </div>
    <div id="owner-laporan-pendapatan-page" class="page container py-4">
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <button class="btn btn-light me-3" onclick="showPage('owner-dashboard')">
          <i class="bi bi-arrow-left"></i>
        </button>
        <h4 class="mb-0">Laporan Pendapatan Harian</h4>
      </header>
      <div class="row mb-3 align-items-center">
        <div class="col-md-4">
          <label for="laporan-pendapatan-datepicker" class="form-label">Pilih Tanggal Laporan:</label><input type="date"
            class="form-control" id="laporan-pendapatan-datepicker" />
        </div>
        <div class="col-md-8">
          <div class="card text-bg-success mt-3">
            <div class="card-body text-end">
              <h6 class="card-title">Total Pendapatan Tanggal Terpilih</h6>
              <h3 class="display-6" id="total-pendapatan-harian">Rp 0</h3>
            </div>
          </div>
        </div>
      </div>
      <div class="accordion" id="laporan-pendapatan-accordion">
        <div class="text-center p-5">
          <div class="spinner-border text-primary"></div>
          <p class="mt-2 text-muted">Memuat data...</p>
        </div>
      </div>
    </div>
    <div id="owner-data-admin-page" class="page container py-4">
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <button class="btn btn-light me-3" onclick="showPage('owner-dashboard')">
          <i class="bi bi-arrow-left"></i>
        </button>
        <h4 class="mb-0">Data Admin</h4>
      </header>
      <div class="d-grid mb-3">
        <button class="btn btn-primary" onclick="openEditModal('admin')">
          <i class="bi bi-plus-circle-fill"></i> Tambah Admin Baru
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Nama Lengkap</th>
              <th>Username</th>
              <th>Email</th>
              <th>Kontak</th>
              <th>Password</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="admin-table-body"></tbody>
        </table>
      </div>
    </div>
    <div id="owner-data-lapak-page" class="page container py-4">
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <button class="btn btn-light me-3" onclick="showPage('owner-dashboard')">
          <i class="bi bi-arrow-left"></i>
        </button>
        <h4 class="mb-0">Data Lapak</h4>
      </header>
      <div class="d-grid mb-3">
        <button class="btn btn-primary" onclick="openEditModal('lapak')">
          <i class="bi bi-plus-circle-fill"></i> Tambah Lapak Baru
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Lokasi Lapak</th>
              <th>Penanggung Jawab</th>
              <th>Anggota</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="lapak-table-body"></tbody>
        </table>
      </div>
    </div>
    <div id="owner-data-supplier-page" class="page container py-4">
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <button class="btn btn-light me-3" onclick="showPage('owner-dashboard')">
          <i class="bi bi-arrow-left"></i>
        </button>
        <h4 class="mb-0">Data Supplier</h4>
      </header>
      <div class="d-grid mb-3">
        <button class="btn btn-primary" onclick="openEditModal('supplier')">
          <i class="bi bi-plus-circle-fill"></i> Tambah Supplier Baru
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Nama Supplier</th>
              <th>Username</th>
              <th>Kontak</th>
              <th>No. Register</th>
              <th>Password</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="supplier-table-body"></tbody>
        </table>
      </div>
    </div>
    <div id="owner-pembayaran-page" class="page container py-4">
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <button class="btn btn-light me-3" onclick="showPage('owner-dashboard')"><i
            class="bi bi-arrow-left"></i></button>
        <h4 class="mb-0">Pembayaran Tagihan Supplier</h4>
      </header>

      <div id="pembayaran-content-loading" class="text-center p-5">
        <div class="spinner-border text-primary"></div>
        <p class="mt-2 text-muted">Memuat data pembayaran...</p>
      </div>

      <div id="pembayaran-content-main" style="display: none;">
        <ul class="nav nav-tabs nav-fill mb-3" id="paymentTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tagihan-tab" data-bs-toggle="tab" data-bs-target="#tagihan-tab-pane"
              type="button" role="tab">
              <i class="bi bi-wallet2 me-2"></i>Tagihan Saat Ini
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="riwayat-tab" data-bs-toggle="tab" data-bs-target="#riwayat-tab-pane"
              type="button" role="tab">
              <i class="bi bi-clock-history me-2"></i>Riwayat Pembayaran
            </button>
          </li>
        </ul>

        <div class="tab-content" id="paymentTabsContent">

          <div class="tab-pane fade show active" id="tagihan-tab-pane" role="tabpanel" aria-labelledby="tagihan-tab">
            <div class="row g-3 my-2 align-items-end">
              <div class="col-md-4">
                <label for="tagihan-metode-filter" class="form-label small">Filter Metode Pembayaran</label>
                <select id="tagihan-metode-filter" class="form-select form-select-sm">
                  <option value="semua">Semua Metode</option>
                  <option value="BCA">BCA</option>
                  <option value="DANA">DANA</option>
                </select>
              </div>
            </div>
            <h5 class="mb-3 mt-3">Daftar Tagihan Supplier</h5>
            <div class="table-responsive">
              <table class="table table-striped table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Nama Supplier</th>
                    <th>Total Tagihan</th>
                    <th>Status</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="pembayaran-table-body">
                </tbody>
              </table>
            </div>
          </div>

          <div class="tab-pane fade" id="riwayat-tab-pane" role="tabpanel" aria-labelledby="riwayat-tab">
            <h5 class="mb-3 mt-3">Riwayat Pembayaran</h5>

            <div class="p-3 bg-light border rounded mb-4">
              <div class="row g-3 align-items-end">
                <div class="col-md-3">
                  <label for="payment-history-method" class="form-label">Metode</label>
                  <select id="payment-history-method" class="form-select">
                    <option value="semua">Semua</option>
                    <option value="BCA">BCA</option>
                    <option value="DANA">DANA</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Navigasi Riwayat Harian</label>
                  <div class="btn-group w-100">
                    <button class="btn btn-outline-secondary" type="button" id="payment-history-prev-day"><i
                        class="bi bi-chevron-left"></i></button>
                    <input type="date" id="payment-history-daily-date" class="form-control text-center"
                      style="min-width: 150px;">
                    <button class="btn btn-outline-secondary" type="button" id="payment-history-next-day"><i
                        class="bi bi-chevron-right"></i></button>
                  </div>
                </div>
                <div class="col-md-3 d-grid">
                  <button class="btn btn-outline-info" data-bs-toggle="collapse"
                    data-bs-target="#advanced-payment-filter">
                    <i class="bi bi-sliders"></i> Filter Canggih
                  </button>
                </div>
              </div>
              <div class="collapse mt-3" id="advanced-payment-filter">
                <div class="row g-3 align-items-end p-3 border rounded bg-white">
                  <div class="col-md-5">
                    <label for="payment-history-start-date" class="form-label">Tanggal Mulai</label>
                    <input type="date" id="payment-history-start-date" class="form-control">
                  </div>
                  <div class="col-md-5">
                    <label for="payment-history-end-date" class="form-label">Tanggal Akhir</label>
                    <input type="date" id="payment-history-end-date" class="form-control">
                  </div>
                  <div class="col-md-2 d-grid">
                    <button id="payment-history-filter-btn" class="btn btn-primary">
                      <i class="bi bi-funnel-fill"></i> Terapkan
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div id="payment-history-loading" class="text-center p-4" style="display: none;">
              <div class="spinner-border spinner-border-sm"></div>
            </div>
            <div class="table-responsive">
              <table class="table table-sm table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Tanggal</th>
                    <th>Supplier</th>
                    <th>Jumlah</th>
                    <th>Metode</th>
                    <th>Keterangan</th>
                  </tr>
                </thead>
                <tbody id="payment-history-table-body">
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="owner-manage-reports-page" class="page container py-4">
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <button class="btn btn-light me-3" onclick="showPage('owner-dashboard')"><i
            class="bi bi-arrow-left"></i></button>
        <h4 class="mb-0">Manajemen Laporan</h4>
      </header>

      <div class="p-3 bg-light border rounded mb-4">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label for="manage-reports-status-filter" class="form-label">Filter Status</label>
            <select id="manage-reports-status-filter" class="form-select">
              <option value="Menunggu Konfirmasi" selected>Menunggu Konfirmasi</option>
              <option value="Terkonfirmasi">Terkonfirmasi</option>
              <option value="semua">Semua Status</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="manage-reports-supplier-filter" class="form-label">Filter per Supplier</label>
            <select id="manage-reports-supplier-filter" class="form-select">
              <option value="">Semua Supplier</option>
            </select>
          </div>
          <div class="col-md-5">
            <label class="form-label">Navigasi Laporan Harian</label>
            <div class="btn-group w-100">
              <button class="btn btn-outline-secondary" type="button" id="manage-reports-prev-day"><i
                  class="bi bi-chevron-left"></i></button>
              <input type="date" id="manage-reports-daily-date" class="form-control text-center"
                style="min-width: 150px;">
              <button class="btn btn-outline-secondary" type="button" id="manage-reports-next-day"><i
                  class="bi bi-chevron-right"></i></button>
            </div>
          </div>
          <div class="col-md-3 d-grid">
            <button class="btn btn-outline-info" data-bs-toggle="collapse" data-bs-target="#advanced-reports-filter">
              <i class="bi bi-sliders"></i> Filter Canggih
            </button>
          </div>
        </div>
        <div class="collapse mt-3" id="advanced-reports-filter">
          <div class="row g-3 align-items-end p-3 border rounded bg-white">
            <div class="col-md-5">
              <label for="manage-reports-start-date" class="form-label">Tanggal Mulai</label>
              <input type="date" id="manage-reports-start-date" class="form-control">
            </div>
            <div class="col-md-5">
              <label for="manage-reports-end-date" class="form-label">Tanggal Akhir</label>
              <input type="date" id="manage-reports-end-date" class="form-control">
            </div>
            <div class="col-md-2 d-grid">
              <button id="manage-reports-filter-btn" class="btn btn-primary">
                <i class="bi bi-funnel-fill"></i> Terapkan
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="text-center p-5" id="manage-reports-loading">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Memuat data laporan...</p>
      </div>

      <div id="manage-reports-content" style="display: none">
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Lapak</th>
                <th>PJ</th>
                <th>Tanggal</th>
                <th>Pendapatan</th>
                <th>Profit Anda</th>
                <th>Profit Superowner</th>
                <th>Status</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="unconfirmed-reports-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div id="owner-supplier-history-page" class="page container py-4">
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <button class="btn btn-light me-3" onclick="showPage('owner-dashboard')"><i
            class="bi bi-arrow-left"></i></button>
        <h4 class="mb-0">Riwayat per Supplier</h4>
      </header>
      <div class="row g-3 mb-4 align-items-end p-3 bg-light border rounded">
        <div class="col-md-4">
          <label for="owner-supplier-select" class="form-label">Pilih Supplier:</label>
          <select id="owner-supplier-select" class="form-select">
            <option selected value="">-- Pilih Supplier --</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="owner-history-start-date" class="form-label">Tanggal Mulai</label>
          <input type="date" id="owner-history-start-date" class="form-control">
        </div>
        <div class="col-md-3">
          <label for="owner-history-end-date" class="form-label">Tanggal Akhir</label>
          <input type="date" id="owner-history-end-date" class="form-control">
        </div>
        <div class="col-md-2 d-grid">
          <button id="owner-history-filter-btn" class="btn btn-primary">
            <i class="bi bi-funnel-fill"></i> Terapkan
          </button>
        </div>
      </div>

      <div id="owner-supplier-history-loading" class="text-center p-5" style="display: none;">
        <div class="spinner-border text-primary"></div>
      </div>

      <div id="owner-supplier-history-content" style="display: none;">
        <div class="row">
          <div class="col-lg-8">
            <h5 class="mb-3">Riwayat Penjualan Produk</h5>
            <div class="table-responsive" style="max-height: 50vh;">
              <table class="table table-striped table-sm">
                <thead class="table-light">
                  <tr>
                    <th>Tanggal</th>
                    <th>Lapak</th>
                    <th>Produk</th>
                    <th>Terjual</th>
                    <th>Nominal</th>
                  </tr>
                </thead>
                <tbody id="owner-supplier-sales-body"></tbody>
              </table>
            </div>
          </div>
          <div class="col-lg-4">
            <h5 class="mb-3">Riwayat Pembayaran Diterima</h5>
            <div class="table-responsive" style="max-height: 50vh;">
              <table class="table table-striped table-sm">
                <thead class="table-light">
                  <tr>
                    <th>Tanggal</th>
                    <th>Jumlah</th>
                    <th>Metode</th>
                  </tr>
                </thead>
                <tbody id="owner-supplier-payment-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="owner-chart-page" class="page container py-4">
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <button class="btn btn-light me-3" onclick="showPage('owner-dashboard')"><i
            class="bi bi-arrow-left"></i></button>
        <h4 class="mb-0">Analisis Grafik Pendapatan & Biaya</h4>
      </header>

      <div class="row g-3 mb-4 align-items-end p-3 bg-light border rounded">
        <div class="col-md-5">
          <label for="chart-month-select" class="form-label">Bulan</label>
          <select id="chart-month-select" class="form-select">
            <option value="1">Januari</option>
            <option value="2">Februari</option>
            <option value="3">Maret</option>
            <option value="4">April</option>
            <option value="5">Mei</option>
            <option value="6">Juni</option>
            <option value="7">Juli</option>
            <option value="8">Agustus</option>
            <option value="9">September</option>
            <option value="10">Oktober</option>
            <option value="11">November</option>
            <option value="12">Desember</option>
          </select>
        </div>
        <div class="col-md-5">
          <label for="chart-year-select" class="form-label">Tahun</label>
          <select id="chart-year-select" class="form-select"></select>
        </div>
        <div class="col-md-2 d-grid">
          <button id="chart-filter-btn" class="btn btn-primary">
            <i class="bi bi-search"></i> Tampilkan
          </button>
        </div>
      </div>

      <div id="chart-loading" class="text-center p-5" style="display: none;">
        <div class="spinner-border text-primary"></div>
        <p class="mt-2 text-muted">Memuat data grafik...</p>
      </div>

      <div id="chart-content">
        <div class="row">
          <div class="col-lg-6 mb-4">
            <h5 class="text-center text-success mb-3">Grafik Pendapatan Harian</h5>
            <canvas id="pendapatanChart"></canvas>
          </div>
          <div class="col-lg-6 mb-4">
            <h5 class="text-center text-danger mb-3">Grafik Biaya Supplier Harian</h5>
            <canvas id="biayaChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div id="owner-verification-center-page" class="page container py-4" style="display: none;">
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <button class="btn btn-light me-3" onclick="showPage('owner-dashboard')">
          <i class="bi bi-arrow-left"></i>
        </button>
        <h4 class="mb-0">Finalisasi Laporan (Siap Diteruskan)</h4>
      </header>

      <div id="verification-center-loading" class="text-center p-5">
        <div class="spinner-border text-primary"></div>
      </div>

      <div id="verification-center-content" style="display: none;">
        <div class="alert alert-info">
          <i class="bi bi-info-circle-fill"></i>
          Di sini Anda dapat meninjau semua laporan yang masuk dari admin lapak sebelum difinalisasi. Setelah semua
          laporan diperiksa, klik tombol "Finalisasi" di bawah.
        </div>

        <div id="verification-report-list" class="list-group mb-4">
        </div>

        <div class="d-grid">
          <button class="btn btn-success btn-lg" onclick="handleFinalizeReports()">
            <i class="bi bi-check-all"></i> Finalisasi & Kirim Laporan Gabungan
          </button>
        </div>
      </div>
    </div>
  </main>

  <main id="lapak-pages">
    <div id="lapak-dashboard" class="page container py-4">
      <header class="d-flex justify-content-between align-items-center pb-3 mb-0 border-bottom">
        <div>
          <h4 class="mb-0">Laporan Harian</h4>
          <p class="text-muted mb-0 small"><span id="lapak-name">User</span> | <span id="current-date-lapak"></span></p>
        </div>
        <button class="btn btn-outline-danger btn-sm" onclick="handleLogout()">
          <i class="bi bi-box-arrow-right"></i>
        </button>
      </header>

      <div id="laporan-loading" class="text-center p-5">
        <div class="spinner-border text-primary"></div>
        <p class="mt-2 text-muted">Memuat data...</p>
      </div>

      <div id="laporan-exists" style="display: none" class="mt-4 animate-fade-in">

        <div class="text-center mb-5">
          <div
            class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3 shadow-sm"
            style="width: 80px; height: 80px;">
            <i class="bi bi-check-lg" style="font-size: 2.5rem;"></i>
          </div>
          <h4 class="fw-bold text-dark">Laporan Terkirim!</h4>
          <p class="text-muted small px-4">Terima kasih, data penjualan hari ini sudah berhasil masuk ke sistem.</p>
        </div>

        <div class="card shadow-sm border-0 report-card mb-3" onclick="showPage('history-laporan-page')">
          <div class="card-body p-4 d-flex align-items-center">
            <div
              class="bg-primary bg-opacity-10 rounded-circle me-3 text-primary d-flex align-items-center justify-content-center flex-shrink-0"
              style="width: 50px; height: 50px; min-width: 50px; min-height: 50px;">
              <i class="bi bi-clock-history fs-4"></i>
            </div>
            <div>
              <h6 class="fw-bold mb-1 text-primary">Cek Riwayat Laporan</h6>
              <p class="text-muted small mb-0">Lihat status konfirmasi Owner</p>
            </div>
            <i class="bi bi-chevron-right ms-auto text-muted"></i>
          </div>
        </div>

        <div class="card shadow-sm border-0 mb-3" onclick="handleLogout()" style="cursor: pointer;">
          <div class="card-body p-3 d-flex align-items-center justify-content-center text-danger">
            <i class="bi bi-box-arrow-right me-2"></i> Keluar Aplikasi
          </div>
        </div>

      </div>

      <div id="laporan-content" style="display: none">

        <div class="progress-container">
          <div class="d-flex justify-content-between small text-muted mb-2 px-1">
            <span>1. Atur</span>
            <span>2. Isi Stok</span>
            <span>3. Kirim</span>
          </div>
          <div class="progress" style="height: 8px;">
            <div class="progress-bar transition-all" role="progressbar" style="width: 33%;" id="report-progress"></div>
          </div>
        </div>

        <div class="card step-card">
          <div class="card-body p-4">
            <h5 class="card-title fw-bold text-primary mb-3"><i class="bi bi-box-seam-fill me-2"></i>Langkah 1: Atur
              Produk</h5>
            <p class="text-muted small mb-3">Pilih produk apa saja yang dijual hari ini beserta stok awalnya.</p>
            <div class="d-flex gap-2">
              <button class="btn btn-primary flex-grow-1" onclick="openAturProdukModal()">
                <i class="bi bi-plus-lg me-2"></i> Atur Produk
              </button>
              <button class="btn btn-outline-secondary" onclick="showPage('history-laporan-page')">
                <i class="bi bi-clock-history"></i> History
              </button>
            </div>
          </div>
        </div>

        <div class="card step-card">
          <div class="step-header">
            <h5 class="mb-0 text-success fw-bold"><i class="bi bi-pencil-square me-2"></i>Langkah 2: Isi Stok Akhir</h5>
          </div>
          <div class="card-body p-3">
            <div id="product-search-container" class="mb-3" style="display: none;">
              <input type="text" id="main-report-search-input" class="form-control" placeholder="Cari nama produk...">
            </div>

            <div id="report-tables-container">
              <div id="initial-prompt" class="text-center text-muted p-4 border rounded bg-light">
                <i class="bi bi-table" style="font-size: 2rem;"></i>
                <p class="mt-2 mb-0 small">Tabel produk akan muncul di sini setelah Anda menyelesaikan Langkah 1.</p>
              </div>
            </div>

            <div id="report-summary-container" style="display: none;">
              <div id="summary-placeholder"></div>
              <div id="summary-content">
                <span id="summary-total-terjual"></span>
                <span id="summary-total-pendapatan"></span>
                <span id="summary-total-biaya"></span>
                <span id="summary-total-keuntungan"></span>
              </div>
            </div>
          </div>
        </div>

        <div class="card step-card">
          <div class="step-header">
            <h5 class="mb-0 text-info fw-bold"><i class="bi bi-send-check-fill me-2"></i>Langkah 3: Ringkasan & Kirim
            </h5>
          </div>
          <div class="card-body p-4">
            <h6 class="fw-bold mb-3"><i class="bi bi-cash-coin me-2"></i>Input Penjualan Manual</h6>

            <div class="mb-2">
              <label class="form-label small text-muted mb-1">Total QRIS</label>
              <div class="input-group">
                <span class="input-group-text bg-white">Rp</span>
                <input type="text" class="form-control rekap-input" id="rekap-qris" placeholder="0"
                  inputmode="numeric" />
              </div>
            </div>

            <div class="mb-2">
              <label class="form-label small text-muted mb-1">Total Transfer (BCA)</label>
              <div class="input-group">
                <span class="input-group-text bg-white">Rp</span>
                <input type="text" class="form-control rekap-input" id="rekap-bca" placeholder="0"
                  inputmode="numeric" />
              </div>
            </div>

            <div class="mb-4">
              <label class="form-label small text-muted mb-1">Total Uang Tunai (CASH)</label>
              <div class="input-group">
                <span class="input-group-text bg-white">Rp</span>
                <input type="text" class="form-control rekap-input" id="rekap-cash" placeholder="0"
                  inputmode="numeric" />
              </div>
            </div>

            <hr class="border-secondary opacity-25">

            <h6 class="fw-bold mb-3"><i class="bi bi-calculator me-2"></i>Konfirmasi Total</h6>
            <div class="bg-light p-3 rounded mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-muted small">Total (Sistem):</span>
                <strong id="total-sistem" class="text-dark">Rp 0</strong>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted small">Total (Input Manual):</span>
                <strong id="total-manual" class="text-primary fs-5">Rp 0</strong>
              </div>
            </div>

            <div id="reconciliation-warning" class="alert alert-danger p-2 text-center small mb-3"
              style="display: none;">
              <i class="bi bi-exclamation-triangle-fill me-1"></i> Total manual & sistem tidak sesuai!
            </div>

            <div class="d-grid">
              <button id="kirim-laporan-btn" class="btn btn-secondary btn-lg py-3" disabled>
                <i class="bi bi-lock-fill me-2"></i> Lengkapi Data Dulu
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="history-laporan-page" class="page container py-4">
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <button class="btn btn-light me-3" onclick="showPage('lapak-dashboard')">
          <i class="bi bi-arrow-left"></i>
        </button>
        <h4 class="mb-0">History Laporan</h4>
      </header>
      <div id="history-loading" class="text-center p-5">
        <div class="spinner-border text-primary"></div>
      </div>
      <div id="history-list" class="list-group"></div>
    </div>
  </main>

  <div id="rekap-footer" class="sticky-footer footer-hidden" style="display: none">
    <div id="footer-handle" class="text-center p-1 bg-light border-bottom" style="cursor: pointer;">
      <i id="footer-toggle-icon" class="bi bi-chevron-down" style="font-size: 1.2rem;"></i>
    </div>

    <div id="footer-content">
      <div class="p-3 border-bottom">
        <h6><i class="bi bi-cash-stack"></i> Input Hasil Penjualan</h6>
        <div class="input-group input-group-sm mb-2">
          <span class="input-group-text" style="width: 60px">QRIS</span>
          <span class="input-group-text">Rp</span>
          <input type="text" class="form-control rekap-input" id="rekap-qris" placeholder="0" inputmode="numeric" />
        </div>
        <div class="input-group input-group-sm mb-2">
          <span class="input-group-text" style="width: 60px">BCA</span>
          <span class="input-group-text">Rp</span>
          <input type="text" class="form-control rekap-input" id="rekap-bca" placeholder="0" inputmode="numeric" />
        </div>
        <div class="input-group input-group-sm">
          <span class="input-group-text" style="width: 60px">CASH</span>
          <span class="input-group-text">Rp</span>
          <input type="text" class="form-control rekap-input" id="rekap-cash" placeholder="0" inputmode="numeric" />
        </div>
      </div>

      <div class="p-3 bg-light">
        <div class="row g-3 align-items-center">
          <div class="col-md-8">
            <div class="d-flex justify-content-between">
              <span>Total (dari Tabel):</span>
              <strong id="total-sistem">Rp NaN</strong>
            </div>
            <div class="d-flex justify-content-between">
              <span>Total (dari Input):</span>
              <strong id="total-manual">Rp 0</strong>
            </div>
            <div id="reconciliation-warning" class="alert alert-danger p-2 text-center small mt-2"
              style="display: none">
              <i class="bi bi-exclamation-triangle-fill"></i> Total tidak sesuai! Cek kembali.
            </div>
          </div>
          <div class="col-md-4 d-grid">
            <button id="kirim-laporan-btn" class="btn btn-primary btn-lg">
              <i class="bi bi-send-fill"></i> Kirim Laporan
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main id="supplier-pages">
    <div id="supplier-dashboard" class="page container py-4">
      <header class="d-flex justify-content-between align-items-center pb-3 mb-4 border-bottom">
        <div>
          <h4 class="mb-0">Halo, <span id="supplier-name">Supplier</span></h4>
          <p class="text-muted mb-0 small" id="current-date-supplier">Memuat tanggal...</p>
        </div>
        <button class="btn btn-outline-danger btn-sm" onclick="handleLogout()">
          <i class="bi bi-box-arrow-right"></i>
        </button>
      </header>

      <div class="row row-cols-2 g-3 mb-4">
        <div class="col">
          <div class="card bg-primary text-white shadow-sm h-100 clickable-card" onclick="showSupplierBillDetails()">
            <div class="card-body p-3">
              <h6 class="card-title small">
                <i class="bi bi-wallet2"></i> Total Tagihan
                <i class="bi bi-chevron-right float-end" style="font-size: 0.8rem;"></i>
              </h6>
              <h4 id="supplier-total-tagihan" class="fw-bold">Rp 0</h4>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card text-bg-success shadow-sm h-100">
            <div class="card-body p-3">
              <h6 class="card-title small"><i class="bi bi-cart-check-fill"></i> Penjualan (Bln)</h6>
              <h4 id="supplier-penjualan-bulan-ini" class="fw-bold">Rp 0</h4>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0"><i class="bi bi-broadcast-pin text-danger me-2"></i> Monitor Stok</h5>
        <button class="btn btn-sm btn-outline-secondary" onclick="populateNotifications()">
          <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
      </div>

      <div id="notification-list-container" class="list-group notification-list-scroll shadow-sm">
        <div class="list-group-item text-center p-4">
          <div class="spinner-border spinner-border-sm"></div>
          <p class="mb-0 mt-2 text-muted">Memuat feed...</p>
        </div>
      </div>
    </div>
    <div id="supplier-history-page" class="page container py-4">
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <button class="btn btn-light me-3" onclick="showPage('supplier-dashboard')">
          <i class="bi bi-arrow-left"></i>
        </button>
        <h4 class="mb-0">Riwayat & Laporan</h4>
      </header>
      <div class="row g-3 mb-4 align-items-end p-3 bg-light border rounded">
        <div class="col-md-4">
          <label for="supplier-history-lapak-filter" class="form-label">Filter per Lapak</label>
          <select id="supplier-history-lapak-filter" class="form-select">
            <option value="">Semua Lapak</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="supplier-history-start-date" class="form-label">Tanggal Mulai</label>
          <input type="date" id="supplier-history-start-date" class="form-control" />
        </div>
        <div class="col-md-3">
          <label for="supplier-history-end-date" class="form-label">Tanggal Akhir</label>
          <input type="date" id="supplier-history-end-date" class="form-control" />
        </div>
        <div class="col-md-2 d-grid">
          <button id="supplier-history-filter-btn" class="btn btn-primary">
            <i class="bi bi-funnel-fill"></i> Terapkan
          </button>
        </div>
      </div>
      <div id="supplier-history-loading" class="text-center p-5">
        <div class="spinner-border text-primary"></div>
      </div>
      <div id="supplier-history-content" style="display: none">
        <div class="row">
          <div class="col-lg-8">
            <h5 class="mb-3">Riwayat Penjualan Produk Anda</h5>
            <div class="table-responsive">
              <table class="table table-striped table-sm">
                <thead class="table-light">
                  <tr>
                    <th>Tanggal</th>
                    <th>Lapak</th>
                    <th>Produk</th>
                    <th>Terjual</th>
                  </tr>
                </thead>
                <tbody id="supplier-sales-history-body"></tbody>
              </table>
            </div>
          </div>
          <div class="col-lg-4">
            <h5 class="mb-3">Riwayat Pembayaran Diterima</h5>
            <div class="table-responsive">
              <table class="table table-striped table-sm">
                <thead class="table-light">
                  <tr>
                    <th>Tanggal</th>
                    <th>Jumlah</th>
                    <th>Metode</th>
                  </tr>
                </thead>
                <tbody id="supplier-payment-history-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="supplier-notification-history-page" class="page container py-4">
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <button class="btn btn-light me-3" onclick="showPage('supplier-dashboard')">
          <i class="bi bi-arrow-left"></i>
        </button>
        <h4 class="mb-0">Riwayat Notifikasi Terarsip</h4>
      </header>
      <div id="archived-notification-list-container" class="list-group">
        <div class="list-group-item text-center p-4">
          <div class="spinner-border spinner-border-sm"></div>
        </div>
      </div>
    </div>
  </main>

  <main id="superowner-pages" style="display: none;">
    <div id="superowner-dashboard" class="page container py-4">
      <header class="pb-3 mb-4 border-bottom d-flex justify-content-between align-items-center">
        <div>
          <h4 class="mb-0">Selamat Datang, SuperOwner</h4>
          <p class="text-muted mb-0 small" id="current-date-superowner">Memuat tanggal...</p>
        </div>
        <button class="btn btn-outline-danger btn-sm" onclick="handleLogout()">
          <i class="bi bi-box-arrow-right"></i>
        </button>
      </header>

      <div id="superowner-loading" class="text-center p-5">
        <div class="spinner-border text-primary"></div>
        <p class="mt-2 text-muted">Memuat data...</p>
      </div>

      <div id="superowner-content" style="display: none;">
        <div class="row row-cols-2 g-3 mb-4">
          <div class="col">
            <div class="card kpi-card-simple text-center p-3 h-100">
              <h6 class="card-title small text-muted">Total Saldo Profit</h6>
              <h4 class="mb-0 text-primary" id="superowner-total-saldo">Rp 0</h4>
            </div>
          </div>
          <div class="col">
            <div class="card kpi-card-simple text-center p-3 h-100">
              <h6 class="card-title small text-muted">Profit Bulan Ini</h6>
              <h4 class="mb-0 text-success" id="superowner-profit-bulan-ini">Rp 0</h4>
            </div>
          </div>
          <div class="col">
            <div class="card kpi-card-simple text-center p-3 h-100">
              <h6 class="card-title small text-muted">Owner Terdaftar</h6>
              <h4 class="mb-0" id="superowner-total-owner">0</h4>
            </div>
          </div>
          <div class="col">
            <div class="card kpi-card-simple text-center p-3 h-100">
              <h6 class="card-title small text-muted">Owner Terprofit</h6>
              <h4 class="mb-0 small fw-bold text-truncate" id="superowner-owner-terprofit">-</h4>
            </div>
          </div>
        </div>

        <h5 class="mb-3">Rincian Saldo Profit per Owner</h5>

        <div id="superowner-owner-list-container" class="list-group mb-5">
        </div>

        <div style="height: 20px;"></div>
      </div>
    </div>
    <div id="superowner-profit-detail-page" class="page container py-4" style="display: none;">
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <button class="btn btn-light me-3" onclick="showPage('superowner-dashboard')">
          <i class="bi bi-arrow-left"></i>
        </button>
        <div>
          <h4 class="mb-0">Detail Profit dari <span id="detail-owner-name"></span></h4>
          <p class="text-muted mb-0 small">Riwayat transaksi profit yang diterima</p>
        </div>
      </header>

      <div id="profit-detail-loading" class="text-center p-5">
        <div class="spinner-border text-primary"></div>
      </div>

      <div id="profit-detail-content" class="table-responsive" style="display: none;">
        <table class="table table-striped table-hover">
          <thead class="table-light">
            <tr>
              <th>Tanggal Transaksi</th>
              <th>Sumber Profit</th>
              <th class="text-end">Profit Diperoleh</th>
              <th class="text-center">Aksi</th>
            </tr>
          </thead>
          <tbody id="profit-detail-table-body">
          </tbody>
        </table>
      </div>
    </div>
    <div id="superowner-manage-reports-page" class="page container py-4" style="display: none;">
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <button class="btn btn-light me-3" onclick="showPage('superowner-dashboard')">
          <i class="bi bi-arrow-left"></i>
        </button>
        <h4 class="mb-0">Manajemen Laporan Profit dari Owner</h4>
      </header>
      <div class="row g-3 mb-4 align-items-end p-3 bg-light border rounded">
        <div class="col-md-5">
          <label for="so-report-start-date" class="form-label">Tanggal Mulai</label>
          <input type="date" id="so-report-start-date" class="form-control">
        </div>
        <div class="col-md-5">
          <label for="so-report-end-date" class="form-label">Tanggal Akhir</label>
          <input type="date" id="so-report-end-date" class="form-control">
        </div>
        <div class="col-md-2 d-grid">
          <button id="so-report-filter-btn" class="btn btn-primary">
            <i class="bi bi-funnel-fill"></i> Terapkan
          </button>
        </div>
      </div>
      <div id="superowner-reports-loading" class="text-center p-5">
        <div class="spinner-border"></div>
      </div>

      <div id="superowner-reports-content" div class="accordion" id="superowner-reports-content" style="display: none;">
      </div>
    </div>
    <div id="superowner-transactions-page" class="page container py-4" style="display: none;">
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <button class="btn btn-light me-3" onclick="showPage('superowner-dashboard')">
          <i class="bi bi-arrow-left"></i>
        </button>
        <h4 class="mb-0">Riwayat Transaksi (Profit Masuk & Penarikan)</h4>
      </header>

      <div class="p-3 bg-light border rounded mb-4">
        <div class="row g-3 align-items-end">
          <div class="col-md-9">
            <label class="form-label">Navigasi Transaksi Harian</label>
            <div class="btn-group w-100">
              <button class="btn btn-outline-secondary" type="button" id="so-tx-prev-day"><i
                  class="bi bi-chevron-left"></i></button>
              <input type="date" id="so-tx-daily-date" class="form-control text-center" style="min-width: 150px;">
              <button class="btn btn-outline-secondary" type="button" id="so-tx-next-day"><i
                  class="bi bi-chevron-right"></i></button>
            </div>
          </div>
          <div class="col-md-3 d-grid">
            <button class="btn btn-outline-info" data.bs.toggle="collapse" data.bs.target="#so-advanced-tx-filter">
              <i class="bi bi-sliders"></i> Filter Canggih
            </button>
          </div>
        </div>
        <div class="collapse mt-3" id="so-advanced-tx-filter">
          <div class="row g-3 align-items-end p-3 border rounded bg-white">
            <div class="col-md-5">
              <label for="so-tx-start-date" class="form-label">Tanggal Mulai</label>
              <input type="date" id="so-tx-start-date" class="form-control">
            </div>
            <div class="col-md-5">
              <label for="so-tx-end-date" class="form-label">Tanggal Akhir</label>
              <input type="date" id="so-tx-end-date" class="form-control">
            </div>
            <div class="col-md-2 d-grid">
              <button id="so-tx-filter-btn" class="btn btn-primary">
                <i class="bi bi-funnel-fill"></i> Terapkan
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="so-tx-loading" class="text-center p-5">
        <div class="spinner-border"></div>
      </div>
      <div id="so-tx-content" class="table-responsive" style="display: none;">
        <table class="table table-striped table-hover">
          <thead class="table-light">
            <tr>
              <th>Tanggal</th>
              <th>Keterangan</th>
              <th>Tipe</th>
              <th class="text-end">Jumlah</th>
            </tr>
          </thead>
          <tbody id="so-tx-table-body"></tbody>
        </table>
      </div>
    </div>
    <div id="superowner-manage-owners-page" class="page container py-4" style="display: none;">
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <button class="btn btn-light me-3" onclick="showPage('superowner-dashboard')">
          <i class="bi bi-arrow-left"></i>
        </button>
        <h4 class="mb-0">Manajemen Owner</h4>
      </header>
      <div class="d-grid mb-3">
        <button class="btn btn-primary" onclick="openSuperownerEditOwnerModal(null)">
          <i class="bi bi-plus-circle-fill"></i> Tambah Owner Baru
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Nama Lengkap</th>
              <th>Username</th>
              <th>Email</th>
              <th>Kontak</th>
              <th>Password</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="superowner-owners-table-body">
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <div class="modal fade" id="atur-produk-modal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Atur Produk untuk Laporan Hari Ini</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-4 border-end">
              <h6>Pilih Supplier</h6>
              <div id="supplier-selection-container" class="list-group"></div>
            </div>
            <div class="col-md-8">
              <div id="product-area-title">
                <p class="text-muted pt-3">Pilih satu supplier untuk melihat & menambah produk.</p>
              </div>

              <div id="add-product-form-container" class="p-3 mb-3 border rounded bg-light" style="display: none;">
                <h6>Tambah Produk Baru</h6>
                <form id="add-product-to-supplier-form">
                  <div class="row g-2">
                    <div class="col-md-4"> <input type="text" id="new-product-name-input" class="form-control"
                        placeholder="Nama produk..." required>
                    </div>
                    <div class="col-md-3">
                      <input type="number" id="new-product-buy-price-input" class="form-control" placeholder="Beli (Rp)"
                        required>
                    </div>
                    <div class="col-md-3">
                      <input type="number" id="new-product-price-input" class="form-control" placeholder="Jual (Rp)"
                        required>
                    </div>
                    <div class="col-md-2 d-grid">
                      <button class="btn btn-primary" type="submit">Simpan</button>
                    </div>
                  </div>
                </form>
              </div>

              <div id="product-selection-area" style="display: none;">
                <h6>Pilih Produk & Isi Stok Awal</h6>

                <div class="mb-3">
                  <input type="text" id="modal-product-search-input" class="form-control"
                    placeholder="Cari produk di sini...">
                </div>

                <div id="product-selection-container" style="max-height: 300px; overflow-y: auto;">
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-primary" onclick="generateReportTables()">Terapkan ke Tabel</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="edit-admin-modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="admin-modal-title"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="edit-admin-form">
          <input type="hidden" id="edit-admin-id" />
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Nama Lengkap</label><input type="text" class="form-control" id="edit-admin-nama"
                required />
            </div>
            <div class="mb-3">
              <label class="form-label">Username</label><input type="text" class="form-control" id="edit-admin-username"
                required />
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label><input type="email" class="form-control" id="edit-admin-email"
                required />
            </div>
            <div class="mb-3">
              <label class="form-label">Nomor Kontak</label><input type="tel" class="form-control"
                id="edit-admin-kontak" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <div class="input-group">
                <input type="password" class="form-control" id="edit-admin-password" /><button
                  class="btn btn-outline-secondary" type="button"
                  onclick="togglePasswordVisibility(this, 'edit-admin-password')">
                  <i class="bi bi-eye-slash"></i>
                </button>
              </div>
              <small class="form-text text-muted"></small>
            </div>
            <div class="mb-3">
              <label class="form-label">Konfirmasi Password</label>
              <div class="input-group">
                <input type="password" class="form-control" id="edit-admin-password-confirm" /><button
                  class="btn btn-outline-secondary" type="button"
                  onclick="togglePasswordVisibility(this, 'edit-admin-password-confirm')">
                  <i class="bi bi-eye-slash"></i>
                </button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Batal</button><button type="submit" class="btn btn-primary">Simpan</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal fade" id="edit-lapak-modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="lapak-modal-title"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="edit-lapak-form">
          <input type="hidden" id="edit-lapak-id" />
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Lokasi Lapak</label><input type="text" class="form-control"
                id="edit-lapak-lokasi" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Penanggung Jawab (Wajib)</label><select class="form-select" id="lapak-pj-select"
                required></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Anggota (Opsional)</label>
              <div id="lapak-anggota-selection"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Batal</button><button type="submit" class="btn btn-primary">Simpan</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal fade" id="edit-supplier-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="supplier-modal-title"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="edit-supplier-form">
          <input type="hidden" id="edit-supplier-id" />
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nama Supplier</label><input type="text" id="edit-supplier-nama"
                  class="form-control" required />
              </div>
              <div class="col-md-6">
                <label class="form-label">Username</label><input type="text" id="edit-supplier-username"
                  class="form-control" required />
              </div>
              <div class="col-md-6">
                <label class="form-label">Kontak</label><input type="tel" id="edit-supplier-kontak" class="form-control"
                  required />
              </div>
              <div class="col-md-6">
                <label class="form-label">Nomor Register</label><input type="text" id="edit-supplier-register"
                  class="form-control" readonly />
              </div>
              <div class="col-md-6">
                <label class="form-label">Metode Pembayaran</label><select id="edit-supplier-metode" class="form-select"
                  required>
                  <option value="" selected disabled>
                    -- Pilih Jenis --
                  </option>
                  <option value="DANA">DANA</option>
                  <option value="BCA">BCA</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Nomor Rekening / DANA</label><input type="text" id="edit-supplier-rekening"
                  class="form-control" required />
              </div>
              <div class="col-12">
                <label class="form-label">Alamat</label><textarea class="form-control" id="edit-supplier-alamat"
                  rows="2"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">Password</label>
                <div class="input-group">
                  <input type="password" id="edit-supplier-password" class="form-control" /><button
                    class="btn btn-outline-secondary" type="button"
                    onclick="togglePasswordVisibility(this, 'edit-supplier-password')">
                    <i class="bi bi-eye-slash"></i>
                  </button>
                </div>
                <small class="form-text text-muted"></small>
              </div>
              <div class="col-md-6">
                <label class="form-label">Konfirmasi Password</label>
                <div class="input-group">
                  <input type="password" class="form-control" id="edit-supplier-password-confirm" /><button
                    class="btn btn-outline-secondary" type="button"
                    onclick="togglePasswordVisibility(this, 'edit-supplier-password-confirm')">
                    <i class="bi bi-eye-slash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Batal</button><button type="submit" class="btn btn-primary">Simpan</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal fade" id="supplier-bill-detail-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Rincian Tagihan Belum Dibayar</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <div id="supplier-bill-loading" class="text-center p-4">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2 small text-muted">Mengambil data tagihan...</p>
          </div>

          <div id="supplier-bill-content" style="display: none;">
            <table class="table table-striped table-hover mb-0 align-middle">
              <thead class="table-light sticky-top">
                <tr>
                  <th class="ps-3">Tanggal & Lapak</th>
                  <th class="text-end pe-3">Nominal</th>
                </tr>
              </thead>
              <tbody id="supplier-bill-table-body">
              </tbody>
              <tfoot class="table-light">
                <tr>
                  <td class="text-end fw-bold">Total</td>
                  <td class="text-end fw-bold pe-3" id="modal-total-bill">Rp 0</td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div id="supplier-bill-empty" class="text-center p-5" style="display: none;">
            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
            <p class="mt-3">Tidak ada tagihan tertunggak.</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="payment-confirmation-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Konfirmasi & Bayar Tagihan</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="payment-confirmation-form">
          <input type="hidden" id="payment-supplier-id" /><input type="hidden" id="payment-supplier-amount" />
          <div class="modal-body">
            <div class="row">
              <div class="col-md-5 border-end">
                <label class="small text-muted">Kepada Supplier:</label>
                <h5 id="payment-supplier-name-confirm" class="mb-3"></h5>

                <label class="small text-muted">Total Tagihan Saat Ini:</label>
                <h3 class="text-success fw-bold" id="payment-amount-confirm"></h3>

                <div class="alert alert-warning mt-3 small">
                  <i class="bi bi-bank"></i> Rekening: <strong id="payment-method-info"></strong>
                </div>
              </div>

              <div class="col-md-7">
                <h6 class="border-bottom pb-2"><i class="bi bi-calendar3"></i> Akumulasi Tagihan Harian</h6>
                <div id="payment-modal-breakdown" class="pe-2" style="max-height: 250px; overflow-y: auto;">
                  <div class="text-center text-muted small mt-4">Memuat rincian...</div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="submit" class="btn btn-success">Konfirmasi Transfer</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal fade" id="report-detail-modal" tabindex="-1" aria-labelledby="reportDetailModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reportDetailModalLabel">
            Detail Laporan Harian
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="invoice-content" class="invoice-box"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Tutup
          </button>
          <button type="button" class="btn btn-primary" onclick="downloadReportAsPDF()">
            <i class="bi bi-download"></i> Download PDF
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="superowner-withdraw-modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Konfirmasi Penarikan Saldo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="withdraw-owner-id" />
          <p>Anda akan menandai saldo dari owner berikut sebagai lunas (di-nol-kan):</p>
          <h5><strong id="withdraw-owner-name-confirm" class="text-primary">Nama Owner</strong></h5>
          <div class="alert alert-info">
            Total Saldo: <strong id="withdraw-amount-confirm">Rp 0</strong>
          </div>
          <p class="text-muted small">Tindakan ini akan mencatat transaksi penarikan dan me-reset saldo owner ini
            menjadi nol. Lanjutkan?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-success" onclick="handleSuperownerWithdrawForOwner()">
            Konfirmasi Penarikan
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="superowner-edit-owner-modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="superowner-owner-modal-title"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="superowner-edit-owner-form">
          <input type="hidden" id="superowner-edit-owner-id" />
          <div class="modal-body">
            <div class="mb-3"><label class="form-label">Nama Lengkap</label><input type="text" class="form-control"
                id="superowner-edit-owner-nama" required /></div>
            <div class="mb-3"><label class="form-label">Username</label><input type="text" class="form-control"
                id="superowner-edit-owner-username" required /></div>
            <div class="mb-3"><label class="form-label">Email</label><input type="email" class="form-control"
                id="superowner-edit-owner-email" required /></div>
            <div class="mb-3"><label class="form-label">Nomor Kontak</label><input type="tel" class="form-control"
                id="superowner-edit-owner-kontak" required /></div>
            <div class="mb-3"><label class="form-label">Password</label>
              <div class="input-group"><input type="password" class="form-control"
                  id="superowner-edit-owner-password" /><button class="btn btn-outline-secondary" type="button"
                  onclick="togglePasswordVisibility(this, 'superowner-edit-owner-password')"><i
                    class="bi bi-eye-slash"></i></button></div><small class="form-text text-muted"></small>
            </div>
            <div class="mb-3"><label class="form-label">Konfirmasi Password</label>
              <div class="input-group"><input type="password" class="form-control"
                  id="superowner-edit-owner-password-confirm" /><button class="btn btn-outline-secondary" type="button"
                  onclick="togglePasswordVisibility(this, 'superowner-edit-owner-password-confirm')"><i
                    class="bi bi-eye-slash"></i></button></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="submit" class="btn btn-primary">Simpan</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal fade" id="bill-detail-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Rincian Tagihan Berjalan</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <h6 id="detail-supplier-name" class="text-primary mb-3"></h6>
          <div id="bill-breakdown-container">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
          <button type="button" class="btn btn-primary" id="btn-pay-from-detail">Bayar Sekarang</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="edit-product-modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Produk</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="edit-product-form">
          <input type="hidden" id="edit-product-id">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Nama Produk</label>
              <input type="text" id="edit-product-name" class="form-control" required>
            </div>
            <div class="row">
              <div class="col-6 mb-3">
                <label class="form-label">Harga Beli (Modal)</label>
                <input type="number" id="edit-product-buy-price" class="form-control" required>
              </div>
              <div class="col-6 mb-3">
                <label class="form-label">Harga Jual</label>
                <input type="number" id="edit-product-sell-price" class="form-control" required>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <nav id="superowner-bottom-nav" class="bottom-nav justify-content-around" style="display: none;">
    <button class="bottom-nav-link active" onclick="showPageAndNav('superowner-dashboard', this)">
      <i class="bi bi-grid-fill"></i>
      <span>Dashboard</span>
    </button>
    <button class="bottom-nav-link" onclick="showPageAndNav('superowner-manage-owners-page', this)">
      <i class="bi bi-person-plus-fill"></i>
      <span>Owners</span>
    </button>
    <button class="bottom-nav-link" onclick="showPageAndNav('superowner-manage-reports-page', this)">
      <i class="bi bi-file-earmark-medical-fill"></i>
      <span>Laporan</span>
    </button>
    <button class="bottom-nav-link" onclick="showPageAndNav('superowner-transactions-page', this)">
      <i class="bi bi-arrow-down-up"></i>
      <span>Transaksi</span>
    </button>
  </nav>
  <nav id="owner-bottom-nav" class="bottom-nav justify-content-around" style="display: none;">
    <button class="bottom-nav-link" id="nav-btn-dashboard" onclick="showPage('owner-dashboard')">
      <i class="bi bi-grid-fill"></i>
      <span>Home</span>
    </button>
    <button class="bottom-nav-link" id="nav-btn-bayar" onclick="showPage('owner-pembayaran-page')">
      <i class="bi bi-credit-card-2-front-fill"></i>
      <span>Pembayaran</span>
    </button>
    <button class="bottom-nav-link" id="nav-btn-verif" onclick="showPage('owner-verification-center-page')">
      <i class="bi bi-shield-check"></i>
      <span>Verifikasi</span>
    </button>
  </nav>

  <nav id="supplier-bottom-nav" class="bottom-nav justify-content-around" style="display: none;">

    <button class="bottom-nav-link active position-relative" onclick="showPageAndNav('supplier-dashboard', this)">
      <i class="bi bi-house-door-fill"></i>
      <span>Beranda</span>

      <span id="notification-badge"
        class="position-absolute top-0 start-50 translate-middle badge rounded-pill bg-danger"
        style="display: none; font-size: 0.6rem; margin-top: 5px; margin-left: 10px;">
        0
      </span>
    </button>

    <button class="bottom-nav-link" onclick="showPageAndNav('supplier-notification-history-page', this)">
      <i class="bi bi-archive-fill"></i>
      <span>Arsip Stok</span>
    </button>
    <button class="bottom-nav-link" onclick="showPageAndNav('supplier-history-page', this)">
      <i class="bi bi-clock-history"></i>
      <span>Riwayat</span>
    </button>
    <button class="bottom-nav-link" onclick="alert('Fitur Info Profil akan segera hadir!')">
      <i class="bi bi-person-circle"></i>
      <span>Info</span>
    </button>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const { jsPDF } = window.jspdf;
    // --- GLOBAL STATE & MODAL INSTANCES ---
    let AppState = {
      currentUser: null,
      ownerData: {},
      // Ganti 'catatanData' dan 'lapakSuppliers' dengan 'masterData' yang lebih komprehensif
      masterData: {
        suppliers: [],
        products: []
      },
    };
    let pendapatanChartInstance = null;
    let biayaChartInstance = null;
    let modals = {};
    let superownerChartInstance = null;

    // --- HELPER & CORE FUNCTIONS ---
    // Fungsi helper untuk navigasi bawah Superowner
    function showPageAndNav(pageId, btnElement) {
      // 1. Panggil fungsi showPage utama
      showPage(pageId);

      // 2. Update status aktif pada tombol navigasi
      if (btnElement) {
        document.querySelectorAll('.bottom-nav-link').forEach(el => el.classList.remove('active'));
        btnElement.classList.add('active');
      }
    }

    function formatCurrency(value) {
      return `Rp ${new Intl.NumberFormat("id-ID").format(value)}`;
    }
    function formatNumberInput(e) {
      let input = e.target;
      // 1. Ambil nilai input dan hapus semua karakter selain angka
      let value = input.value.replace(/\D/g, '');

      // 2. Jika nilainya kosong, biarkan kosong
      if (value === "") {
        input.value = "";
        return;
      }

      // 3. Ubah menjadi angka, lalu format dengan pemisah ribuan (titik)
      let formattedValue = new Intl.NumberFormat('id-ID').format(value);

      // 4. Setel kembali nilai input dengan yang sudah diformat
      input.value = formattedValue;
    }
    // --- HELPER & CORE FUNCTIONS ---

    function manageFooterVisibility() {
      const footer = document.getElementById('rekap-footer');
      const handle = document.getElementById('footer-handle');
      const icon = document.getElementById('footer-toggle-icon');

      // --- BARIS DIAGNOSTIK ---
      // Kita cek dulu apakah elemennya ditemukan
      if (!handle) {
        console.error("DEBUG: Elemen #footer-handle TIDAK DITEMUKAN!");
        return;
      }
      console.log("DEBUG: Elemen #footer-handle ditemukan, event listener dipasang.");
      // --- AKHIR BARIS DIAGNOSTIK ---

      handle.onclick = function () {
        // --- BARIS DIAGNOSTIK ---
        console.log("DEBUG: Footer handle DIKLIK!");
        // --- AKHIR BARIS DIAGNOSTIK ---

        footer.classList.toggle('footer-hidden');

        if (footer.classList.contains('footer-hidden')) {
          icon.classList.remove('bi-chevron-down');
          icon.classList.add('bi-chevron-up');
        } else {
          icon.classList.remove('bi-chevron-up');
          icon.classList.add('bi-chevron-down');
        }
      };
    }

    function updateDate() {
      const today = new Date().toLocaleDateString("id-ID", {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
      });
      [
        "current-date-lapak",
        "current-date-owner",
        "current-date-supplier",
      ].forEach((id) => {
        if (document.getElementById(id))
          document.getElementById(id).textContent = today;
      });
    }
    function showToast(message, isSuccess = true) {
      const toastEl = document.getElementById("liveToast");
      if (!toastEl) return;
      const toast = bootstrap.Toast.getOrCreateInstance(toastEl);
      document.getElementById("toast-body").textContent = message;
      toastEl.className = `toast ${isSuccess ? "bg-success" : "bg-danger"
        } text-white`;
      document.getElementById("toast-icon").className = `bi ${isSuccess ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill"
        } me-2`;
      document.getElementById("toast-title").textContent = isSuccess
        ? "Sukses"
        : "Gagal";
      toast.show();
    }
    function togglePasswordVisibility(button, fieldId) {
      const field = document.getElementById(fieldId);
      const icon = button.querySelector("i");
      if (field.type === "password") {
        field.type = "text";
        icon.classList.replace("bi-eye-slash", "bi-eye");
      } else {
        field.type = "password";
        icon.classList.replace("bi-eye", "bi-eye-slash");
      }
    }
    function toggleTablePasswordVisibility(icon) {
      const passSpan = icon.closest("td").querySelector(".password-text");
      if (passSpan.textContent.includes("")) {
        passSpan.textContent = passSpan.dataset.password;
        icon.classList.replace("bi-eye-slash", "bi-eye");
      } else {
        passSpan.textContent = "";
        icon.classList.replace("bi-eye", "bi-eye-slash");
      }
    }

    // --- LOGIN, ROUTING & PAGE MANAGEMENT ---
    async function showPage(pageId) {
      document.querySelectorAll(".page").forEach((e) => (e.style.display = "none"));

      const activePage = document.getElementById(pageId);
      if (activePage) {
        activePage.style.display = "block";
        if (pageId === "login-page") activePage.style.display = "flex";

        // === LOGIKA BARU: AUTO UPDATE NAVBAR HIGHLIGHT ===
        // Mapping: Halaman mana -> Tombol Nav ID mana
        const navMapping = {
          // Dashboard Tab
          'owner-dashboard': 'nav-btn-dashboard',
          'owner-chart-page': 'nav-btn-dashboard', // Jika masih ada sisa
          'owner-data-admin-page': 'nav-btn-dashboard', // Sub-menu tetap highlight dashboard
          'owner-data-lapak-page': 'nav-btn-dashboard',

          // Pembayaran Tab
          'owner-pembayaran-page': 'nav-btn-bayar',
          'owner-laporan-biaya-page': 'nav-btn-bayar', // Sub-menu pembayaran

          // Verifikasi Tab
          'owner-verification-center-page': 'nav-btn-verif',
          'owner-manage-reports-page': 'nav-btn-dashboard' // Anggap ini bagian verifikasi/laporan
        };

        const activeNavId = navMapping[pageId];

        // Reset semua tombol nav owner
        document.querySelectorAll('#owner-bottom-nav .bottom-nav-link').forEach(btn => btn.classList.remove('active'));

        // Set active class jika mapping ditemukan
        if (activeNavId) {
          const btn = document.getElementById(activeNavId);
          if (btn) btn.classList.add('active');
        }
        // ===============================================

        // --- LOGIKA NAVBAR DISPLAY (KODE LAMA DISESUAIKAN) ---
        const soNav = document.getElementById("superowner-bottom-nav");
        const ownerNav = document.getElementById("owner-bottom-nav");
        const supNav = document.getElementById("supplier-bottom-nav");

        if (soNav) soNav.style.display = "none";
        if (ownerNav) ownerNav.style.display = "none";
        if (supNav) supNav.style.display = "none";

        if (AppState.currentUser && pageId !== 'login-page') {
          if (AppState.currentUser.role === 'superowner') {
            if (soNav) soNav.style.display = "flex";
          } else if (AppState.currentUser.role === 'owner') {
            if (ownerNav) ownerNav.style.display = "flex";
          } else if (AppState.currentUser.role === 'supplier') {
            if (supNav) supNav.style.display = "flex";
          }
        }
        // ----------------------------------------------------


        // --- Logika Footer Lapak (Kode Lama Anda) ---
        const footerElement = document.getElementById("rekap-footer");
        if (footerElement) {
          footerElement.style.display =
            pageId === "lapak-dashboard" && AppState.currentUser?.role === "lapak"
              ? "block"
              : "none";
        }

        // --- Logika Populate Data (Kode Lama Anda) ---
        const { role } = AppState.currentUser || {};

        if (role === "owner") {
          if (pageId === "owner-dashboard") await populateOwnerDashboard();
          if (pageId.startsWith("owner-laporan")) {
            const dpPendapatan = document.getElementById("laporan-pendapatan-datepicker");
            if (dpPendapatan) dpPendapatan.dispatchEvent(new Event("change"));
            const dpBiaya = document.getElementById("laporan-biaya-datepicker");
            if (dpBiaya) dpBiaya.dispatchEvent(new Event("change"));
          }
          if (pageId === "owner-manage-reports-page") {
            const todayISO = new Date().toISOString().split("T")[0];
            document.getElementById('manage-reports-daily-date').value = todayISO;
            document.getElementById('manage-reports-start-date').value = '';
            document.getElementById('manage-reports-end-date').value = '';
            await populateManageReportsPage();
          }
          if (pageId === "owner-pembayaran-page") {
            const todayISO = new Date().toISOString().split("T")[0];
            document.getElementById('payment-history-daily-date').value = todayISO;
            document.getElementById('payment-history-start-date').value = '';
            document.getElementById('payment-history-end-date').value = '';
            await populatePembayaranPage();
          }
          if (pageId === "owner-supplier-history-page") await populateOwnerSupplierHistoryPage();
          if (pageId === "owner-chart-page") await initDashboardCharts();
          if (pageId === "owner-verification-center-page") await populateVerificationCenter();

        } else if (role === "lapak") {
          if (pageId === "lapak-dashboard") await populateLapakDashboard();
          if (pageId === "history-laporan-page") await populateHistoryLaporanPage();

        } else if (role === "supplier") {
          if (pageId === "supplier-dashboard") await populateSupplierDashboard();
          if (pageId === "supplier-history-page") await populateSupplierHistoryPage();
          if (pageId === "supplier-notification-history-page") await populateArchivedNotifications();

        } else if (role === "superowner") {
          if (pageId === "superowner-dashboard") await populateSuperownerDashboard();
          if (pageId === "superowner-profit-detail-page") await populateSuperownerProfitDetails();
          if (pageId === "superowner-manage-reports-page") await populateSuperownerReports();
          if (pageId === "superowner-transactions-page") {
            const todayISO = new Date().toISOString().split("T")[0];
            document.getElementById('so-tx-daily-date').value = todayISO;
            document.getElementById('so-tx-start-date').value = '';
            document.getElementById('so-tx-end-date').value = '';
            await populateSuperownerTransactions();
          }
          if (pageId === "superowner-manage-owners-page") await populateSuperownerManageOwners();
        }
      }
    }
    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById("username").value.trim(),
        password = document.getElementById("password").value;
      try {
        const response = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });
        const result = await response.json();
        if (response.ok && result.success) {
          localStorage.setItem("userSession", JSON.stringify(result));
          AppState.currentUser = result;
          await routeUser(result.role);
        } else {
          showToast(result.message || "Login Gagal", false);
        }
      } catch (e) {
        showToast("Terjadi kesalahan koneksi.", false);
      }
    }
    async function handleAuthRouting() {
      const session = localStorage.getItem("userSession");
      if (session) {
        AppState.currentUser = JSON.parse(session);
        await routeUser(AppState.currentUser.role);
      } else {
        showLoginPage();
      }
    }
    function showLoginPage() {
      // Pastikan ini ada di awal reset tampilan
      document.getElementById("superowner-bottom-nav").style.display = "none";
      document
        .querySelectorAll("main")
        .forEach((main) => (main.style.display = "none"));
      showPage("login-page");
    }
    async function routeUser(role) {
      const soNav = document.getElementById("superowner-bottom-nav");
      const ownerNav = document.getElementById("owner-bottom-nav");
      const supNav = document.getElementById("supplier-bottom-nav");
      if (soNav) soNav.style.display = "none";
      if (ownerNav) ownerNav.style.display = "none";
      if (supNav) supNav.style.display = "none";
      document
        .querySelectorAll("main")
        .forEach((main) => (main.style.display = "none"));
      if (role === "owner") {
        document.getElementById("owner-pages").style.display = "block";
        showPage("owner-dashboard");
        document.getElementById("owner-name").textContent =
          AppState.currentUser.user_info.nama_lengkap;
      } else if (role === "lapak") {
        document.getElementById("lapak-pages").style.display = "block";
        document.getElementById("lapak-name").textContent =
          AppState.currentUser.user_info.nama_lengkap;
        showPage("lapak-dashboard");
      } else if (role === "supplier") {
        document.getElementById("supplier-pages").style.display = "block";
        showPage("supplier-dashboard");
        document.getElementById("supplier-name").textContent =
          AppState.currentUser.user_info.nama_supplier;
      } else if (role === "superowner") {
        document.getElementById("superowner-pages").style.display = "block";
        showPage("superowner-dashboard");
        // TAMPILKAN NAVIGASI BAWAH
        document.getElementById("superowner-bottom-nav").style.display = "flex";
        // Update tanggal untuk dashboard baru
        if (document.getElementById("current-date-superowner")) {
          document.getElementById("current-date-superowner").textContent = new Date().toLocaleDateString("id-ID", {
            weekday: "long", year: "numeric", month: "long", day: "numeric",
          });
        }

      } else {
        showLoginPage();
      }
    }
    function handleLogout() {
      if (AppState.currentUser && AppState.currentUser.role === 'lapak') {
        const storageKey = `reportState_${AppState.currentUser.user_info.lapak_id}`;
        localStorage.removeItem(storageKey);
      }

      // TAMBAHKAN INI: Sembunyikan navbar superowner saat logout
      const soNav = document.getElementById("superowner-bottom-nav");
      if (soNav) soNav.style.display = "none";
      const ownerNav = document.getElementById("owner-bottom-nav");
      if (ownerNav) ownerNav.style.display = "none";

      localStorage.removeItem("userSession");
      AppState.currentUser = null;
      window.location.reload();
    }

    function changeReportDate(dayDelta) {
      const dateEl = document.getElementById('manage-reports-daily-date');
      const newDate = new Date(dateEl.value);
      newDate.setDate(newDate.getDate() + dayDelta);
      dateEl.value = newDate.toISOString().split('T')[0];
      // Otomatis tutup filter canggih & refresh
      bootstrap.Collapse.getOrCreateInstance('#advanced-reports-filter').hide();
      populateManageReportsPage();
    }

    // FUNGSI HELPER BARU 2: Untuk navigasi harian Pembayaran
    function changePaymentDate(dayDelta) {
      const dateEl = document.getElementById('payment-history-daily-date');
      const newDate = new Date(dateEl.value);
      newDate.setDate(newDate.getDate() + dayDelta);
      dateEl.value = newDate.toISOString().split('T')[0];
      // Otomatis tutup filter canggih & refresh
      bootstrap.Collapse.getOrCreateInstance('#advanced-payment-filter').hide();
      populatePaymentHistory();
    }

    // (Letakkan ini di dalam tag <script>)

    // FUNGSI HELPER BARU: Untuk navigasi harian SO Transactions
    function changeSuperownerTxDate(dayDelta) {
      const dateEl = document.getElementById('so-tx-daily-date');
      const newDate = new Date(dateEl.value);
      newDate.setDate(newDate.getDate() + dayDelta);
      dateEl.value = newDate.toISOString().split('T')[0];
      // Otomatis tutup filter canggih & refresh
      bootstrap.Collapse.getOrCreateInstance('#so-advanced-tx-filter').hide();
      populateSuperownerTransactions();
    }

    // --- OWNER FUNCTIONS ---
    async function initDashboardCharts() {
      const monthSelect = document.getElementById('chart-month-select');
      const yearSelect = document.getElementById('chart-year-select');

      // Cek jika elemen ada (untuk menghindari error di halaman lain)
      if (!monthSelect || !yearSelect) return;

      const currentMonth = new Date().getMonth() + 1;
      const currentYear = new Date().getFullYear();

      // Set default values jika belum ada value
      if (!monthSelect.value) monthSelect.value = currentMonth;

      // Isi tahun jika kosong
      if (yearSelect.options.length === 0) {
        yearSelect.innerHTML = '';
        for (let y = currentYear; y >= 2023; y--) {
          yearSelect.innerHTML += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`;
        }
      }

      // Gambar grafik
      await fetchAndDrawCharts();
    }

    async function fetchAndDrawCharts() {
      const loadingEl = document.getElementById('chart-loading');
      const contentEl = document.getElementById('chart-content');
      loadingEl.style.display = 'block';
      contentEl.style.display = 'none';

      const month = document.getElementById('chart-month-select').value;
      const year = document.getElementById('chart-year-select').value;

      try {
        const resp = await fetch(`/api/get_chart_data?month=${month}&year=${year}`);
        const result = await resp.json();
        if (!result.success) throw new Error(result.message);

        const chartOptions = {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function (value) { return formatCurrency(value); }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function (context) {
                  return context.dataset.label + ': ' + formatCurrency(context.raw);
                }
              }
            }
          }
        };

        // Hancurkan grafik lama sebelum menggambar yang baru
        if (pendapatanChartInstance) pendapatanChartInstance.destroy();
        if (biayaChartInstance) biayaChartInstance.destroy();

        // Gambar Grafik Pendapatan
        const ctxPendapatan = document.getElementById('pendapatanChart').getContext('2d');
        pendapatanChartInstance = new Chart(ctxPendapatan, {
          type: 'line',
          data: {
            labels: result.labels,
            datasets: [{
              label: 'Pendapatan',
              data: result.pendapatanData,
              borderColor: 'rgba(25, 135, 84, 1)',
              backgroundColor: 'rgba(25, 135, 84, 0.2)',
              fill: true,
              tension: 0.1
            }]
          },
          options: chartOptions
        });

        // Gambar Grafik Biaya
        const ctxBiaya = document.getElementById('biayaChart').getContext('2d');
        biayaChartInstance = new Chart(ctxBiaya, {
          type: 'line',
          data: {
            labels: result.labels,
            datasets: [{
              label: 'Biaya Supplier',
              data: result.biayaData,
              borderColor: 'rgba(220, 53, 69, 1)',
              backgroundColor: 'rgba(220, 53, 69, 0.2)',
              fill: true,
              tension: 0.1
            }]
          },
          options: chartOptions
        });

        contentEl.style.display = 'block';
      } catch (e) {
        showToast('Gagal memuat data grafik: ' + e.message, false);
      } finally {
        loadingEl.style.display = 'none';
      }
    }

    async function populateOwnerSupplierHistoryPage() {
      // Fungsi ini mengisi dropdown supplier saat halaman pertama kali dibuka
      const selectEl = document.getElementById('owner-supplier-select');
      // PERBAIKAN: Pastikan placeholder memiliki value=""
      selectEl.innerHTML = '<option selected value="">-- Pilih Supplier --</option>';

      // Kita gunakan data supplier dari AppState yang sudah ada
      if (AppState.ownerData && AppState.ownerData.supplier_data) {
        AppState.ownerData.supplier_data.forEach(s => {
          selectEl.innerHTML += `<option value="${s.id}">${s.nama_supplier}</option>`;
        });
      }
      // Sembunyikan konten & loading di awal
      document.getElementById('owner-supplier-history-content').style.display = 'none';
      document.getElementById('owner-supplier-history-loading').style.display = 'none';
    }

    async function fetchAndDisplayOwnerSupplierHistory() {
      const supplierId = document.getElementById('owner-supplier-select').value;
      // Jika belum ada supplier yang dipilih, sembunyikan konten dan jangan lakukan apa-apa
      if (!supplierId) {
        document.getElementById('owner-supplier-history-content').style.display = 'none';
        return;
      }

      const loadingEl = document.getElementById('owner-supplier-history-loading'),
        contentEl = document.getElementById('owner-supplier-history-content'),
        salesBody = document.getElementById('owner-supplier-sales-body'),
        paymentsBody = document.getElementById('owner-supplier-payment-body');

      loadingEl.style.display = 'block';
      contentEl.style.display = 'none';

      // Mengambil nilai tanggal dari input
      const startDate = document.getElementById('owner-history-start-date').value;
      const endDate = document.getElementById('owner-history-end-date').value;

      // Membangun query string
      const params = new URLSearchParams();
      if (startDate) params.append('start_date', startDate);
      if (endDate) params.append('end_date', endDate);
      const queryString = params.toString();

      try {
        const apiUrl = `/api/get_owner_supplier_history/${supplierId}?${queryString}`;
        const resp = await fetch(apiUrl);
        const result = await resp.json();
        if (!result.success) throw new Error(result.message);

        paymentsBody.innerHTML = result.payments.length === 0
          ? `<tr><td colspan="3" class="text-center text-muted">Tidak ada pembayaran.</td></tr>`
          : result.payments.map(p => `<tr><td>${new Date(p.tanggal + 'T00:00:00').toLocaleDateString('id-ID')}</td><td>${formatCurrency(p.jumlah)}</td><td><span class="badge bg-info">${p.metode}</span></td></tr>`).join('');

        salesBody.innerHTML = result.sales.length === 0
          ? `<tr><td colspan="5" class="text-center text-muted">Tidak ada penjualan.</td></tr>`
          : result.sales.map(s => `<tr><td>${new Date(s.tanggal + 'T00:00:00').toLocaleDateString('id-ID')}</td><td>${s.lokasi}</td><td>${s.nama_produk}</td><td>${s.terjual} Pcs</td><td class="text-end">${formatCurrency(s.total_harga_beli)}</td></tr>`).join('');

        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';
      } catch (e) {
        loadingEl.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
      }
    }

    async function populateOwnerDashboard() {
      try {
        const ownerId = AppState.currentUser.user_info.id;
        const dataResp = await fetch(`/api/get_data_owner/${ownerId}`);

        if (!dataResp.ok) throw new Error("Gagal mengambil data owner");
        AppState.ownerData = await dataResp.json();

        document.getElementById("owner-pendapatan-card").textContent = formatCurrency(AppState.ownerData.summary.pendapatan_bulan_ini);
        document.getElementById("owner-biaya-card").textContent = formatCurrency(AppState.ownerData.summary.biaya_bulan_ini);
        document.getElementById("owner-profit-card").textContent = formatCurrency(AppState.ownerData.summary.profit_owner_bulan_ini);
        document.getElementById("owner-superowner-profit-card").textContent = formatCurrency(AppState.ownerData.summary.profit_superowner_bulan_ini);

        await populateOwnerDataPages();
        await initDashboardCharts();
      } catch (error) {
        showToast("Gagal memuat data owner.", false);
      }
    }
    async function populateOwnerDataPages() {
      const { admin_data, lapak_data, supplier_data } = AppState.ownerData;
      document.getElementById("admin-table-body").innerHTML = admin_data
        .map(
          (u) =>
            `<tr><td>${u.nama_lengkap}</td><td>${u.username}</td><td>${u.email}</td><td>${u.nomor_kontak}</td><td class="password-cell"><span class="password-text me-2" data-password="${u.password}"></span><i class="bi bi-eye-slash" style="cursor: pointer;" onclick="toggleTablePasswordVisibility(this)"></i></td><td><div class="btn-group"><button class="btn btn-sm btn-warning btn-action" onclick='openEditModal("admin", ${u.id})'><i class="bi bi-pencil-fill"></i></button><button class="btn btn-sm btn-danger btn-action" onclick='handleDelete("admin", ${u.id})'><i class="bi bi-trash-fill"></i></button></div></td></tr>`
        )
        .join("");
      document.getElementById("lapak-table-body").innerHTML = lapak_data
        .map(
          (l) =>
            `<tr><td>${l.lokasi}</td><td>${l.penanggung_jawab}</td><td>${l.anggota
              .map(
                (a) =>
                  `<span class="badge bg-secondary me-1">${a.nama}</span>`
              )
              .join("") || "-"
            }</td><td><div class="btn-group"><button class="btn btn-sm btn-warning btn-action" onclick='openEditModal("lapak", ${l.id
            })'><i class="bi bi-pencil-fill"></i></button><button class="btn btn-sm btn-danger btn-action" onclick='handleDelete("lapak", ${l.id
            })'><i class="bi bi-trash-fill"></i></button></div></td></tr>`
        )
        .join("");
      document.getElementById("supplier-table-body").innerHTML = supplier_data
        .map(
          (s) =>
            `<tr><td>${s.nama_supplier}</td><td>${s.username || "-"
            }</td><td>${s.kontak}</td><td>${s.nomor_register || "-"
            }</td><td class="password-cell"><span class="password-text me-2" data-password="${s.password
            }"></span><i class="bi bi-eye-slash" style="cursor: pointer;" onclick="toggleTablePasswordVisibility(this)"></i></td><td><div class="btn-group"><button class="btn btn-sm btn-warning btn-action" onclick='openEditModal("supplier", ${s.id
            })'><i class="bi bi-pencil-fill"></i></button><button class="btn btn-sm btn-danger btn-action" onclick='handleDelete("supplier", ${s.id
            })'><i class="bi bi-trash-fill"></i></button></div></td></tr>`
        )
        .join("");
    }
    async function showReportDetails(reportId) {
      const container = document.getElementById("invoice-content");
      container.innerHTML = `<div class="text-center p-5"><div class="spinner-border"></div></div>`;
      modals.reportDetail.show();
      try {
        const resp = await fetch(`/api/get_report_details/${reportId}`);
        const result = await resp.json();
        if (!result.success) throw new Error(result.message);

        const data = result.data;

        // --- 1. MEMBUAT HTML STATUS HUTANG (BAGIAN BARU) ---
        let hutangHtml = '';
        if (data.supplier_status && Object.keys(data.supplier_status).length > 0) {
          hutangHtml += `
              <div class="alert alert-warning mt-3 border-warning">
                <h6 class="alert-heading fw-bold mb-2"><i class="bi bi-info-circle-fill"></i> Status Hutang Supplier Terkait</h6>
                <div class="row g-2">`;

          for (const [name, status] of Object.entries(data.supplier_status)) {
            // Warna merah jika hutang > 0, Hijau jika lunas (0)
            const colorClass = status.total_hutang_saat_ini > 100 ? 'text-danger' : 'text-success';

            hutangHtml += `
                  <div class="col-md-6">
                      <div class="p-2 bg-white border rounded">
                        <strong>${name}</strong><br>
                        <small>Total Hutang: <span class="${colorClass} fw-bold">${formatCurrency(status.total_hutang_saat_ini)}</span></small><br>
                        <small class="text-muted" style="font-size:0.8em">Terakhir dibayar: ${status.terakhir_dibayar}</small>
                      </div>
                  </div>
                `;
          }
          hutangHtml += `</div></div>`;
        }
        // ---------------------------------------------------

        let rincianHtml = '';
        const suppliers = Object.keys(data.rincian_per_supplier);

        if (suppliers.length === 0) {
          rincianHtml = '<p class="text-center text-muted">Tidak ada rincian produk untuk laporan ini.</p>';
        } else {
          suppliers.forEach(supplierName => {
            const products = data.rincian_per_supplier[supplierName];
            let supplierSubtotal = 0;

            rincianHtml += `
                      <h5 class="mt-4">${supplierName}</h5>
                      <table class="table table-sm table-bordered">
                          <thead class="table-light">
                              <tr class="heading">
                                  <td>No.</td>
                                  <td>Produk</td>
                                  <td class="text-center">Stok Awal</td>
                                  <td class="text-center">Stok Akhir</td>
                                  <td class="text-center">Terjual</td>
                                  <td class="text-end">Subtotal</td>
                              </tr>
                          </thead>
                          <tbody>
                  `;

            products.forEach((p, index) => {
              supplierSubtotal += p.total_pendapatan;
              rincianHtml += `
                          <tr class="item">
                              <td>${index + 1}</td>
                              <td>${p.nama_produk}</td>
                              <td class="text-center">${p.stok_awal}</td>
                              <td class="text-center">${p.stok_akhir}</td>
                              <td class="text-center">${p.terjual}</td>
                              <td class="text-end">${formatCurrency(p.total_pendapatan)}</td>
                          </tr>
                      `;
            });

            rincianHtml += `
                          <tr class="total">
                              <td colspan="5" class="text-end fw-bold">Subtotal ${supplierName}</td>
                              <td class="text-end fw-bold">${formatCurrency(supplierSubtotal)}</td>
                          </tr>
                          </tbody>
                      </table>
                  `;
          });
        }
        const compareHtml = `
              <tr><td>Terjual (Cash)</td><td class="text-end">${formatCurrency(data.rekap_otomatis.terjual_cash)}</td><td class="text-end">${formatCurrency(data.rekap_manual.terjual_cash)}</td></tr>
              <tr><td>Terjual (QRIS)</td><td class="text-end">${formatCurrency(data.rekap_otomatis.terjual_qris)}</td><td class="text-end">${formatCurrency(data.rekap_manual.terjual_qris)}</td></tr>
              <tr><td>Terjual (BCA)</td><td class="text-end">${formatCurrency(data.rekap_otomatis.terjual_bca)}</td><td class="text-end">${formatCurrency(data.rekap_manual.terjual_bca)}</td></tr>
              <tr class="fw-bold"><td>Total Produk Terjual</td><td class="text-end">${data.rekap_otomatis.total_produk_terjual} Pcs</td><td class="text-end">${data.rekap_manual.total_produk_terjual} Pcs</td></tr>
              <tr class="fw-bold table-group-divider"><td>Total Pendapatan</td><td class="text-end">${formatCurrency(data.rekap_otomatis.total_pendapatan)}</td><td class="text-end">${formatCurrency(data.rekap_manual.total_pendapatan)}</td></tr>
            `;

        container.innerHTML = `
              <table>
                <tr class="top"><td colspan="2"><table><tr><td class="title"><h4>Laporan Penjualan</h4></td><td style="text-align: right;">ID Laporan: #${data.id}<br>Tanggal: ${data.tanggal}<br>Status: ${data.status}</td></tr></table></td></tr>
                <tr class="information"><td colspan="2"><table><tr><td>Lapak: <strong>${data.lokasi}</strong><br>Penanggung Jawab:<br>${data.penanggung_jawab}</td></tr></table></td></tr>
              </table>
              
              ${hutangHtml} ${rincianHtml}
              
              <table class="mt-4">
                 <tr class="total"><td class="text-end fw-bold">Total Pendapatan (Sistem)</td><td class="text-end fw-bold" style="width:25%">${formatCurrency(data.rekap_otomatis.total_pendapatan)}</td></tr>
                 <tr class="total"><td class="text-end fw-bold">Total Biaya Supplier</td><td class="text-end fw-bold" style="width:25%">${formatCurrency(data.rekap_otomatis.total_biaya_supplier)}</td></tr>
              </table>
              <h5 class="mt-5 mb-3">Perbandingan Rekapitulasi</h5>
              <table class="table table-bordered"><thead class="table-light"><tr><th>Deskripsi</th><th class="text-end">Otomatis (Sistem)</th><th class="text-end">Manual (Karyawan)</th></tr></thead><tbody>${compareHtml}</tbody></table>
            `;
      } catch (e) {
        container.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
      }
    }
    async function downloadReportAsPDF() {
      const sourceElement = document.getElementById("invoice-content");

      // 1. Ambil ID Laporan untuk nama file (menggunakan logika asli Anda)
      let reportId = "unknown";
      try {
        reportId = sourceElement
          .querySelector('td[style="text-align: right;"]')
          .innerText.split("\n")[0]
          .split("#")[1] || "unknown";
      } catch (e) {
        console.warn("Gagal mengambil ID laporan untuk nama file");
      }

      // 2. Buat tombol loading feedback
      const btn = document.querySelector('#report-detail-modal .btn-primary');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sedang memproses...';
      btn.disabled = true;

      try {
        // 3. KLONING elemen laporan
        const clonedElement = sourceElement.cloneNode(true);

        // 4. Buat wadah sementara (Ghost Container)
        // Wadah ini diposisikan di luar layar tapi tidak disembunyikan (display: none)
        // agar html2canvas tetap bisa membacanya.
        const ghostContainer = document.createElement('div');
        ghostContainer.id = "pdf-ghost-container";
        ghostContainer.style.position = 'absolute';
        ghostContainer.style.top = '-9999px';
        ghostContainer.style.left = '-9999px';
        ghostContainer.style.width = '210mm'; // Lebar kertas A4
        ghostContainer.style.minHeight = '297mm'; // Tinggi minimal A4
        ghostContainer.style.padding = '20px';
        ghostContainer.style.backgroundColor = '#ffffff';
        ghostContainer.style.zIndex = '-100';

        // Pastikan style tabel di dalam ghost container terlihat penuh
        // Kita paksa lebar elemen kloningan menjadi 100% dari wadah A4
        clonedElement.style.maxWidth = '100%';
        clonedElement.style.width = '100%';

        ghostContainer.appendChild(clonedElement);
        document.body.appendChild(ghostContainer);

        // 5. Ambil gambar dari Ghost Container (bukan dari Modal)
        const canvas = await html2canvas(ghostContainer, {
          scale: 2, // Kualitas tinggi
          useCORS: true,
          windowWidth: ghostContainer.scrollWidth,
          windowHeight: ghostContainer.scrollHeight
        });

        // 6. Generate PDF
        const imgData = canvas.toDataURL("image/png");
        // PDF format A4
        const pdf = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });

        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
        pdf.save(`laporan-harian-${reportId}.pdf`);

        // 7. Bersihkan wadah sementara
        document.body.removeChild(ghostContainer);
        showToast("PDF berhasil diunduh.", true);

      } catch (error) {
        console.error(error);
        showToast("Gagal mengunduh PDF: " + error.message, false);
      } finally {
        // Kembalikan tombol ke semula
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }
    async function populateLaporanPendapatan() {
      const date = document.getElementById(
        "laporan-pendapatan-datepicker"
      ).value;
      const accordionEl = document.getElementById(
        "laporan-pendapatan-accordion"
      );
      accordionEl.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>`;
      try {
        const resp = await fetch(
          `/api/get_laporan_pendapatan_harian?date=${date}`
        );
        if (!resp.ok) throw new Error("Gagal mengambil data");
        const data = await resp.json();
        document.getElementById("total-pendapatan-harian").textContent =
          formatCurrency(data.total_harian);
        accordionEl.innerHTML = "";
        if (data.laporan_per_lapak.length === 0) {
          accordionEl.innerHTML =
            '<div class="alert alert-warning text-center">Tidak ada laporan untuk tanggal ini.</div>';
        } else {
          data.laporan_per_lapak.forEach((lapak, index) => {
            const productList = lapak.rincian_pendapatan
              .map(
                (p) =>
                  `<li class="list-group-item d-flex justify-content-between"><div>${p.produk} <small class="text-muted">(${p.supplier})</small></div><div><span class="badge text-bg-light me-2">Awal: ${p.stok_awal}</span><span class="badge text-bg-light me-2">Akhir: ${p.stok_akhir}</span><span class="badge bg-primary rounded-pill">${p.jumlah} Pcs</span></div></li>`
              )
              .join("");
            accordionEl.innerHTML += `<div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button ${index !== 0 ? "collapsed" : ""
              }" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-lp-${index}"><strong>${lapak.lokasi
              }</strong> <span class="ms-auto me-3">${formatCurrency(
                lapak.total_pendapatan
              )}</span></button></h2><div id="collapse-lp-${index}" class="accordion-collapse collapse ${index === 0 ? "show" : ""
              }"><div class="accordion-body"><p>PJ: <strong>${lapak.penanggung_jawab
              }</strong></p><ul class="list-group list-group-flush">${productList}</ul></div></div></div>`;
          });
        }
      } catch (error) {
        accordionEl.innerHTML =
          '<div class="alert alert-danger text-center">Gagal memuat.</div>';
      }
    }
    async function populateLaporanBiaya() {
      const date = document.getElementById("laporan-biaya-datepicker").value;
      const accordionEl = document.getElementById("laporan-biaya-accordion");
      accordionEl.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-warning"></div></div>`;
      try {
        const resp = await fetch(
          `/api/get_laporan_biaya_harian?date=${date}`
        );
        if (!resp.ok) throw new Error("Gagal mengambil data");
        const data = await resp.json();
        document.getElementById("total-biaya-harian").textContent =
          formatCurrency(data.total_harian);
        accordionEl.innerHTML = "";
        if (data.laporan_per_lapak.length === 0) {
          accordionEl.innerHTML =
            '<div class="alert alert-warning text-center">Tidak ada laporan untuk tanggal ini.</div>';
        } else {
          data.laporan_per_lapak.forEach((lapak, index) => {
            const productList = lapak.rincian_biaya
              .map(
                (p) =>
                  `<li class="list-group-item d-flex justify-content-between"><div>${p.produk
                  } <small class="text-muted">(${p.supplier
                  })</small></div><div><span class="badge bg-primary rounded-pill me-2">${p.jumlah
                  } Pcs</span><span class="fw-bold">${formatCurrency(
                    p.biaya
                  )}</span></div></li>`
              )
              .join("");
            accordionEl.innerHTML += `<div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button ${index !== 0 ? "collapsed" : ""
              }" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-lb-${index}"><strong>${lapak.lokasi
              }</strong> <span class="ms-auto me-3">${formatCurrency(
                lapak.total_biaya
              )}</span></button></h2><div id="collapse-lb-${index}" class="accordion-collapse collapse ${index === 0 ? "show" : ""
              }"><div class="accordion-body"><p>PJ: <strong>${lapak.penanggung_jawab
              }</strong></p><ul class="list-group list-group-flush">${productList}</ul></div></div></div>`;
          });
        }
      } catch (error) {
        accordionEl.innerHTML =
          '<div class="alert alert-danger text-center">Gagal memuat.</div>';
      }
    }
    // (Ganti fungsi lama di baris 2017 dengan ini)
    async function populateManageReportsPage() {
      const loadingEl = document.getElementById("manage-reports-loading"),
        contentEl = document.getElementById("manage-reports-content"),
        tableBody = document.getElementById("unconfirmed-reports-table-body"),
        supplierSelect = document.getElementById('manage-reports-supplier-filter');

      // (Logika pengisian dropdown supplier tetap sama)
      if (supplierSelect.options.length <= 1) {
        if (AppState.ownerData && AppState.ownerData.supplier_data) {
          AppState.ownerData.supplier_data.forEach(s => {
            supplierSelect.innerHTML += `<option value="${s.id}">${s.nama_supplier}</option>`;
          });
        }
      }
      loadingEl.style.display = "block";
      contentEl.style.display = "none";

      // === LOGIKA FILTER BARU DIMULAI DI SINI ===
      // (Sekitar baris 2035 di index.html)
      // === LOGIKA FILTER BARU DIMULAI DI SINI ===
      const params = new URLSearchParams();
      const ownerId = AppState.currentUser.user_info.id;
      params.append('owner_id', ownerId);
      const supplierId = supplierSelect.value;
      const status = document.getElementById('manage-reports-status-filter').value; // <-- BACA FILTER STATUS

      if (supplierId) params.append('supplier_id', supplierId);
      if (status) params.append('status', status); // <-- KIRIM FILTER STATUS

      const advancedFilterEl = document.getElementById('advanced-reports-filter');
      const isAdvanced = advancedFilterEl.classList.contains('show');
      let startDate, endDate;

      if (isAdvanced) {
        // 1. Gunakan filter canggih (rentang tanggal)
        startDate = document.getElementById('manage-reports-start-date').value;
        endDate = document.getElementById('manage-reports-end-date').value;
      } else {
        // 2. Gunakan filter harian
        const dailyDate = document.getElementById('manage-reports-daily-date').value;
        startDate = dailyDate;
        endDate = dailyDate;
      }

      if (startDate) params.append('start_date', startDate);
      if (endDate) params.append('end_date', endDate);
      // === LOGIKA FILTER BARU SELESAI ===

      try {
        const resp = await fetch(`/api/get_manage_reports?${params.toString()}`);
        const result = await resp.json();
        // (Sisa dari fungsi ini (try...catch...finally) tetap sama seperti file Anda)
        if (result.success) {
          tableBody.innerHTML = result.reports.length === 0 ? '<tr><td colspan="9" class="text-center text-muted">Tidak ada laporan yang cocok.</td></tr>' :
            result.reports.map((r) => {
              const statusBadge = r.status === 'Terkonfirmasi' ? `<span class="badge bg-success">${r.status}</span>` : `<span class="badge bg-warning text-dark">${r.status}</span>`;
              // (Sekitar baris 2056 di index.html)
              // Logika Tombol Aksi Baru:
              // Jika Menunggu: Tampilkan tombol "Konfirmasi"
              // Jika Terkonfirmasi: Nonaktifkan tombol
              const confirmButton = r.status === 'Menunggu Konfirmasi'
                ? `<button class="btn btn-sm btn-success" onclick="confirmReport(${r.id})"><i class="bi bi-check-circle-fill"></i> Konfirmasi</button>`
                : `<button class="btn btn-sm btn-secondary" disabled><i class="bi bi-check-circle-fill"></i></button>`;
              const profitOwnerHtml = r.status === 'Terkonfirmasi' ? formatCurrency(r.keuntungan_owner) : '-';
              const profitSuperownerHtml = r.status === 'Terkonfirmasi' ? formatCurrency(r.keuntungan_superowner) : '-';
              return `<tr>
              <td>${r.id}</td><td>${r.lokasi}</td><td>${r.penanggung_jawab}</td>
              <td>${new Date(r.tanggal).toLocaleDateString("id-ID")}</td>
              <td>${formatCurrency(r.total_pendapatan)}</td>
              <td class="text-success fw-bold">${profitOwnerHtml}</td>
              <td class="text-secondary">${profitSuperownerHtml}</td>
              <td>${statusBadge}</td>
              <td><div class="btn-group">
                  <button class="btn btn-sm btn-info" onclick="showReportDetails(${r.id})"><i class="bi bi-eye-fill"></i></button>
                  ${confirmButton}
              </div></td>
          </tr>`;
            }).join("");
          contentEl.style.display = "block";
        } else { throw new Error(result.message); }
      } catch (error) {
        loadingEl.innerHTML = `<div class="alert alert-danger">${error.message || "Gagal memuat"}</div>`;
      } finally {
        loadingEl.style.display = "none";
      }
    }
    // (Ganti fungsi lama di baris 2088)
    async function confirmReport(reportId) {
      if (
        !confirm(
          "Apakah Anda yakin ingin mengkonfirmasi laporan ini? Tindakan ini akan menghitung profit dan memperbarui saldo tagihan supplier."
        )
      )
        return;
      try {
        // === PERBAIKAN DI SINI: Kirim ID Owner ===
        const ownerId = AppState.currentUser.user_info.id;
        const resp = await fetch(`/api/confirm_report/${reportId}`, {
          method: "POST",
          // Tambahkan body yang mengirim owner_id
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ owner_id: ownerId })
        });
        // === AKHIR PERBAIKAN ===

        const result = await resp.json();
        showToast(result.message, result.success);
        if (result.success) {
          await populateManageReportsPage();
          await populateOwnerDashboard(); // Refresh KPI card juga
        }
      } catch (e) {
        showToast("Gagal terhubung ke server.", false);
      }
    }

    async function openEditModal(type, id = null) {
      const isEdit = id !== null;
      let data = {};
      if (isEdit) {
        const dataArray = AppState.ownerData[`${type}_data`];
        data = dataArray.find((item) => item.id === id);
        if (!data) return showToast("Data tidak ditemukan.", false);
      }
      if (type === "admin") {
        const form = document.getElementById("edit-admin-form");
        form.reset();
        document.getElementById("admin-modal-title").textContent = isEdit
          ? "Edit Admin"
          : "Tambah Admin Baru";
        document.getElementById("edit-admin-id").value = id || "";
        if (isEdit) {
          document.getElementById("edit-admin-nama").value =
            data.nama_lengkap;
          document.getElementById("edit-admin-nik").value = data.nik;
          document.getElementById("edit-admin-username").value =
            data.username;
          document.getElementById("edit-admin-email").value = data.email;
          document.getElementById("edit-admin-kontak").value =
            data.nomor_kontak;
        }
        modals.admin.show();
      } else if (type === "lapak") {
        const form = document.getElementById("edit-lapak-form");
        form.reset();
        document.getElementById("lapak-modal-title").textContent = isEdit
          ? "Edit Lapak"
          : "Tambah Lapak Baru";
        document.getElementById("edit-lapak-id").value = id || "";

        const pjSelect = document.getElementById("lapak-pj-select");
        const anggotaContainer = document.getElementById(
          "lapak-anggota-selection"
        );
        pjSelect.innerHTML =
          '<option value="" selected disabled>-- Pilih PJ --</option>' +
          AppState.ownerData.admin_data
            .map((a) => `<option value="${a.id}">${a.nama_lengkap}</option>`)
            .join("");
        anggotaContainer.innerHTML = AppState.ownerData.admin_data
          .map(
            (a) =>
              `<div class="form-check"><input class="form-check-input" type="checkbox" value="${a.id}" id="anggota-${a.id}"><label class="form-check-label" for="anggota-${a.id}">${a.nama_lengkap}</label></div>`
          )
          .join("");

        if (isEdit) {
          document.getElementById("edit-lapak-lokasi").value = data.lokasi;
          pjSelect.value = data.user_id;
          data.anggota_ids.forEach((anggotaId) => {
            const checkbox = document.getElementById(`anggota-${anggotaId}`);
            if (checkbox) checkbox.checked = true;
          });
        }
        modals.lapak.show();
      } else if (type === "supplier") {
        const form = document.getElementById("edit-supplier-form");
        form.reset();
        document.getElementById("supplier-modal-title").textContent = isEdit ? "Edit Supplier" : "Tambah Supplier Baru";
        document.getElementById("edit-supplier-id").value = id || "";

        // BARIS PENTING: Tidak ada lagi yang disembunyikan. Semua field selalu terlihat.

        // Isi data dasar supplier
        if (isEdit) {
          document.getElementById("edit-supplier-nama").value = data.nama_supplier;
          document.getElementById("edit-supplier-username").value = data.username;
          document.getElementById("edit-supplier-kontak").value = data.kontak;
          document.getElementById("edit-supplier-register").value = data.nomor_register;
          document.getElementById("edit-supplier-alamat").value = data.alamat;
          document.getElementById("edit-supplier-metode").value = data.metode_pembayaran;
          document.getElementById("edit-supplier-rekening").value = data.nomor_rekening;
        } else {
          // Dapatkan nomor register baru untuk supplier baru
          // REVISI: Kirim ID Owner yang sedang login
          const ownerId = AppState.currentUser.user_info.id;
          const resp = await fetch(`/api/get_next_supplier_reg_number/${ownerId}`);

          const result = await resp.json();
          document.getElementById("edit-supplier-register").value = result.reg_number;
        }

        modals.supplier.show();
      }
    }
    // GANTI FUNGSI LAMA DENGAN VERSI BARU INI
    async function handleFormSubmit(type, e) {
      e.preventDefault();
      const form = e.target;
      const id = form.querySelector(`input[type=hidden]`).value;
      const isEdit = id !== "";
      let url = isEdit ? `/api/update_${type}/${id}` : `/api/add_${type}`;
      let method = isEdit ? "PUT" : "POST";
      let payload = {};
      if (type === "admin") {
        const password = form.elements["edit-admin-password"].value;
        if (password && password !== form.elements["edit-admin-password-confirm"].value) {
          return showToast("Password dan konfirmasi tidak cocok.", false);
        }
        payload = {
          nama_lengkap: form.elements["edit-admin-nama"].value,
          username: form.elements["edit-admin-username"].value,
          email: form.elements["edit-admin-email"].value,
          nomor_kontak: form.elements["edit-admin-kontak"].value,
          password: password,
          password_confirm: form.elements["edit-admin-password-confirm"].value,
          // ==========================================================
          // ===           INILAH PERBAIKAN UTAMANYA              ===
          // ==========================================================
          // Pastikan kita selalu mengirim ID Owner yang sedang membuat admin
          created_by_owner_id: AppState.currentUser.user_info.id
          // ==========================================================
        };
      } else if (type === "lapak") {
        const anggota_ids = Array.from(
          form.querySelectorAll("#lapak-anggota-selection input:checked")
        ).map((cb) => cb.value);
        payload = {
          lokasi: form.elements["edit-lapak-lokasi"].value,
          user_id: form.elements["lapak-pj-select"].value,
          anggota_ids,
          owner_id: AppState.currentUser.user_info.id,
        };
      } else if (type === "supplier") {
        const password = form.elements["edit-supplier-password"].value;
        if (password && password !== form.elements["edit-supplier-password-confirm"].value)
          return showToast("Password dan konfirmasi tidak cocok.", false);

        payload = {
          nama_supplier: form.elements["edit-supplier-nama"].value,
          username: form.elements["edit-supplier-username"].value,
          kontak: form.elements["edit-supplier-kontak"].value,
          nomor_register: form.elements["edit-supplier-register"].value,
          alamat: form.elements["edit-supplier-alamat"].value,
          password,
          password_confirm: form.elements["edit-supplier-password-confirm"].value,
          metode_pembayaran: form.elements["edit-supplier-metode"].value,
          nomor_rekening: form.elements["edit-supplier-rekening"].value,
          owner_id: AppState.currentUser.user_info.id,
        };
      }
      const resp = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const result = await resp.json();
      showToast(result.message, resp.ok);
      if (resp.ok) {
        modals[type].hide();
        await populateOwnerDashboard();
      }
    }
    async function handleDelete(type, id) {
      if (
        !confirm(
          `Apakah Anda yakin ingin menghapus data ini? Tindakan ini tidak dapat dibatalkan.`
        )
      )
        return;
      const resp = await fetch(`/api/delete_${type}/${id}`, {
        method: "DELETE",
      });
      const result = await resp.json();
      showToast(result.message, resp.ok);
      if (resp.ok) await populateOwnerDashboard();
    }
    // GANTI FUNGSI LAMA DENGAN VERSI BARU INI
    async function populateVerificationCenter() {
      const loadingEl = document.getElementById('verification-center-loading');
      const contentEl = document.getElementById('verification-center-content');
      const listEl = document.getElementById('verification-report-list');

      loadingEl.style.display = 'block';
      contentEl.style.display = 'none';

      try {
        const ownerId = AppState.currentUser.user_info.id;
        const resp = await fetch(`/api/get_owner_verification_reports/${ownerId}`);
        const result = await resp.json();
        if (!result.success) throw new Error(result.message);

        if (result.reports.length === 0) {
          listEl.innerHTML = `<div class="list-group-item text-center text-muted p-4">Tidak ada laporan baru yang perlu diverifikasi.</div>`;
          contentEl.querySelector('button').disabled = true;
        } else {
          // PERUBAHAN DI SINI: Tambahkan 'data-report-id'
          listEl.innerHTML = result.reports.map(r => `
              <div class="list-group-item d-flex justify-content-between align-items-center" data-report-id="${r.id}">
                <div>
                  <strong>Laporan dari ${r.lokasi}</strong>
                  <small class="d-block text-muted">Tanggal: ${r.tanggal} | Total: ${formatCurrency(r.total_pendapatan)}</small>
                </div>
                <button class="btn btn-sm btn-outline-info" onclick="showReportDetails(${r.id})">
                    <i class="bi bi-eye-fill"></i> Lihat Detail
                </button>
              </div>
            `).join('');
          contentEl.querySelector('button').disabled = false;
        }
        contentEl.style.display = 'block';
      } catch (e) {
        loadingEl.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
      } finally {
        loadingEl.style.display = 'none';
      }
    }

    // GANTI FUNGSI LAMA DENGAN VERSI BARU INI
    async function handleFinalizeReports() {
      const reportItems = document.querySelectorAll('#verification-report-list .list-group-item');
      const reportIds = Array.from(reportItems).map(item => item.dataset.reportId).filter(id => id);

      if (reportIds.length === 0) {
        return showToast("Tidak ada laporan untuk difinalisasi.", false);
      }

      if (!confirm(`Anda akan memfinalisasi ${reportIds.length} laporan. Setelah difinalisasi, laporan akan dikonfirmasi dan profit akan dibagikan. Lanjutkan?`)) return;

      const button = document.querySelector('#verification-center-content button');
      const originalBtnHTML = button.innerHTML;
      button.disabled = true;
      button.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Memproses...`;

      try {
        const ownerId = AppState.currentUser.user_info.id;
        const resp = await fetch('/api/finalize_reports', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ report_ids: reportIds, owner_id: ownerId })
        });
        const result = await resp.json();
        showToast(result.message, result.success);

        if (result.success) {
          // Kembali ke dashboard utama setelah berhasil
          showPage('owner-dashboard');
        }
      } catch (e) {
        showToast('Gagal terhubung ke server.', false);
      } finally {
        button.disabled = false;
        button.innerHTML = originalBtnHTML;
      }
    }

    // (Ganti fungsi lama di baris 2088 dengan ini)
    async function populatePembayaranPage() {
      const loadingEl = document.getElementById("pembayaran-content-loading"),
        mainEl = document.getElementById("pembayaran-content-main");
      const tableBody = document.getElementById("pembayaran-table-body");
      const filterMetode = document.getElementById('tagihan-metode-filter').value; // <-- BACA FILTER

      loadingEl.style.display = "block";
      mainEl.style.display = "none";

      try {
        // === PERBAIKAN: Kirim owner_id ===
        const ownerId = AppState.currentUser.user_info.id;
        const resp = await fetch(`/api/get_pembayaran_data?owner_id=${ownerId}`);
        const result = await resp.json();
        if (!result.success) throw new Error(result.message);

        tableBody.innerHTML = "";

        // Terapkan filter metode pembayaran
        const filteredBalances = result.supplier_balances.filter(item =>
          filterMetode === 'semua' || item.metode_pembayaran === filterMetode
        );

        // ... (kode atas tetap sama) ...

        if (filteredBalances.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Tidak ada tagihan yang cocok.</td></tr>';
        } else {
          filteredBalances.forEach((item) => {
            // 1. Tentukan Logika Payable
            let isPayable;
            if (item.metode_pembayaran === 'BCA') {
              isPayable = item.total_tagihan > 0.01;
            } else {
              isPayable = item.total_tagihan >= 20000;
            }

            // 2. Buat Tombol View (Mata)
            const viewBtn = `<button class="btn btn-sm btn-outline-info" onclick="showBillDetails(${item.supplier_id}, '${item.nama_supplier}', ${item.total_tagihan})"><i class="bi bi-eye"></i></button>`;

            // 3. Tentukan Status Badge & Tombol Aksi Utama
            const isPaid = item.total_tagihan < 0.01;
            let statusBadge, mainActionBtn; // Gunakan nama variabel baru untuk tombol utama

            if (isPaid) {
              statusBadge = `<span class="badge bg-light text-dark">Lunas</span>`;
              mainActionBtn = `<button class="btn btn-sm btn-secondary" disabled>Lunas</button>`;
            } else if (isPayable) {
              statusBadge = `<span class="badge bg-success">Siap Bayar</span>`;
              mainActionBtn = `<button class="btn btn-sm btn-primary" onclick='openPaymentModal(${item.supplier_id}, "${item.nama_supplier}", ${item.total_tagihan})'>Bayar Tagihan</button>`;
            } else {
              statusBadge = `<span class="badge bg-warning text-dark">Akumulasi</span>`;
              mainActionBtn = `<button class="btn btn-sm btn-secondary" disabled>Dibawah Minimum</button>`;
            }

            // 4. GABUNGKAN TOMBOL (View + Main Action)
            // Kita gabungkan di sini SETELAH mainActionBtn punya nilai
            const finalActionBtn = `<div class="btn-group">${viewBtn}${mainActionBtn}</div>`;

            // 5. Tampilkan tanggal tagihan masuk
            const tanggalMasukHtml = item.tanggal_masuk
              ? `<small class="d-block text-danger" style="font-size: 0.8em;">Tagihan sejak: ${new Date(item.tanggal_masuk + 'T00:00:00').toLocaleDateString('id-ID')}</small>`
              : '';

            // 6. Render Tabel
            tableBody.innerHTML += `<tr>
            <td>
              ${item.nama_supplier}
              <small class="d-block text-muted">${item.metode_pembayaran} - ${item.nomor_rekening}</small>
              ${tanggalMasukHtml}
            </td>
            <td class="fw-bold">${formatCurrency(item.total_tagihan)}</td>
            <td>${statusBadge}</td>
            <td>${finalActionBtn}</td></tr>`; // Gunakan finalActionBtn
          });
        }

        // ... (kode bawah tetap sama) ...

        loadingEl.style.display = "none";
        mainEl.style.display = "block";

        await populatePaymentHistory();
      } catch (e) {
        showToast(e.message, false);
        loadingEl.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
      }
    }

    // 1. Fungsi Helper untuk merender HTML Akumulasi Harian
    async function renderBillBreakdown(supplierId, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = `<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-secondary"></div><div class="small text-muted">Mengambil data akumulasi...</div></div>`;

      try {
        const resp = await fetch(`/api/get_supplier_bill_breakdown/${supplierId}`);
        const result = await resp.json();

        if (!result.success || result.breakdown.length === 0) {
          container.innerHTML = `<div class="text-center text-muted small py-3">Belum ada data tagihan bulan ini.</div>`;
          return;
        }

        let html = '<ul class="list-group list-group-flush small">';

        result.breakdown.forEach(day => {
          // Header Tanggal
          html += `
                    <li class="list-group-item bg-light fw-bold d-flex justify-content-between align-items-center px-2 py-1 mt-2">
                        <span><i class="bi bi-calendar-event me-1"></i> ${day.tanggal_formatted}</span>
                        <span class="text-dark">${formatCurrency(day.total_hari_ini)}</span>
                    </li>
                `;

          // Rincian per Admin/Lapak
          day.items.forEach(item => {
            html += `
                        <li class="list-group-item d-flex justify-content-between align-items-center px-2 py-1 border-0">
                            <span class="ps-3 text-muted"><i class="bi bi-shop me-1"></i> ${item.lokasi} <span style="font-size:0.75em">(${item.pj})</span></span>
                            <span>${formatCurrency(item.nominal)}</span>
                        </li>
                    `;
          });
        });
        html += '</ul>';
        container.innerHTML = html;

      } catch (e) {
        container.innerHTML = `<div class="alert alert-danger small p-1">Gagal memuat rincian.</div>`;
      }
    }

    // 2. Fungsi Tombol Mata (Lihat Saja)
    function showBillDetails(supplierId, supplierName, amount) {
      document.getElementById('detail-supplier-name').textContent = `Tagihan: ${supplierName}`;

      // Setup tombol "Bayar Sekarang" di dalam modal detail agar user bisa langsung bayar
      const payBtn = document.getElementById('btn-pay-from-detail');
      payBtn.onclick = function () {
        modals.billDetail.hide();
        openPaymentModal(supplierId, supplierName, amount);
      };

      modals.billDetail.show();
      renderBillBreakdown(supplierId, 'bill-breakdown-container');
    }

    // 3. Update Fungsi openPaymentModal (Bayar & Lihat)
    // GANTI fungsi openPaymentModal yang lama dengan ini:
    async function openPaymentModal(supplierId, supplierName, amount) {
      const supplierData = AppState.ownerData.supplier_data.find(s => s.id === supplierId);

      if (!supplierData || !supplierData.metode_pembayaran) {
        return showToast("Info pembayaran supplier belum diatur.", false);
      }

      // Isi Info Kiri
      document.getElementById("payment-supplier-id").value = supplierId;
      document.getElementById("payment-supplier-amount").value = amount;
      document.getElementById("payment-supplier-name-confirm").textContent = supplierName;
      document.getElementById("payment-amount-confirm").textContent = formatCurrency(amount);
      document.getElementById("payment-method-info").textContent = `${supplierData.metode_pembayaran} - ${supplierData.nomor_rekening}`;

      modals.payment.show();

      // Render Info Kanan (Akumulasi Harian)
      renderBillBreakdown(supplierId, 'payment-modal-breakdown');
    }

    async function populatePaymentHistory() {
      const loadingEl = document.getElementById('payment-history-loading');
      const tableBody = document.getElementById('payment-history-table-body');
      loadingEl.style.display = 'block';
      tableBody.innerHTML = '';

      // (Sekitar baris 2154 di index.html)
      // === LOGIKA FILTER BARU DIMULAI DI SINI ===
      const params = new URLSearchParams();

      // === PERBAIKAN: Tambahkan owner_id ===
      const ownerId = AppState.currentUser.user_info.id;
      params.append('owner_id', ownerId);

      const metode = document.getElementById('payment-history-method').value;
      if (metode && metode !== 'semua') params.append('metode', metode);

      const advancedFilterEl = document.getElementById('advanced-payment-filter');
      const isAdvanced = advancedFilterEl.classList.contains('show');
      let startDate, endDate;

      if (isAdvanced) {
        startDate = document.getElementById('payment-history-start-date').value;
        endDate = document.getElementById('payment-history-end-date').value;
      } else {
        const dailyDate = document.getElementById('payment-history-daily-date').value;
        startDate = dailyDate;
        endDate = dailyDate;
      }

      if (startDate) params.append('start_date', startDate);
      if (endDate) params.append('end_date', endDate);

      try {
        const resp = await fetch(`/api/get_all_payment_history?${params.toString()}`);
        const result = await resp.json();
        if (!result.success) throw new Error(result.message);

        if (result.history.length === 0) {
          // Ganti colspan menjadi 5
          tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Tidak ada riwayat pembayaran.</td></tr>`;
        } else {
          tableBody.innerHTML = result.history.map(p => {
            // Logika baru untuk styling berdasarkan 'tipe'
            const keteranganBadge = p.tipe === 'tagihan'
              ? `<span class="badge bg-warning text-dark">${p.keterangan}</span>`
              : `<span class="badge bg-success">${p.keterangan}</span>`;

            const jumlahClass = p.tipe === 'tagihan' ? 'text-danger' : 'text-success';
            const jumlahPrefix = p.tipe === 'tagihan' ? '-' : '+';

            return `
          <tr>
            <td>${new Date(p.tanggal + 'T00:00:00').toLocaleDateString('id-ID')}</td>
            <td>${p.nama_supplier}</td>
            <td class="${jumlahClass} fw-bold">${jumlahPrefix}${formatCurrency(p.jumlah)}</td>
            <td><span class="badge bg-info">${p.metode}</span></td>
            <td>${keteranganBadge}</td>
          </tr>
        `;
          }).join('');
        }
      } catch (e) {
        tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Gagal memuat: ${e.message}</td></tr>`;
      } finally {
        loadingEl.style.display = 'none';
      }
    }


    async function handlePaymentSubmit(e) {
      e.preventDefault();
      const payload = {
        supplier_id: document.getElementById("payment-supplier-id").value,
        jumlah_pembayaran: document.getElementById("payment-supplier-amount")
          .value,
      };
      const resp = await fetch("/api/submit_pembayaran", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const result = await resp.json();
      showToast(result.message, resp.ok);
      if (resp.ok) {
        modals.payment.hide();
        await populatePembayaranPage();
        await populateOwnerDashboard();
      }
    }

    // --- LAPAK FUNCTIONS ---

    // GANTI FUNGSI LAMA DENGAN VERSI BARU INI
    async function openAturProdukModal() {
      const supplierContainer = document.getElementById("supplier-selection-container");
      const productContainer = document.getElementById("product-selection-container");
      const productAreaTitle = document.getElementById("product-area-title");
      const addProductForm = document.getElementById("add-product-form-container");
      const productSelectionArea = document.getElementById("product-selection-area");

      // Reset tampilan modal ke kondisi awal
      supplierContainer.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
      productContainer.innerHTML = '';
      productAreaTitle.innerHTML = '<p class="text-muted pt-3">Pilih satu supplier untuk melihat & menambah produk.</p>';
      addProductForm.style.display = 'none';
      productSelectionArea.style.display = 'none'; // Sembunyikan juga area produk

      modals.aturProduk.show();

      try {
        const resp = await fetch(`/api/get_data_buat_catatan/${AppState.currentUser.user_info.lapak_id}`);
        const result = await resp.json();
        if (!result.success) {
          if (result.already_exists) {
            modals.aturProduk.hide();
            showToast(result.message, false);
            document.getElementById("laporan-exists").style.display = "block";
            document.getElementById("laporan-content").style.display = "none";
          }
          throw new Error(result.message);
        }

        // Simpan daftar supplier
        AppState.masterData.suppliers = result.data;

        // ==========================================================
        // ===           INILAH PERBAIKAN UTAMANYA              ===
        // ==========================================================
        // Saat mengumpulkan produk, kita juga 'mencatat' supplier_id untuk setiap produk.
        AppState.masterData.products = result.data.flatMap(supplier =>
          supplier.products.map(product => ({
            ...product, // Salin semua data produk (id, name, harga)
            supplier_id: supplier.id // Tambahkan properti supplier_id
          }))
        );
        // ==========================================================

        // Tampilkan daftar supplier sebagai radio button
        supplierContainer.innerHTML = AppState.masterData.suppliers.map(s => `
              <label class="list-group-item">
                <input class="form-check-input me-2 supplier-radio" type="radio" name="supplierSelection" value="${s.id}">
                ${s.name}
              </label>
            `).join('');

        // Tambahkan event listener ke setiap radio button supplier
        document.querySelectorAll('.supplier-radio').forEach(radio => {
          radio.addEventListener('change', updateProductSelection);
        });

      } catch (e) {
        supplierContainer.innerHTML = `<div class="alert alert-danger p-2 small">${e.message}</div>`;
      }
    }

    function updateProductSelection(event) {
      const supplierId = parseInt(event.target.value);
      const productContainer = document.getElementById("product-selection-container");
      const productAreaTitle = document.getElementById("product-area-title");
      const addProductForm = document.getElementById("add-product-form-container");
      const productSelectionArea = document.getElementById("product-selection-area");
      const searchInput = document.getElementById("modal-product-search-input");

      const selectedSupplier = AppState.masterData.suppliers.find(s => s.id === supplierId);
      productAreaTitle.innerHTML = `<h6>Produk dari: <strong>${selectedSupplier.name}</strong></h6>`;
      addProductForm.style.display = 'block';
      productSelectionArea.style.display = 'block';
      searchInput.value = '';

      const renderProducts = (searchTerm = "") => {
        const productsOfSupplier = AppState.masterData.products.filter(p =>
          p.supplier_id === supplierId && p.name.toLowerCase().includes(searchTerm.toLowerCase())
        );
        if (productsOfSupplier.length === 0) {
          productContainer.innerHTML = '<p class="text-muted small p-2">Belum ada produk...</p>';
        } else {
          productContainer.innerHTML = productsOfSupplier.map(p => `
              <div class="input-group input-group-sm mb-2">
                  <div class="input-group-text">
                      <input class="form-check-input mt-0 product-checkbox" type="checkbox" value="${p.id}" id="modal-product-${p.id}">
                  </div>
                  <label for="modal-product-${p.id}" class="form-control d-flex justify-content-between align-items-center">
                    <span>${p.name}</span>
                    <span class="badge bg-light text-dark border">Beli: ${p.harga_beli} | Jual: ${p.harga_jual}</span>
                  </label>
                  
                  <button class="btn btn-outline-secondary" type="button" onclick="openEditProductModal(${p.id})">
                    <i class="bi bi-pencil"></i>
                  </button>

                  <input type="number" class="form-control form-control-sm text-center modal-stok-awal" placeholder="Stok Awal" style="max-width: 80px;" disabled>
              </div>
          `).join('');
        }
      };

      renderProducts();
      searchInput.oninput = () => renderProducts(searchInput.value);

      productContainer.onclick = function (e) {
        if (e.target.classList.contains('product-checkbox')) {
          const stokInput = e.target.closest('.input-group').querySelector('.modal-stok-awal');
          stokInput.disabled = !e.target.checked;
          if (!e.target.checked) stokInput.value = '';
        }
      };
    }

    async function handleAddNewProduct(e) {
      e.preventDefault();

      // 1. Ambil nilai dari input (Perhatikan ID elemennya)
      const productName = document.getElementById("new-product-name-input").value.trim();

      // ID "new-product-price-input" adalah input lama (Harga Jual)
      // Kita namakan variabelnya productSellPrice agar jelas
      const productSellPrice = document.getElementById("new-product-price-input").value.trim();

      // ID "new-product-buy-price-input" adalah input baru (Harga Beli)
      const productBuyPrice = document.getElementById("new-product-buy-price-input").value.trim();

      const selectedSupplierRadio = document.querySelector('.supplier-radio:checked');

      // 2. Validasi kelengkapan data
      if (!productName || !selectedSupplierRadio || !productSellPrice || !productBuyPrice) {
        return showToast("Semua field (Nama, Harga Beli, Harga Jual) harus diisi.", false);
      }

      const supplierId = parseInt(selectedSupplierRadio.value);
      const lapakId = AppState.currentUser.user_info.lapak_id;

      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

      try {
        // 3. Kirim ke Backend
        const resp = await fetch('/api/add_manual_product_to_supplier', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            nama_produk: productName,
            harga_jual: productSellPrice, // Pastikan variabel ini sama dengan yang dideklarasikan di atas
            harga_beli: productBuyPrice,  // Kirim harga beli
            supplier_id: supplierId,
            lapak_id: lapakId
          })
        });
        const result = await resp.json();
        showToast(result.message, result.success);

        if (result.success) {
          // 4. Update State Lokal (Agar langsung muncul tanpa refresh)
          AppState.masterData.products.push(result.product);

          // 5. Reset Form
          document.getElementById("new-product-name-input").value = '';
          document.getElementById("new-product-price-input").value = '';     // Reset Harga Jual
          document.getElementById("new-product-buy-price-input").value = ''; // Reset Harga Beli

          // 6. Refresh Tampilan
          updateProductSelection({ target: selectedSupplierRadio });

          // 7. Auto-check produk baru
          setTimeout(() => {
            const newCheckbox = document.getElementById(`modal-product-${result.product.id}`);
            if (newCheckbox) {
              newCheckbox.checked = true;
              const stokInput = newCheckbox.closest('.input-group').querySelector('.modal-stok-awal');
              if (stokInput) stokInput.disabled = false;
            }
          }, 100);
        }
      } catch (error) {
        showToast('Gagal terhubung ke server.', false);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Simpan';
      }
    }

    // Fungsi Membuka Modal Edit
    function openEditProductModal(productId) {
      const product = AppState.masterData.products.find(p => p.id === productId);
      if (!product) return;

      document.getElementById('edit-product-id').value = productId;
      document.getElementById('edit-product-name').value = product.name;
      document.getElementById('edit-product-buy-price').value = product.harga_beli;
      document.getElementById('edit-product-sell-price').value = product.harga_jual;

      modals.editProduct.show();
    }

    // Fungsi Submit Edit
    async function handleEditProductSubmit(e) {
      e.preventDefault();
      const id = document.getElementById('edit-product-id').value;
      const name = document.getElementById('edit-product-name').value;
      const buyPrice = document.getElementById('edit-product-buy-price').value;
      const sellPrice = document.getElementById('edit-product-sell-price').value;

      try {
        const resp = await fetch(`/api/update_product_price/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            nama_produk: name,
            harga_beli: buyPrice,
            harga_jual: sellPrice
          })
        });
        const result = await resp.json();
        showToast(result.message, result.success);

        if (result.success) {
          // Update data di AppState lokal agar tidak perlu refresh halaman
          const productIndex = AppState.masterData.products.findIndex(p => p.id == id);
          if (productIndex !== -1) {
            AppState.masterData.products[productIndex].name = result.product.name;
            AppState.masterData.products[productIndex].harga_beli = result.product.harga_beli;
            AppState.masterData.products[productIndex].harga_jual = result.product.harga_jual;
          }

          modals.editProduct.hide();

          // Refresh daftar produk di belakang modal (jika sedang terbuka)
          const selectedSupplierRadio = document.querySelector('.supplier-radio:checked');
          if (selectedSupplierRadio) {
            updateProductSelection({ target: selectedSupplierRadio });
          }
        }
      } catch (e) {
        showToast("Gagal mengupdate produk.", false);
      }
    }

    function generateReportTables() {
      const container = document.getElementById("report-tables-container");
      const summaryContainer = document.getElementById("report-summary-container");
      const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');

      if (selectedCheckboxes.length === 0) return showToast("Pilih setidaknya satu produk.", false);

      let productsToDisplay = [];
      let hasInvalidStok = false;
      selectedCheckboxes.forEach(cb => {
        const productId = parseInt(cb.value);
        const stokInput = cb.closest('.input-group').querySelector('.modal-stok-awal');
        const stokAwal = parseInt(stokInput.value) || 0;
        if (stokAwal <= 0) hasInvalidStok = true;
        const product = AppState.masterData.products.find(p => p.id === productId);
        if (product) productsToDisplay.push({ ...product, stokAwal });
      });

      if (hasInvalidStok) return showToast("Stok awal harus diisi dan lebih dari 0.", false);

      const initialPrompt = document.getElementById("initial-prompt");
      if (initialPrompt) initialPrompt.style.display = 'none';

      document.getElementById("product-search-container").style.display = 'block';

      productsToDisplay.forEach(productData => {
        const supplier = AppState.masterData.suppliers.find(s => s.id === productData.supplier_id);
        const supplierGroupId = `supplier-group-${supplier.id}`;
        let supplierGroup = document.getElementById(supplierGroupId);

        if (!supplierGroup) {
          const newGroup = document.createElement('div');
          newGroup.id = supplierGroupId;
          newGroup.className = 'mb-4 border rounded p-2 bg-white shadow-sm';
          const paymentMethod = supplier.metode_pembayaran ? `<span class="badge bg-info ms-2">${supplier.metode_pembayaran}</span>` : '';

          // PERBAIKAN DI SINI: Header dan Footer disesuaikan menjadi 4 kolom saja
          newGroup.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
              <h6 class="mb-0 fw-bold text-primary">${supplier.name}</h6>
              ${paymentMethod}
          </div>
          <div class="table-responsive">
              <table class="table table-borderless align-middle mb-0">
                  <thead class="table-light small text-muted">
                    <tr>
                        <th class="align-middle">Produk</th> 
                        
                        <th class="text-center align-middle" style="width: 60px;">Awal</th>
                        
                        <th class="text-center align-middle" style="min-width: 130px;">Akhir</th>
                        
                        <th style="width: 30px;"></th> 
                    </tr>
                </thead>
                  <tbody></tbody>
                  <tfoot style="border-top: 1px solid #dee2e6;">
                    <tr class="fw-bold small">
                      <td class="text-end text-muted">Total:</td>
                      <td class="text-center supplier-total-awal">0</td>
                      <td class="text-center supplier-total-akhir">0</td>
                      <td></td>
                    </tr>
                  </tfoot>
              </table>
          </div>
        `;
          container.appendChild(newGroup);
          supplierGroup = newGroup;
        }

        const tableBody = supplierGroup.querySelector('tbody');
        const isProductExist = tableBody.querySelector(`tr[data-product-id="${productData.id}"]`);

        if (!isProductExist) {
          let rowHtml = createProductRow(productData, supplier);
          const tempTbody = document.createElement('tbody');
          tempTbody.innerHTML = rowHtml;
          const newRow = tempTbody.querySelector('tr');

          if (newRow) {
            newRow.querySelector('.stok-awal').value = productData.stokAwal;
            newRow.querySelector('.stok-akhir').value = productData.stokAwal;
            attachEventListenersToRow(newRow);
            tableBody.appendChild(newRow);
            updateRowAndTotals(newRow);
          }
        }
      });

      updateSummarySection();
      saveReportStateToLocalStorage();
      modals.aturProduk.hide();

      // UPDATE UI WIZARD
      updateProgressBar(66);
      showToast("Produk ditambahkan. Silakan isi stok akhir.", true);

      // Auto scroll ke Langkah 2
      document.getElementById("report-tables-container").scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function createProductRow(product, supplier) {
      // PERBAIKAN:
      // 1. Tambahkan class 'flex-nowrap' di div input-group
      // 2. Tambahkan style 'min-width' pada input angka agar tidak gepeng
      // 3. Gunakan 'px-2' pada tombol agar tidak terlalu lebar tapi tetap mudah ditekan

      const stokAkhirInput = `
      <div class="input-group input-group-sm flex-nowrap" style="max-width: 140px;">
          <button class="btn btn-outline-secondary btn-minus px-2" type="button">
            <i class="bi bi-dash"></i>
          </button>
          
          <input type="number" 
                 class="form-control text-center input-stok stok-akhir px-1" 
                 placeholder="0" 
                 min="0" 
                 style="min-width: 40px;">
                 
          <button class="btn btn-outline-secondary btn-plus px-2" type="button">
            <i class="bi bi-plus"></i>
          </button>
      </div>`;

      return `
      <tr class="product-row border-bottom" data-product-id="${product.id}" data-harga-jual="${product.harga_jual}" data-harga-beli="${product.harga_beli}">
          <td class="product-supplier-info py-2 align-middle">
            <div class="fw-bold text-dark text-truncate" style="max-width: 150px; font-size: 0.9rem;">${product.name}</div>
            <div class="d-flex align-items-center mt-1">
               <small class="text-muted me-2">Terjual: <span class="terjual-pcs fw-bold text-primary">0</span></small>
               <button class="btn btn-xs btn-outline-warning notify-btn py-0 px-1" style="font-size: 0.7rem;"><i class="bi bi-bell"></i> Habis</button>
            </div>
          </td>
          
          <td class="text-center align-middle">
             <input type="number" class="form-control-plaintext form-control-sm text-center input-stok stok-awal p-0" readonly style="font-weight:bold;">
          </td>
          
          <td class="py-2 align-middle">
            <div class="d-flex justify-content-center">
              ${stokAkhirInput}
            </div>
          </td>
          
          <td class="text-end align-middle">
            <button class="btn btn-sm btn-link text-danger p-0" onclick="removeProductFromTable(this)">
                <i class="bi bi-x-lg"></i>
            </button>
          </td>
      </tr>`;
    }

    function removeProductFromTable(button) {
      // 1. Cari elemen baris (tr)
      const row = button.closest('tr');
      const tbody = row.closest('tbody');
      const table = tbody.closest('table');
      const supplierGroupDiv = table.closest('div').parentElement; // Div pembungkus per supplier

      // 2. Hapus baris tersebut
      row.remove();

      // 3. Cek apakah supplier ini masih punya produk lain?
      if (tbody.children.length === 0) {
        // Jika tidak ada produk tersisa, hapus seluruh grup supplier (judul + tabel)
        supplierGroupDiv.remove();
      } else {
        // Jika masih ada, update total angka di footer tabel supplier ini
        // Kita panggil updateSummarySection() yang otomatis menghitung ulang semuanya
      }

      // 4. Update Ringkasan Global (Total Pendapatan, dll) & Simpan State
      updateSummarySection();
      saveReportStateToLocalStorage();
    }

    async function populateLapakDashboard() {
      const loadingEl = document.getElementById("laporan-loading"),
        contentEl = document.getElementById("laporan-content"),
        existsEl = document.getElementById("laporan-exists");

      loadingEl.style.display = "block";
      contentEl.style.display = "none";
      existsEl.style.display = "none";
      document.getElementById("report-tables-container").innerHTML = `
            <div id="initial-prompt" class="text-center text-muted p-5 border rounded">
                <i class="bi bi-ui-checks-grid" style="font-size: 3rem;"></i><h5 class="mt-3">Mulai Laporan Harian</h5>
                <p>Klik "Atur Produk" di atas untuk memilih produk yang akan dijual hari ini.</p>
            </div>`;
      document.getElementById("product-search-container").style.display = "none";

      try {
        // API dipanggil untuk mengecek apakah laporan hari ini sudah ada
        const resp = await fetch(
          `/api/get_data_buat_catatan/${AppState.currentUser.user_info.lapak_id}`
        );
        if (!resp.ok && resp.status === 409) {
          existsEl.style.display = "block";
          document.getElementById("rekap-footer").style.display = "none";
        } else {
          contentEl.style.display = "block";
        }
      } catch (error) {
        loadingEl.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
      } finally {
        loadingEl.style.display = "none";
      }
    }
    async function populateLapakDashboard() {
      const loadingEl = document.getElementById("laporan-loading");
      const contentEl = document.getElementById("laporan-content");
      const existsEl = document.getElementById("laporan-exists");
      const initialPrompt = document.getElementById("initial-prompt");

      // Matikan Footer Sticky Lama (PENTING untuk desain baru)
      const oldFooter = document.getElementById('rekap-footer');
      if (oldFooter) oldFooter.style.display = 'none';

      // Reset Progress Bar
      updateProgressBar(33);

      loadingEl.style.display = "block";
      contentEl.style.display = "none";
      existsEl.style.display = "none";

      const lapakId = AppState.currentUser.user_info.lapak_id;

      if (!lapakId) {
        loadingEl.style.display = 'none';
        contentEl.style.display = 'none'; // Sembunyikan konten jika belum ada lapak
        alert("Anda belum ditugaskan ke lapak manapun.");
        return;
      }

      // Reset tabel jika ada sisa data lama di DOM
      initialPrompt.style.display = "block";
      document.getElementById("product-search-container").style.display = "none";

      try {
        const resp = await fetch(`/api/get_data_buat_catatan/${lapakId}`);
        if (!resp.ok) {
          const result = await resp.json();
          if (resp.status === 409 && result.already_exists) {
            existsEl.style.display = "block";
            loadingEl.style.display = "none";
          } else {
            throw new Error(result.message);
          }
        } else {
          const result = await resp.json();
          AppState.masterData.suppliers = result.data;
          AppState.masterData.products = result.data.flatMap(supplier =>
            supplier.products.map(product => ({ ...product, supplier_id: supplier.id }))
          );

          contentEl.style.display = "block";
          loadingEl.style.display = "none";

          // Cek apakah ada data tersimpan
          loadReportStateFromLocalStorage();
        }
      } catch (error) {
        loadingEl.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
      }
    }

    // Fungsi Helper Baru untuk Progress Bar
    function updateProgressBar(percent) {
      const bar = document.getElementById('report-progress');
      if (bar) {
        bar.style.width = percent + "%";
        if (percent >= 100) {
          bar.classList.add('bg-success');
          bar.classList.remove('bg-primary');
        } else {
          bar.classList.add('bg-primary');
          bar.classList.remove('bg-success');
        }
      }
    }

    function updateRowAndTotals(row) {
      const awal = parseInt(row.querySelector(".stok-awal").value) || 0;
      let akhirInput = row.querySelector(".stok-akhir");
      let akhir = parseInt(akhirInput.value) || 0;
      if (akhir > awal) { akhir = awal; akhirInput.value = awal; }
      const terjual = awal - akhir;
      row.querySelector(".terjual-pcs").textContent = terjual;
      updateSummarySection(); // Panggil update ringkasan
      saveReportStateToLocalStorage();
    }

    function updateSummarySection() {
      const summaryPlaceholder = document.getElementById("summary-placeholder");
      // const summaryContent = document.getElementById("summary-content"); // Tidak perlu dimanipulasi display-nya

      // Tampilkan loading kecil jika perlu, atau biarkan saja
      if (summaryPlaceholder) summaryPlaceholder.style.display = 'block';

      let totalTerjual = 0, totalPendapatan = 0, totalBiaya = 0, totalKeuntungan = 0;
      let supplierTotals = {};

      document.querySelectorAll(".product-row").forEach(row => {
        const stokAwal = parseInt(row.querySelector(".stok-awal").value) || 0;
        const stokAkhir = parseInt(row.querySelector(".stok-akhir").value) || 0;

        // Hitung terjual (pastikan tidak negatif)
        let terjual = stokAwal - stokAkhir;
        if (terjual < 0) terjual = 0;

        // Update teks terjual di baris tersebut
        const terjualEl = row.querySelector('.terjual-pcs');
        if (terjualEl) terjualEl.textContent = terjual;

        const hargaJual = parseFloat(row.dataset.hargaJual) || 0;
        const hargaBeli = parseFloat(row.dataset.hargaBeli) || 0;

        const pendapatanRow = terjual * hargaJual;
        const biayaRow = terjual * hargaBeli;

        totalTerjual += terjual;
        totalPendapatan += pendapatanRow;
        totalBiaya += biayaRow;

        // Hitung total per supplier untuk footer tabel kecil
        const supplierGroup = row.closest("[id^='supplier-group-']");
        if (supplierGroup) {
          const supplierId = supplierGroup.id;
          if (!supplierTotals[supplierId]) {
            supplierTotals[supplierId] = { awal: 0, akhir: 0 };
          }
          supplierTotals[supplierId].awal += stokAwal;
          supplierTotals[supplierId].akhir += stokAkhir;
        }
      });

      totalKeuntungan = totalPendapatan - totalBiaya;

      // Update Footer per Supplier (Hanya Total Stok Awal & Akhir agar muat di HP)
      for (const supplierId in supplierTotals) {
        const groupElement = document.getElementById(supplierId);
        if (groupElement) {
          const totals = supplierTotals[supplierId];
          const awalEl = groupElement.querySelector('.supplier-total-awal');
          const akhirEl = groupElement.querySelector('.supplier-total-akhir');

          if (awalEl) awalEl.textContent = totals.awal;
          if (akhirEl) akhirEl.textContent = totals.akhir;
        }
      }

      // Update Data Tersembunyi (untuk Langkah 3)
      const elTerjual = document.getElementById("summary-total-terjual");
      const elPendapatan = document.getElementById("summary-total-pendapatan");
      const elBiaya = document.getElementById("summary-total-biaya");
      const elKeuntungan = document.getElementById("summary-total-keuntungan");
      const elTotalSistem = document.getElementById("total-sistem");

      if (elTerjual) elTerjual.textContent = `${totalTerjual} Pcs`;
      if (elPendapatan) elPendapatan.textContent = formatCurrency(totalPendapatan);
      if (elBiaya) elBiaya.textContent = formatCurrency(totalBiaya);
      if (elKeuntungan) elKeuntungan.textContent = formatCurrency(totalKeuntungan);

      // Update Tampilan "Langkah 3"
      if (elTotalSistem) elTotalSistem.textContent = formatCurrency(totalPendapatan);

      // Update Total Manual (Input User)
      const qris = parseFloat(document.getElementById("rekap-qris").value.replace(/\D/g, '')) || 0;
      const bca = parseFloat(document.getElementById("rekap-bca").value.replace(/\D/g, '')) || 0;
      const cash = parseFloat(document.getElementById("rekap-cash").value.replace(/\D/g, '')) || 0;
      const totalManual = qris + bca + cash;

      const elTotalManual = document.getElementById("total-manual");
      if (elTotalManual) elTotalManual.textContent = formatCurrency(totalManual);

      checkReconciliation(totalPendapatan, totalManual);

      // PERBAIKAN UTAMA: Jangan ubah display summaryContent jadi block
      // Kita hanya sembunyikan placeholder loading
      if (summaryPlaceholder) {
        setTimeout(() => {
          summaryPlaceholder.style.display = 'none';
        }, 200);
      }
    }

    function checkReconciliation(totalSistem, totalManual) {
      const warningEl = document.getElementById("reconciliation-warning");
      const submitBtn = document.getElementById("kirim-laporan-btn");

      // Toleransi desimal kecil
      const isMatched = Math.abs(totalSistem - totalManual) < 100; // Toleransi Rp 100 perak

      // Update UI Text
      document.getElementById("total-sistem").textContent = formatCurrency(totalSistem);
      document.getElementById("total-manual").textContent = formatCurrency(totalManual);

      if (totalSistem > 0 && isMatched) {
        // KONDISI SIAP KIRIM
        warningEl.style.display = "none";
        submitBtn.disabled = false;
        submitBtn.classList.remove("btn-secondary");
        submitBtn.classList.add("btn-success");
        submitBtn.innerHTML = '<i class="bi bi-send-fill me-2"></i> Kirim Laporan Sekarang';

        updateProgressBar(100); // Langkah 3 Selesai
      } else {
        // KONDISI BELUM SESUAI
        submitBtn.disabled = true;
        submitBtn.classList.add("btn-secondary");
        submitBtn.classList.remove("btn-success");

        if (totalSistem === 0) {
          submitBtn.innerHTML = '<i class="bi bi-lock-fill me-2"></i> Lengkapi Data Dulu';
          warningEl.style.display = "none";
          updateProgressBar(33); // Masih di awal
        } else {
          submitBtn.innerHTML = '<i class="bi bi-exclamation-circle-fill me-2"></i> Perbaiki Input Manual';
          warningEl.style.display = "block";
          warningEl.innerHTML = `<i class="bi bi-exclamation-triangle-fill me-1"></i> Selisih: ${formatCurrency(totalManual - totalSistem)}`;
          updateProgressBar(66); // Masih di tahap input
        }
      }
    }

    function attachAllEventListeners() {
      // Fungsi ini sekarang hanya bertanggung jawab untuk event listener di dalam tabel
      document.querySelectorAll(".product-row").forEach((row) => {
        attachEventListenersToRow(row);
      });

      // Listener untuk input pencarian tabel utama
      const mainSearchInput = document.getElementById('main-report-search-input');
      if (mainSearchInput) {
        mainSearchInput.addEventListener('input', filterMainReportTable);
      }
    }

    // (Letakkan ini setelah fungsi checkReconciliation)

    // FUNGSI BARU 1: Untuk menyimpan keadaan tabel ke localStorage
    function saveReportStateToLocalStorage() {
      if (!AppState.currentUser || AppState.currentUser.role !== 'lapak') return;

      const reportData = [];
      document.querySelectorAll(".product-row").forEach(row => {
        reportData.push({
          productId: parseInt(row.dataset.productId),
          stokAwal: parseInt(row.querySelector(".stok-awal").value) || 0,
          stokAkhir: parseInt(row.querySelector(".stok-akhir").value) || 0
        });
      });

      const storageKey = `reportState_${AppState.currentUser.user_info.lapak_id}`;
      localStorage.setItem(storageKey, JSON.stringify(reportData));
    }

    function loadReportStateFromLocalStorage() {
      if (!AppState.currentUser || AppState.currentUser.role !== 'lapak') return;

      const storageKey = `reportState_${AppState.currentUser.user_info.lapak_id}`;
      const savedData = JSON.parse(localStorage.getItem(storageKey) || '[]');

      if (savedData.length === 0) return;

      const container = document.getElementById("report-tables-container");
      const summaryContainer = document.getElementById("report-summary-container");

      // Hapus "initial-prompt" jika ada
      const initialPrompt = document.getElementById("initial-prompt");
      if (initialPrompt) initialPrompt.style.display = 'none';

      container.innerHTML = ''; // Kosongkan container sebelum membangun

      savedData.forEach(item => {
        const product = AppState.masterData.products.find(p => p.id === item.productId);
        const supplier = AppState.masterData.suppliers.find(s => s.id === product.supplier_id);

        if (product && supplier) {
          const supplierGroupId = `supplier-group-${supplier.id}`;
          let supplierGroup = document.getElementById(supplierGroupId);

          // Jika grup supplier belum ada, buat dulu (VERSI MOBILE)
          if (!supplierGroup) {
            const newGroup = document.createElement('div');
            newGroup.id = supplierGroupId;
            newGroup.className = 'mb-4 border rounded p-2 bg-white shadow-sm';
            const paymentMethod = supplier.metode_pembayaran ? `<span class="badge bg-info ms-2">${supplier.metode_pembayaran}</span>` : '';

            newGroup.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
              <h6 class="mb-0 fw-bold text-primary">${supplier.name}</h6>
              ${paymentMethod}
          </div>
          <div class="table-responsive">
              <table class="table table-borderless align-middle mb-0">
                  <thead class="table-light small text-muted">
                      <tr>
                          <th>Produk</th> 
                          <th class="text-center" style="width: 50px;">Awal</th>
                          <th class="text-center" style="min-width: 120px;">Akhir</th>
                          <th style="width: 30px;"></th> 
                      </tr>
                  </thead>
                  <tbody></tbody>
                  <tfoot style="border-top: 1px solid #dee2e6;">
                    <tr class="fw-bold small">
                      <td class="text-end text-muted">Total:</td>
                      <td class="text-center supplier-total-awal">0</td>
                      <td class="text-center supplier-total-akhir">0</td>
                      <td></td>
                    </tr>
                  </tfoot>
              </table>
          </div>
        `;
            container.appendChild(newGroup);
            supplierGroup = newGroup;
          }

          const tableBody = supplierGroup.querySelector('tbody');
          let rowHtml = createProductRow(product, supplier);
          const tempTbody = document.createElement('tbody');
          tempTbody.innerHTML = rowHtml;
          const newRow = tempTbody.querySelector('tr');

          if (newRow) {
            newRow.querySelector('.stok-awal').value = item.stokAwal;
            newRow.querySelector('.stok-akhir').value = item.stokAkhir;
            tableBody.appendChild(newRow);
            attachEventListenersToRow(newRow);
          }
        }
      });

      summaryContainer.style.display = 'block';
      document.getElementById("product-search-container").style.display = 'block';
      updateSummarySection();

      // Set progress bar ke tahap 2 jika ada data tersimpan
      updateProgressBar(66);
      showToast("Sesi laporan sebelumnya berhasil dipulihkan.", true);
    }

    async function handleNotifySupplier(button) {
      const row = button.closest('tr');
      const productId = row.dataset.productId;
      const lapakId = AppState.currentUser.user_info.lapak_id;

      if (!confirm("Kirim notifikasi stok habis ke supplier?")) return;

      button.disabled = true;
      button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

      try {
        const resp = await fetch('/api/notify_supplier', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ product_id: productId, lapak_id: lapakId })
        });
        const result = await resp.json();
        showToast(result.message, result.success);

        if (result.success) {
          button.classList.remove('btn-outline-warning');
          button.classList.add('btn-success');
          button.innerHTML = '<i class="bi bi-check-lg"></i> Terkirim';
        } else {
          // Jika gagal, kembalikan tombol ke keadaan semula
          button.disabled = false;
          button.innerHTML = '<i class="bi bi-bell-fill"></i> Stok Habis';
        }
      } catch (error) {
        showToast('Gagal terhubung ke server.', false);
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-bell-fill"></i> Stok Habis';
      }
    }



    // GANTI FUNGSI LAMA DENGAN VERSI BARU INI
    function attachEventListenersToRow(row) {
      // Event listener untuk input angka manual (ini sudah benar)
      row.querySelectorAll(".stok-akhir").forEach((input) => {
        input.addEventListener("input", () => updateRowAndTotals(row));
      });

      // Logika untuk tombol spinner (ini juga sudah benar)
      const parentDiv = row.querySelector('.stok-akhir')?.closest('div');
      if (parentDiv) {
        const plusBtn = parentDiv.querySelector('.btn-plus');
        const minusBtn = parentDiv.querySelector('.btn-minus');
        const input = parentDiv.querySelector(".stok-akhir");

        if (plusBtn) {
          plusBtn.addEventListener("click", () => {
            let currentValue = parseInt(input.value) || 0;
            currentValue++;
            input.value = currentValue;
            input.dispatchEvent(new Event("input")); // Picu kalkulasi ulang
          });
        }

        if (minusBtn) {
          minusBtn.addEventListener("click", () => {
            let currentValue = parseInt(input.value) || 0;
            currentValue = Math.max(0, currentValue - 1);
            input.value = currentValue;
            input.dispatchEvent(new Event("input")); // Picu kalkulasi ulang
          });
        }
      }

      const notifyBtn = row.querySelector('.notify-btn');
      if (notifyBtn) {
        notifyBtn.addEventListener('click', () => handleNotifySupplier(notifyBtn));
      }

    }

    function filterMainReportTable(e) {
      const searchTerm = e.target.value.toLowerCase();

      // Loop melalui setiap grup supplier
      document.querySelectorAll("[id^='supplier-group-']").forEach(group => {
        const supplierName = group.querySelector('h5').textContent.toLowerCase();
        const productRows = group.querySelectorAll('.product-row');
        let groupHasVisibleRows = false;

        // Loop melalui setiap baris produk di dalam grup
        productRows.forEach(row => {
          const productName = row.querySelector('.product-supplier-info strong').textContent.toLowerCase();

          // Sebuah baris akan terlihat jika nama produk ATAU nama suppliernya cocok
          const isVisible = productName.includes(searchTerm) || supplierName.includes(searchTerm);

          row.style.display = isVisible ? "" : "none"; // Tampilkan atau sembunyikan baris ini

          if (isVisible) {
            groupHasVisibleRows = true; // Tandai bahwa grup ini punya setidaknya satu baris yang terlihat
          }
        });

        // Setelah semua baris diperiksa, tentukan apakah seluruh grup (termasuk judulnya) perlu ditampilkan
        group.style.display = groupHasVisibleRows ? 'block' : 'none';
      });
    }

    async function handleKirimLaporan() {
      if (!confirm("Kirim laporan ini? Laporan yang sudah dikirim tidak bisa diubah.")) return;

      const productData = [];
      document.querySelectorAll(".product-row").forEach((row) => {
        const stokAwal = row.querySelector(".stok-awal").value;
        const stokAkhir = row.querySelector(".stok-akhir").value;
        // Hanya kirim data yang diisi
        if (stokAwal > 0 || stokAkhir > 0) {
          productData.push({
            id: parseInt(row.dataset.productId),
            stok_awal: parseInt(stokAwal) || 0,
            stok_akhir: parseInt(stokAkhir) || 0,
          });
        }
      });

      if (productData.length === 0) return showToast("Tidak ada data penjualan.", false);

      const rekapData = {
        qris: document.getElementById("rekap-qris").value.replace(/\D/g, '') || '0',
        bca: document.getElementById("rekap-bca").value.replace(/\D/g, '') || '0',
        cash: document.getElementById("rekap-cash").value.replace(/\D/g, '') || '0',
        total: document.getElementById("total-manual").textContent.replace(/\D/g, "") || '0',
      };

      const payload = {
        lapak_id: AppState.currentUser.user_info.lapak_id,
        products: productData,
        rekap_pembayaran: rekapData,
      };

      const submitBtn = document.getElementById("kirim-laporan-btn");
      const originalBtnHTML = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Mengirim...`;

      try {
        const response = await fetch("/api/submit_catatan_harian", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const result = await response.json();
        showToast(result.message, response.ok);
        if (response.ok) {
          // Bersihkan localStorage setelah pengiriman berhasil
          const storageKey = `reportState_${AppState.currentUser.user_info.lapak_id}`;
          localStorage.removeItem(storageKey);
          // Muat ulang dashboard untuk menampilkan status terbaru
          await populateLapakDashboard();
        }
      } catch (e) {
        showToast("Gagal terhubung ke server.", false);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnHTML;
      }
    }
    async function populateHistoryLaporanPage() {
      const loadingEl = document.getElementById("history-loading");
      const listEl = document.getElementById("history-list");

      loadingEl.style.display = "block";
      listEl.innerHTML = ""; // Bersihkan konten lama

      try {
        const lapakId = AppState.currentUser.user_info.lapak_id;
        // Kita panggil API yang sama, asumsinya API ini sudah mengembalikan detail 'rincian_produk'
        // Jika API backend Anda belum mengirim detail produk di endpoint ini, 
        // Anda mungkin perlu menyesuaikan backend atau memanggil API detail per item.
        // TAPI, berdasarkan kode 'get_report_details' Anda sebelumnya, data rincian biasanya ada.

        // *Catatan: Untuk solusi frontend ini, saya berasumsi API '/api/get_history_laporan' 
        // dimodifikasi sedikit di backend untuk menyertakan 'rincian_produk', 
        // ATAU kita harus fetch detail satu per satu (kurang efisien tapi bisa).*

        // Mari kita gunakan pendekatan fetch list dulu, lalu saat user klik "Detail",
        // kita bisa fetch detailnya (Lazy Loading) agar aplikasi cepat. 
        // TAPI untuk sekarang, saya buat agar struktur UI-nya siap menerima data detail.

        const resp = await fetch(`/api/get_history_laporan/${lapakId}`);

        if (!resp.ok) throw new Error("Gagal mengambil data history.");

        const result = await resp.json();
        loadingEl.style.display = "none";

        if (result.reports.length === 0) {
          listEl.innerHTML = `
        <div class="text-center py-5">
          <i class="bi bi-clock-history text-muted" style="font-size: 3rem;"></i>
          <p class="mt-3 text-muted">Belum ada riwayat laporan.</p>
        </div>`;
          return;
        }

        // Render List
        listEl.innerHTML = result.reports.map((r, index) => {
          const isConfirmed = r.status === "Terkonfirmasi";
          const statusClass = isConfirmed ? "confirmed" : "pending";
          const statusBadge = isConfirmed
            ? `<span class="badge bg-success"><i class="bi bi-check-circle-fill me-1"></i>Diterima Owner</span>`
            : `<span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split me-1"></i>Menunggu</span>`;

          const dateString = new Date(r.tanggal).toLocaleDateString("id-ID", {
            weekday: "long", year: "numeric", month: "long", day: "numeric"
          });

          // Kita butuh tombol untuk memuat detail jika data detail belum ada di list awal
          // ID unik untuk collapse
          const collapseId = `history-collapse-${r.id}`;

          return `
        <div class="card history-card ${statusClass} mb-3 border-0 shadow-sm">
          <div class="history-header d-flex justify-content-between align-items-center" 
               data-bs-toggle="collapse" 
               data-bs-target="#${collapseId}" 
               aria-expanded="false" 
               onclick="loadHistoryDetail(${r.id}, '${collapseId}')">
            
            <div class="d-flex align-items-center flex-grow-1">
              <div class="me-3 text-center">
                 <div class="fw-bold text-secondary" style="font-size: 0.8rem; text-transform:uppercase;">${new Date(r.tanggal).toLocaleDateString('id-ID', { month: 'short' })}</div>
                 <div class="display-6 fw-bold text-dark" style="line-height: 1;">${new Date(r.tanggal).getDate()}</div>
              </div>
              
              <div class="border-start ps-3">
                <h6 class="mb-1 fw-bold text-primary">Laporan #${r.id}</h6>
                <div class="small text-muted mb-1">Total Pendapatan: <span class="fw-bold text-dark">${formatCurrency(r.total_pendapatan)}</span></div>
                ${statusBadge}
              </div>
            </div>

            <div class="text-muted">
               <i class="bi bi-chevron-down"></i>
            </div>
          </div>

          <div id="${collapseId}" class="collapse">
            <div class="card-body border-top bg-light p-3">
              <div id="detail-container-${r.id}" class="text-center py-3">
                 <div class="spinner-border spinner-border-sm text-primary"></div>
                 <span class="small ms-2">Memuat rincian produk...</span>
              </div>
            </div>
          </div>
        </div>
      `;
        }).join("");

      } catch (error) {
        loadingEl.innerHTML = `<div class="alert alert-danger">Gagal memuat history: ${error.message}</div>`;
      }
    }

    // Cache sederhana agar tidak fetch ulang data yang sudah dibuka
    const historyDetailCache = {};

    async function loadHistoryDetail(reportId, containerId) {
      const container = document.querySelector(`#${containerId} #detail-container-${reportId}`);

      // Jika konten sudah ada (bukan spinner loading), jangan fetch lagi
      if (!container || container.querySelector('table')) return;

      try {
        // Cek cache dulu
        let data;
        if (historyDetailCache[reportId]) {
          data = historyDetailCache[reportId];
        } else {
          // Panggil API get_report_details yang SUDAH ADA di backend Anda
          const resp = await fetch(`/api/get_report_details/${reportId}`);
          const result = await resp.json();
          if (!result.success) throw new Error(result.message);
          data = result.data;
          historyDetailCache[reportId] = data; // Simpan ke cache
        }

        // Bangun HTML Detail
        let htmlContent = '';

        // Info Ringkas Tambahan
        htmlContent += `
      <div class="row g-2 mb-3 small">
        <div class="col-6">
          <div class="p-2 bg-white border rounded">
            <span class="text-muted d-block">Terjual (Pcs)</span>
            <span class="fw-bold">${data.rekap_otomatis.total_produk_terjual} item</span>
          </div>
        </div>
        <div class="col-6">
          <div class="p-2 bg-white border rounded">
            <span class="text-muted d-block">Biaya Modal (HPP)</span>
            <span class="fw-bold text-danger">${formatCurrency(data.rekap_otomatis.total_biaya_supplier)}</span>
          </div>
        </div>
      </div>
    `;

        // Tabel Rincian Produk
        htmlContent += `
      <div class="table-responsive bg-white border rounded">
        <table class="table table-sm table-hover mb-0 history-detail-table">
          <thead class="table-light">
            <tr>
              <th class="ps-3">Produk / Supplier</th>
              <th class="text-center">Stok</th>
              <th class="text-center">Terjual</th>
              <th class="text-end pe-3">Omzet</th>
            </tr>
          </thead>
          <tbody>
    `;

        // Loop data per supplier
        const suppliers = Object.keys(data.rincian_per_supplier);
        if (suppliers.length === 0) {
          htmlContent += `<tr><td colspan="4" class="text-center p-3">Tidak ada data produk.</td></tr>`;
        } else {
          suppliers.forEach(supplierName => {
            const products = data.rincian_per_supplier[supplierName];

            products.forEach(p => {
              htmlContent += `
            <tr>
              <td class="ps-3 py-2">
                <div class="fw-bold text-dark">${p.nama_produk}</div>
                <div class="d-flex align-items-center mt-1">
                  <span class="badge-supplier me-2"><i class="bi bi-box-seam me-1"></i>${supplierName}</span>
                </div>
              </td>
              <td class="text-center small">
                <div class="text-muted">Aw: ${p.stok_awal}</div>
                <div class="text-dark fw-bold">Ak: ${p.stok_akhir}</div>
              </td>
              <td class="text-center fw-bold text-primary">${p.terjual}</td>
              <td class="text-end pe-3">
                <div class="fw-bold">${formatCurrency(p.total_pendapatan)}</div>
                <div class="small text-muted" style="font-size: 0.75rem;">Modal: ${formatCurrency(p.total_biaya || (p.total_pendapatan - p.keuntungan_bersih))}</div>
              </td>
            </tr>
          `;
            });
          });
        }

        htmlContent += `
          </tbody>
        </table>
      </div>
      
      <div class="mt-3 text-end">
         <button class="btn btn-sm btn-outline-danger" onclick="showReportDetails(${reportId})">
            <i class="bi bi-file-earmark-pdf-fill me-1"></i> Lihat Invoice / PDF
         </button>
      </div>
    `;

        // Render ke dalam container
        container.innerHTML = htmlContent;
        container.className = ""; // Hapus class text-center py-3

      } catch (e) {
        container.innerHTML = `<div class="alert alert-warning small"><i class="bi bi-exclamation-triangle me-1"></i> Gagal memuat rincian: ${e.message}</div>`;
      }
    }

    async function populateSupplierDashboard() {
      try {
        const supplierId = AppState.currentUser.user_info.supplier_id;
        const resp = await fetch(`/api/get_data_supplier/${supplierId}`);
        if (!resp.ok) throw new Error("Gagal mengambil data dashboard supplier");
        const result = await resp.json();
        if (result.success) {
          document.getElementById("supplier-total-tagihan").textContent = formatCurrency(result.summary.total_tagihan);
          document.getElementById("supplier-penjualan-bulan-ini").textContent = formatCurrency(result.summary.penjualan_bulan_ini);
        } else { throw new Error(result.message); }

        // PERUBAHAN DI SINI: Panggil fungsi untuk memuat notifikasi
        await populateNotifications();

      } catch (error) {
        showToast(error.message || "Gagal memuat data dashboard.", false);
      }
    }
    async function populateSupplierHistoryPage() {
      const loadingEl = document.getElementById('supplier-history-loading'),
        contentEl = document.getElementById('supplier-history-content'),
        salesBody = document.getElementById('supplier-sales-history-body'),
        paymentsBody = document.getElementById('supplier-payment-history-body'),
        lapakSelect = document.getElementById('supplier-history-lapak-filter');

      loadingEl.style.display = 'block';
      contentEl.style.display = 'none';

      // Ambil semua nilai dari filter
      const startDate = document.getElementById('supplier-history-start-date').value;
      const endDate = document.getElementById('supplier-history-end-date').value;
      const lapakId = lapakSelect.value;

      const params = new URLSearchParams();
      if (startDate) params.append('start_date', startDate);
      if (endDate) params.append('end_date', endDate);
      if (lapakId) params.append('lapak_id', lapakId); // Tambahkan lapak_id ke parameter
      const queryString = params.toString();

      try {
        const apiUrl = `/api/get_supplier_history/${AppState.currentUser.user_info.supplier_id}?${queryString}`;
        const resp = await fetch(apiUrl);
        const result = await resp.json();

        if (!result.success) throw new Error(result.message);

        // --- PERUBAHAN DI SINI: Mengisi dropdown lapak saat pertama kali dijalankan ---
        if (lapakSelect.options.length <= 1) { // Cek agar tidak diisi berulang kali
          if (result.lapaks) {
            result.lapaks.forEach(l => {
              lapakSelect.innerHTML += `<option value="${l.id}">${l.lokasi}</option>`;
            });
          }
        }

        // Bagian untuk mengisi tabel pembayaran (tidak berubah)
        if (result.payments.length === 0) {
          paymentsBody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">Belum ada pembayaran.</td></tr>`;
        } else {
          paymentsBody.innerHTML = result.payments.map(p => `
                    <tr>
                        <td>${new Date(p.tanggal + 'T00:00:00').toLocaleDateString('id-ID')}</td>
                        <td>${formatCurrency(p.jumlah)}</td>
                        <td><span class="badge bg-info">${p.metode}</span></td>
                    </tr>`).join('');
        }

        // Bagian untuk mengisi tabel penjualan (tidak berubah)
        if (result.sales.length === 0) {
          salesBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Belum ada penjualan.</td></tr>`;
        } else {
          salesBody.innerHTML = result.sales.map(s => `
                    <tr>
                        <td>${new Date(s.tanggal + 'T00:00:00').toLocaleDateString('id-ID')}</td>
                        <td>${s.lokasi}</td>
                        <td>${s.nama_produk}</td>
                        <td>${s.terjual} Pcs</td>
                    </tr>`).join('');
        }

        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';
      } catch (e) {
        loadingEl.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
      }
    }

    async function populateNotifications() {
      const container = document.getElementById("notification-list-container");

      // Tampilkan loading state yang lebih rapi
      container.innerHTML = `
    <div class="list-group-item text-center p-4 border-0 bg-transparent">
       <div class="spinner-border text-primary" role="status"></div>
       <p class="mt-2 text-muted small">Memuat update stok...</p>
    </div>`;

      try {
        const supplierId = AppState.currentUser.user_info.supplier_id;
        const resp = await fetch(`/api/get_supplier_notifications/${supplierId}`);
        const result = await resp.json();
        if (!result.success) throw new Error(result.message);

        if (result.notifications.length === 0) {
          container.innerHTML = `
        <div class="text-center py-5 text-muted">
           <i class="bi bi-check-circle display-4 text-success opacity-50"></i>
           <p class="mt-3">Aman! Stok di semua lapak tersedia.</p>
        </div>`;
          updateNotificationBadge();
          return;
        }

        // Render List
        container.innerHTML = result.notifications.map(n => {
          // Style untuk notifikasi baru vs lama
          const itemClass = n.status === 'baru' ? 'notification-new' : '';
          const btnDisabled = n.status === 'dibaca' ? 'disabled' : '';
          const btnClass = n.status === 'dibaca' ? 'btn-outline-secondary' : 'btn-outline-success';

          return `
        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-start py-3 ${itemClass}" id="notif-${n.id}">
          <div class="me-3">
            <div class="mb-1">
              Produk <strong>${n.product_name}</strong> habis di <strong class="text-primary">${n.lapak_name}</strong>.
            </div>
            <small class="text-muted">
              <i class="bi bi-clock"></i> ${new Date(n.time).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })} 
              <span class="mx-1"></span> 
              ${new Date(n.time).toLocaleDateString('id-ID')}
            </small>
          </div>
          
          <div class="btn-group-vertical btn-group-sm">
             <button class="btn ${btnClass}" onclick="markNotificationAsRead(${n.id}, this)" ${btnDisabled} title="Tandai Sudah Dibaca">
               <i class="bi bi-check2"></i>
             </button>
             <button class="btn btn-outline-danger" onclick="archiveNotification(${n.id})" title="Arsipkan">
               <i class="bi bi-archive-fill"></i>
             </button>
          </div>
        </div>
      `;
        }).join('');

        updateNotificationBadge();
      } catch (e) {
        container.innerHTML = `<div class="alert alert-danger m-3">Gagal memuat: ${e.message}</div>`;
      }
    }

    async function updateNotificationStatus(id, status) {
      try {
        const resp = await fetch(`/api/update_notification_status/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: status })
        });
        return await resp.json();
      } catch (e) {
        return { success: false, message: 'Gagal terhubung ke server.' };
      }
    }

    // FUNGSI BARU 2: Aksi saat tombol "Baca" diklik
    async function markNotificationAsRead(id, buttonElement) {
      const result = await updateNotificationStatus(id, 'dibaca');
      if (result.success) {
        const notifItem = document.getElementById(`notif-${id}`);
        notifItem.classList.remove('list-group-item-warning');
        buttonElement.disabled = true;
        updateNotificationBadge();
      }
      showToast(result.message, result.success);
    }

    // FUNGSI BARU 3: Aksi saat tombol "Arsip" diklik
    async function archiveNotification(id) {
      if (!confirm("Arsipkan notifikasi ini? Notifikasi akan hilang dari daftar.")) return;
      const result = await updateNotificationStatus(id, 'diarsipkan');
      if (result.success) {
        document.getElementById(`notif-${id}`).remove();
        updateNotificationBadge();
      }
      showToast(result.message, result.success);
    }

    // FUNGSI BARU 4: Untuk menghitung ulang badge notifikasi
    function updateNotificationBadge() {
      const badge = document.getElementById("notification-badge");
      if (!badge) return; // Jika badge tidak ditemukan, hentikan fungsi (jangan error)
      const newNotificationCount = document.querySelectorAll('.list-group-item-warning').length;
      if (newNotificationCount > 0) {
        badge.textContent = newNotificationCount;
        badge.style.display = 'block';
      } else {
        badge.style.display = 'none';
      }
    }

    async function populateArchivedNotifications() {
      const container = document.getElementById("archived-notification-list-container");
      container.innerHTML = `<div class="list-group-item text-center p-4"><div class="spinner-border spinner-border-sm"></div></div>`;

      try {
        const supplierId = AppState.currentUser.user_info.supplier_id;
        const resp = await fetch(`/api/get_archived_notifications/${supplierId}`);
        const result = await resp.json();

        if (!result.success) throw new Error(result.message);

        if (result.notifications.length === 0) {
          container.innerHTML = `<div class="list-group-item text-center text-muted p-4">Arsip notifikasi kosong.</div>`;
          return;
        }

        container.innerHTML = result.notifications.map(n => `
            <div class="list-group-item d-flex justify-content-between align-items-center" id="archived-notif-${n.id}">
                <div>
                    Produk <strong>${n.product_name}</strong> habis di <strong>${n.lapak_name}</strong>.
                    <small class="d-block text-muted">Diarsipkan pada ${new Date(n.time).toLocaleString('id-ID')}</small>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="unarchiveNotification(${n.id})">
                    <i class="bi bi-box-arrow-up"></i> Pulihkan
                </button>
            </div>
          `).join('');

      } catch (e) {
        container.innerHTML = `<div class="list-group-item text-center text-danger p-4">Gagal memuat arsip: ${e.message}</div>`;
      }
    }

    // FUNGSI BARU 2: Aksi saat tombol "Pulihkan" diklik
    async function unarchiveNotification(id) {
      const result = await updateNotificationStatus(id, 'baru'); // Kembalikan statusnya ke 'baru'
      if (result.success) {
        showPage('supplier-dashboard'); // Kembali ke dashboard untuk melihat notifikasi yang dipulihkan
      }
      showToast(result.message, result.success);
    }

    // --- Fungsi Baru untuk Menampilkan Modal ---
    async function showSupplierBillDetails() {
      const loadingEl = document.getElementById('supplier-bill-loading');
      const contentEl = document.getElementById('supplier-bill-content');
      const emptyEl = document.getElementById('supplier-bill-empty');
      const tableBody = document.getElementById('supplier-bill-table-body');
      const totalEl = document.getElementById('modal-total-bill');

      // 1. Reset tampilan modal
      loadingEl.style.display = 'block';
      contentEl.style.display = 'none';
      emptyEl.style.display = 'none';
      tableBody.innerHTML = '';

      // 2. Buka Modal
      modals.supplierBillDetail.show();

      try {
        const supplierId = AppState.currentUser.user_info.supplier_id;

        // PENTING: Anda perlu memastikan endpoint backend ini tersedia di Flask
        // Endpoint ini harus mengembalikan list tagihan yang statusnya belum lunas
        const resp = await fetch(`/api/get_supplier_unpaid_details/${supplierId}`);
        const result = await resp.json();

        if (!result.success) throw new Error(result.message);

        if (result.details.length === 0) {
          loadingEl.style.display = 'none';
          emptyEl.style.display = 'block';
        } else {
          let totalAmount = 0;

          // 3. Render Baris Tabel
          const rows = result.details.map(item => {
            totalAmount += item.nominal;

            // Format Tanggal
            const dateObj = new Date(item.tanggal);
            const dateStr = dateObj.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });

            return `
          <tr>
            <td class="ps-3 py-3">
              <div class="fw-bold text-dark">${item.lapak_name}</div>
              <small class="text-muted"><i class="bi bi-calendar-event"></i> ${dateStr}</small>
              ${item.produk ? `<br><small class="text-info">${item.produk}</small>` : ''}
            </td>
            <td class="text-end pe-3 fw-bold text-primary">
              ${formatCurrency(item.nominal)}
            </td>
          </tr>
        `;
          }).join('');

          tableBody.innerHTML = rows;
          totalEl.textContent = formatCurrency(totalAmount);

          loadingEl.style.display = 'none';
          contentEl.style.display = 'block';
        }

      } catch (error) {
        console.error(error);
        loadingEl.innerHTML = `<div class="alert alert-danger m-3">Gagal memuat data: ${error.message}</div>`;
      }
    }

    async function populateSuperownerDashboard() {
      const loadingEl = document.getElementById('superowner-loading');
      const contentEl = document.getElementById('superowner-content');
      const totalSaldoEl = document.getElementById('superowner-total-saldo');
      const profitBulanIniEl = document.getElementById('superowner-profit-bulan-ini');
      const ownerTerprofitEl = document.getElementById('superowner-owner-terprofit');
      const totalOwnerEl = document.getElementById('superowner-total-owner'); // Elemen baru
      const listContainer = document.getElementById('superowner-owner-list-container'); // Container List

      loadingEl.style.display = 'block';
      contentEl.style.display = 'none';

      try {
        const superownerId = AppState.currentUser.user_info.id;
        const resp = await fetch(`/api/get_superowner_dashboard_data/${superownerId}`);
        const result = await resp.json();
        if (!result.success) throw new Error(result.message);

        // Isi Card KPI 2x2
        totalSaldoEl.textContent = formatCurrency(result.total_saldo);
        profitBulanIniEl.textContent = formatCurrency(result.kpi.profit_bulan_ini);
        ownerTerprofitEl.textContent = result.kpi.owner_terprofit || "-";

        // Hitung jumlah owner jika backend tidak menyediakan, atau ambil dari array length
        const ownerCount = result.rincian_per_owner ? result.rincian_per_owner.length : 0;
        if (totalOwnerEl) totalOwnerEl.textContent = ownerCount;

        // Isi List Group Rincian Owner (Tampilan Mobile)
        if (result.rincian_per_owner.length === 0) {
          listContainer.innerHTML = `<div class="list-group-item text-center text-muted p-4">Belum ada Owner yang terdaftar.</div>`;
        } else {
          listContainer.innerHTML = result.rincian_per_owner.map(owner => `
        <div class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-0 fw-bold">${owner.owner_name}</h6>
            <div class="small text-muted">Saldo Profit:</div>
            <strong class="text-success">${formatCurrency(owner.balance)}</strong>
          </div>
          <div class="btn-group-vertical">
             <button class="btn btn-sm btn-outline-info mb-1" onclick="openProfitDetailPage(${owner.owner_id}, '${owner.owner_name}')">
               <i class="bi bi-eye-fill"></i> Detail
             </button>
             <button class="btn btn-sm btn-success" onclick="openWithdrawModalForOwner(${owner.owner_id}, '${owner.owner_name}', ${owner.balance})" ${owner.balance <= 0 ? 'disabled' : ''}>
               <i class="bi bi-check-circle-fill"></i> Lunas
             </button>
          </div>
        </div>
      `).join('');
        }

        contentEl.style.display = 'block';
      } catch (e) {
        loadingEl.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
      } finally {
        loadingEl.style.display = 'none';
      }
    }

    // FUNGSI BARU 1: Untuk membuka halaman detail
    function openProfitDetailPage(ownerId, ownerName) {
      // Simpan data sementara untuk digunakan oleh fungsi berikutnya
      AppState.currentDetailOwner = { id: ownerId, name: ownerName };
      showPage('superowner-profit-detail-page');
    }

    // FUNGSI BARU 2: Untuk mengisi halaman detail
    // (Ganti seluruh fungsi populateSuperownerProfitDetails di index.html)
    async function populateSuperownerProfitDetails() {
      const loadingEl = document.getElementById('profit-detail-loading');
      const contentEl = document.getElementById('profit-detail-content');
      const tableBody = document.getElementById('profit-detail-table-body');
      const ownerNameEl = document.getElementById('detail-owner-name');

      const { id, name } = AppState.currentDetailOwner;
      ownerNameEl.textContent = name;

      loadingEl.style.display = 'block';
      contentEl.style.display = 'none';

      try {
        const resp = await fetch(`/api/get_superowner_profit_details/${id}`);
        const result = await resp.json();

        if (!result.success) throw new Error(result.message);

        // PERBAIKAN 1: Ganti colspan jadi 4
        if (result.history.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Belum ada riwayat profit dari owner ini.</td></tr>`;
        } else {
          // PERBAIKAN 2: Tambahkan tombol dan panggil FUNGSI BARU
          tableBody.innerHTML = result.history.map(item => `
          <tr>
            <td>${item.tanggal}</td>
            <td>${item.sumber}</td>
            <td class="text-end fw-bold text-success">${formatCurrency(item.profit)}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-info" onclick="showSuperOwnerProfitModal(${item.report_id})">
                <i class="bi bi-eye-fill"></i> Detail
              </button>
            </td>
          </tr>
        `).join('');
        }
        contentEl.style.display = 'block';
      } catch (e) {
        contentEl.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
      } finally {
        loadingEl.style.display = 'none';
      }
    }


    // (Tambahkan fungsi BARU ini di index.html, di bagian SUPEROWNER FUNCTIONS)

    async function showSuperOwnerProfitModal(reportId) {
      const container = document.getElementById("invoice-content");
      container.innerHTML = `<div class="text-center p-5"><div class="spinner-border"></div></div>`;
      modals.reportDetail.show(); // Kita tetap pakai modal yang sama

      try {
        // Panggil API BARU yang kita buat
        const resp = await fetch(`/api/get_superowner_report_profit_detail/${reportId}`);
        const result = await resp.json();
        if (!result.success) throw new Error(result.message);

        const data = result.data;

        // Ini adalah template HTML SEDERHANA (profit-only)
        container.innerHTML = `
      <table>
        <tr class="top">
          <td colspan="2">
            <table>
              <tr>
                <td class="title"><h4>Rincian Profit</h4></td>
                <td style="text-align: right;">
                  ID Laporan: #${data.id}<br>
                  Tanggal: ${data.tanggal}<br>
                  Status: ${data.status}
                </td>
              </tr>
            </table>
          </td>
        </tr>
        <tr class="information">
          <td colspan="2">
            <table>
              <tr><td>Lapak Sumber:<br><strong>${data.lokasi}</strong></td></tr>
            </table>
          </td>
        </tr>
        <tr class="heading">
          <td>Deskripsi Profit</td>
          <td style="text-align: right;">Jumlah</td>
        </tr>
        <tr class="item">
          <td>Profit untuk Owner</td>
          <td style="text-align: right;">${formatCurrency(data.keuntungan_owner)}</td>
        </tr>
        <tr class="item last">
          <td>Profit untuk SuperOwner</td>
          <td style="text-align: right;">${formatCurrency(data.keuntungan_superowner)}</td>
        </tr>
        <tr class="total">
          <td></td>
          <td style="text-align: right; border-top: 2px solid #eee; font-weight: bold;">
             <strong>Total: ${formatCurrency(data.keuntungan_owner + data.keuntungan_superowner)}</strong>
          </td>
        </tr>
      </table>
    `;
      } catch (e) {
        container.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
      }
    }
    // (Letakkan ini setelah fungsi populateSuperownerProfitDetails)

    // (Ganti fungsi 'openWithdrawModal' LAMA)
    function openWithdrawModalForOwner(ownerId, ownerName, balance) {
      document.getElementById('withdraw-owner-id').value = ownerId; // <-- Simpan ID
      document.getElementById('withdraw-owner-name-confirm').textContent = ownerName; // <-- Tampilkan Nama
      document.getElementById('withdraw-amount-confirm').textContent = formatCurrency(balance);
      modals.withdraw.show();
    }

    // (Ganti fungsi 'handleSuperownerWithdraw' LAMA)
    async function handleSuperownerWithdrawForOwner() {
      const superownerId = AppState.currentUser.user_info.id;
      const ownerId = document.getElementById('withdraw-owner-id').value; // <-- Ambil ID

      try {
        const resp = await fetch('/api/superowner_withdraw_from_owner', { // <-- Panggil API baru
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ superowner_id: superownerId, owner_id: ownerId }) // <-- Kirim kedua ID
        });
        const result = await resp.json();
        showToast(result.message, result.success);
        if (result.success) {
          modals.withdraw.hide();
          await populateSuperownerDashboard(); // Refresh dashboard
        }
      } catch (e) {
        showToast('Gagal terhubung ke server.', false);
      }
    }

    // GANTI FUNGSI LAMA DENGAN VERSI BARU INI
    async function populateSuperownerReports() {
      const loadingEl = document.getElementById('superowner-reports-loading');
      const contentEl = document.getElementById('superowner-reports-content');

      loadingEl.style.display = 'block';
      contentEl.style.display = 'none';
      contentEl.innerHTML = ''; // Kosongkan konten lama

      // (Sekitar baris 2319 di index.html)
      try {
        const superownerId = AppState.currentUser.user_info.id;

        // === LOGIKA FILTER BARU ===
        const params = new URLSearchParams();
        const startDate = document.getElementById('so-report-start-date').value;
        const endDate = document.getElementById('so-report-end-date').value;
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        // === AKHIR LOGIKA BARU ===

        // 1. PANGGIL API BARU KITA DENGAN PARAMETER
        const resp = await fetch(`/api/get_superowner_owner_reports/${superownerId}?${params.toString()}`);
        const result = await resp.json();
        if (!result.success) throw new Error(result.message);

        if (result.reports.length === 0) {
          contentEl.innerHTML = `<div class="alert alert-info text-center">Belum ada laporan profit dari owner manapun.</div>`;
        } else {
          // 2. BANGUN TAMPILAN ACCORDION
          contentEl.innerHTML = result.reports.map((r, index) => {
            // Buat daftar lapak (sesuai permintaan Anda)
            const lapakListHtml = r.lapak_names.length === 0
              ? '<li class="list-group-item text-muted">Owner ini belum memiliki lapak.</li>'
              : r.lapak_names.map(name => `<li class="list-group-item">${name}</li>`).join('');

            const isFirstItem = index === 0;

            return `
                <div class="accordion-item">
                  <h2 class="accordion-header" id="heading-owner-${r.owner_id}">
                    <button class="accordion-button ${isFirstItem ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-owner-${r.owner_id}">
                      <strong>${r.owner_name}</strong>
                    </button>
                  </h2>
                  <div id="collapse-owner-${r.owner_id}" class="accordion-collapse collapse ${isFirstItem ? 'show' : ''}" data-bs-parent="#superowner-reports-content">
                    <div class="accordion-body">
                      <div class="row g-4">
                        <div class="col-md-5">
                          <h6>Daftar Lapak</h6>
                          <ul class="list-group list-group-flush">${lapakListHtml}</ul>
                        </div>
                        <div class="col-md-7">
                          <h6>Ringkasan Keuangan (Terkonfirmasi)</h6>
                          <table class="table table-sm table-bordered">
                            <tbody>
                              <tr>
                                <td>Total Biaya ke Supplier</td>
                                <td class="text-end fw-bold">${formatCurrency(r.total_biaya_supplier)}</td>
                              </tr>
                              <tr>
                                <td>Total Pendapatan Owner</td>
                                <td class="text-end fw-bold text-success">${formatCurrency(r.total_keuntungan_owner)}</td>
                              </tr>
                              <tr>
                                <td>Total Pendapatan Superowner</td>
                                <td class="text-end fw-bold text-primary">${formatCurrency(r.total_keuntungan_superowner)}</td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              `;
          }).join('');
        }
        // 3. Ubah display menjadi 'block' (bukan 'flex' lagi)
        contentEl.style.display = 'block';
      } catch (e) {
        contentEl.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
        contentEl.style.display = 'block';
      } finally {
        loadingEl.style.display = 'none';
      }
    }

    // FUNGSI BARU 4: Untuk mengisi halaman Riwayat Penarikan
    // (Ganti fungsi lama di baris 2359)
    async function populateSuperownerTransactions() {
      const loadingEl = document.getElementById('so-tx-loading');
      const contentEl = document.getElementById('so-tx-content');
      const tableBody = document.getElementById('so-tx-table-body');

      loadingEl.style.display = 'block';
      contentEl.style.display = 'none';
      tableBody.innerHTML = '';

      // === LOGIKA FILTER BARU ===
      const params = new URLSearchParams();
      const advancedFilterEl = document.getElementById('so-advanced-tx-filter');
      const isAdvanced = advancedFilterEl.classList.contains('show');
      let startDate, endDate;

      if (isAdvanced) {
        startDate = document.getElementById('so-tx-start-date').value;
        endDate = document.getElementById('so-tx-end-date').value;
      } else {
        const dailyDate = document.getElementById('so-tx-daily-date').value;
        startDate = dailyDate;
        endDate = dailyDate;
      }

      if (startDate) params.append('start_date', startDate);
      if (endDate) params.append('end_date', endDate);
      // === AKHIR LOGIKA FILTER ===

      try {
        const superownerId = AppState.currentUser.user_info.id;
        const resp = await fetch(`/api/get_superowner_transactions/${superownerId}?${params.toString()}`);
        const result = await resp.json();

        if (!result.success) throw new Error(result.message);

        if (result.transactions.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Tidak ada transaksi pada rentang tanggal ini.</td></tr>`;
        } else {
          tableBody.innerHTML = result.transactions.map(tx => {
            const isProfit = tx.tipe === 'profit';
            const badge = isProfit
              ? `<span class="badge bg-success">Profit Masuk</span>`
              : `<span class="badge bg-danger">Penarikan</span>`;
            const amountClass = isProfit ? 'text-success' : 'text-danger';
            const amountPrefix = isProfit ? '+' : ''; // Tanda minus sudah ada dari backend

            return `
              <tr>
                <td>${new Date(tx.tanggal + 'T00:00:00').toLocaleDateString('id-ID')}</td>
                <td>${tx.keterangan}</td>
                <td>${badge}</td>
                <td class="text-end fw-bold ${amountClass}">${amountPrefix}${formatCurrency(tx.jumlah)}</td>
              </tr>
            `;
          }).join('');
        }
        contentEl.style.display = 'block';
      } catch (e) {
        loadingEl.innerHTML = `<div class="alert alert-danger">${e.message}</div>`;
      } finally {
        loadingEl.style.display = 'none';
      }
    }

    // (Letakkan ini di dalam SUPEROWNER FUNCTIONS)

    // FUNGSI BARU 1: Untuk mengisi halaman Manajemen Owner
    async function populateSuperownerManageOwners() {
      const tableBody = document.getElementById('superowner-owners-table-body');
      tableBody.innerHTML = `<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm"></div></td></tr>`;
      try {
        const superownerId = AppState.currentUser.user_info.id;
        const resp = await fetch(`/api/get_superowner_owners/${superownerId}`);
        const result = await resp.json();
        if (!result.success) throw new Error(result.message);
        if (result.owners.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Belum ada Owner yang terdaftar.</td></tr>`;
        } else {
          tableBody.innerHTML = result.owners.map(o => `
                      <tr>
                          <td>${o.nama_lengkap}</td><td>${o.username}</td><td>${o.email}</td><td>${o.nomor_kontak}</td>
                          <td class="password-cell"><span class="password-text me-2" data-password="${o.password}"></span><i class="bi bi-eye-slash" style="cursor: pointer;" onclick="toggleTablePasswordVisibility(this)"></i></td>
                          <td><div class="btn-group">
                              <button class="btn btn-sm btn-warning" onclick='openSuperownerEditOwnerModal(${o.id})'><i class="bi bi-pencil-fill"></i></button>
                              <button class="btn btn-sm btn-danger" onclick='handleSuperownerDeleteOwner(${o.id})'><i class="bi bi-trash-fill"></i></button>
                          </div></td>
                      </tr>`).join('');
        }
      } catch (e) {
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">${e.message}</td></tr>`;
      }
    }

    // GANTI FUNGSI LAMA DENGAN VERSI BARU INI
    async function openSuperownerEditOwnerModal(id = null) {
      const form = document.getElementById("superowner-edit-owner-form");
      form.reset();
      const isEdit = id !== null;
      document.getElementById("superowner-owner-modal-title").textContent = isEdit ? "Edit Owner" : "Tambah Owner Baru";
      document.getElementById("superowner-edit-owner-id").value = id || "";

      if (isEdit) {
        // Logika untuk Mode EDIT
        const superownerId = AppState.currentUser.user_info.id;
        const resp = await fetch(`/api/get_superowner_owners/${superownerId}`);
        const result = await resp.json();
        const ownerData = result.owners.find(o => o.id === id);
        if (ownerData) {
          document.getElementById("superowner-edit-owner-nama").value = ownerData.nama_lengkap;
          document.getElementById("superowner-edit-owner-username").value = ownerData.username;
          document.getElementById("superowner-edit-owner-email").value = ownerData.email;
          document.getElementById("superowner-edit-owner-kontak").value = ownerData.nomor_kontak;
        }
      }
      // Untuk mode TAMBAH BARU, kita tidak melakukan apa-apa,
      // sehingga form NIK akan kosong dan siap diisi manual.

      modals.superownerEditOwner.show();
    }

    // FUNGSI BARU 3: Untuk submit form Owner
    async function handleSuperownerOwnerFormSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const id = form.elements["superowner-edit-owner-id"].value;
      const isEdit = id !== "";
      const url = isEdit ? `/api/update_admin/${id}` : `/api/add_admin`;
      const method = isEdit ? "PUT" : "POST";
      const password = form.elements["superowner-edit-owner-password"].value;
      const passwordConfirm = form.elements["superowner-edit-owner-password-confirm"].value;
      if (password && password !== passwordConfirm) return showToast("Password dan konfirmasi tidak cocok.", false);

      const payload = {
        nama_lengkap: form.elements["superowner-edit-owner-nama"].value,
        username: form.elements["superowner-edit-owner-username"].value,
        email: form.elements["superowner-edit-owner-email"].value,
        nomor_kontak: form.elements["superowner-edit-owner-kontak"].value,
        password, password_confirm: passwordConfirm,
        super_owner_id: AppState.currentUser.user_info.id // Kirim ID Superowner
      };

      const resp = await fetch(url, { method, headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
      const result = await resp.json();
      showToast(result.message, resp.ok);
      if (resp.ok) {
        modals.superownerEditOwner.hide();
        await populateSuperownerManageOwners();
      }
    }

    // FUNGSI BARU 4: Untuk menghapus Owner
    async function handleSuperownerDeleteOwner(id) {
      if (!confirm("Yakin ingin menghapus Owner ini?")) return;
      const resp = await fetch(`/api/delete_admin/${id}`, { method: 'DELETE' });
      const result = await resp.json();
      showToast(result.message, resp.ok);
      if (resp.ok) await populateSuperownerManageOwners();
    }

    // --- APP INITIALIZATION ---
    document.addEventListener("DOMContentLoaded", () => {
      modals.admin = new bootstrap.Modal(
        document.getElementById("edit-admin-modal")
      );
      modals.lapak = new bootstrap.Modal(
        document.getElementById("edit-lapak-modal")
      );
      modals.supplier = new bootstrap.Modal(
        document.getElementById("edit-supplier-modal")
      );
      modals.payment = new bootstrap.Modal(
        document.getElementById("payment-confirmation-modal")
      );
      modals.reportDetail = new bootstrap.Modal(
        document.getElementById("report-detail-modal")
      );
      // PERUBAHAN 7: Inisialisasi modal baru

      modals.aturProduk = new bootstrap.Modal(
        document.getElementById("atur-produk-modal")
      );
      modals.withdraw = new bootstrap.Modal(document.getElementById("superowner-withdraw-modal")
      );
      modals.superownerEditOwner = new bootstrap.Modal(document.getElementById("superowner-edit-owner-modal")
      );
      const rekapCollapseEl = document.getElementById('rekap-manual-collapse');
      if (rekapCollapseEl) {
        const rekapText = document.getElementById('toggle-rekap-text');
        const rekapIcon = document.getElementById('toggle-rekap-icon');

        // Saat akan ditampilkan (show)
        rekapCollapseEl.addEventListener('show.bs.collapse', event => {
          rekapText.textContent = 'Sembunyikan Input';
          rekapIcon.classList.remove('bi-chevron-up');
          rekapIcon.classList.add('bi-chevron-down');
        });

        // Saat akan disembunyikan (hide)
        rekapCollapseEl.addEventListener('hide.bs.collapse', event => {
          rekapText.textContent = 'Input Hasil Penjualan';
          rekapIcon.classList.remove('bi-chevron-down');
          rekapIcon.classList.add('bi-chevron-up');
        });
      }
      const todayISO = new Date().toISOString().split("T")[0];
      ["laporan-pendapatan-datepicker", "laporan-biaya-datepicker"].forEach(
        (id) => {
          const el = document.getElementById(id);
          if (el) el.value = todayISO;
        }
      );
      document
        .getElementById("login-form")
        .addEventListener("submit", handleLogin);
      document
        .getElementById("edit-admin-form")
        .addEventListener("submit", (e) => handleFormSubmit("admin", e));
      document
        .getElementById("edit-lapak-form")
        .addEventListener("submit", (e) => handleFormSubmit("lapak", e));
      document
        .getElementById("edit-supplier-form")
        .addEventListener("submit", (e) => handleFormSubmit("supplier", e));
      document
        .getElementById("payment-confirmation-form")
        .addEventListener("submit", handlePaymentSubmit);
      // ... (setelah listener handlePaymentSubmit)
      // TAMBAHAN: Event listener untuk form tambah produk di modal
      document
        .getElementById("add-product-to-supplier-form")
        .addEventListener("submit", handleAddNewProduct);

      // PERUBAHAN 8: Tambahkan event listener untuk form manual


      const lpd = document.getElementById("laporan-pendapatan-datepicker");
      if (lpd) lpd.addEventListener("change", populateLaporanPendapatan);
      const lbd = document.getElementById("laporan-biaya-datepicker");
      if (lbd) lbd.addEventListener("change", populateLaporanBiaya);
      document
        .getElementById("kirim-laporan-btn")
        .addEventListener("click", handleKirimLaporan);
      // Pasang event listener untuk input footer DI SINI
      document.querySelectorAll(".rekap-input").forEach(input => {
        input.addEventListener("input", formatNumberInput); // Untuk format angka
        input.addEventListener("keyup", updateSummarySection); // Untuk kalkulasi ulang
      });
      document.getElementById("superowner-edit-owner-form").addEventListener("submit", handleSuperownerOwnerFormSubmit);
      const filterBtn = document.getElementById('supplier-history-filter-btn');
      if (filterBtn) {
        filterBtn.addEventListener('click', populateSupplierHistoryPage);
      }
      const manageReportsFilterBtn = document.getElementById('manage-reports-filter-btn');
      if (manageReportsFilterBtn) {
        manageReportsFilterBtn.addEventListener('click', populateManageReportsPage);
      }

      const paymentHistoryFilterBtn = document.getElementById('payment-history-filter-btn');
      if (paymentHistoryFilterBtn) {
        paymentHistoryFilterBtn.addEventListener('click', populatePaymentHistory);
      }

      // (Letakkan ini di dalam 'DOMContentLoaded', setelah listener 'paymentHistoryFilterBtn')
      // (Sekitar baris 2514 di index.html)
      // Listener untuk filter status baru
      document.getElementById('manage-reports-status-filter').addEventListener('change', populateManageReportsPage);

      // Listener untuk filter harian MANAJEMEN LAPORAN
      document.getElementById('manage-reports-daily-date').addEventListener('change', () => {
        bootstrap.Collapse.getOrCreateInstance('#advanced-reports-filter').hide();
        populateManageReportsPage();
      });
      document.getElementById('manage-reports-prev-day').addEventListener('click', () => changeReportDate(-1));
      document.getElementById('manage-reports-next-day').addEventListener('click', () => changeReportDate(1));

      // (Letakkan ini di dalam 'DOMContentLoaded', setelah listener 'manage-reports-next-day')

      // Listener untuk filter harian RIWAYAT PEMBAYARAN
      document.getElementById('payment-history-daily-date').addEventListener('change', () => {
        bootstrap.Collapse.getOrCreateInstance('#advanced-payment-filter').hide();
        populatePaymentHistory();
      });
      document.getElementById('payment-history-prev-day').addEventListener('click', () => changePaymentDate(-1));
      document.getElementById('payment-history-next-day').addEventListener('click', () => changePaymentDate(1));
      // Listener untuk select metode (karena sekarang di luar)
      document.getElementById('payment-history-method').addEventListener('change', () => {
        // Jika filter harian aktif, refresh. Jika filter canggih, jangan lakukan apa-apa (tunggu tombol apply)
        const isAdvanced = document.getElementById('advanced-payment-filter').classList.contains('show');
        if (!isAdvanced) {
          populatePaymentHistory();
        }
      });

      // (Letakkan ini di dalam 'DOMContentLoaded', setelah listener 'payment-history-method')

      // Listener untuk filter baru di tab "Tagihan Saat Ini"
      document.getElementById('tagihan-metode-filter').addEventListener('change', populatePembayaranPage);

      // (Sekitar baris 2531 di index.html)
      // Listener untuk filter di halaman SO Manage Reports
      const soReportFilterBtn = document.getElementById('so-report-filter-btn');
      if (soReportFilterBtn) {
        soReportFilterBtn.addEventListener('click', populateSuperownerReports);
      }
      // (Sekitar baris 2538 di index.html)

      // Listener untuk halaman baru SO Transactions
      const soTxDailyDate = document.getElementById('so-tx-daily-date');
      if (soTxDailyDate) soTxDailyDate.addEventListener('change', () => {
        bootstrap.Collapse.getOrCreateInstance('#so-advanced-tx-filter').hide();
        populateSuperownerTransactions();
      });

      const soTxPrevDay = document.getElementById('so-tx-prev-day');
      if (soTxPrevDay) soTxPrevDay.addEventListener('click', () => changeSuperownerTxDate(-1));

      const soTxNextDay = document.getElementById('so-tx-next-day');
      if (soTxNextDay) soTxNextDay.addEventListener('click', () => changeSuperownerTxDate(1));

      const soTxFilterBtn = document.getElementById('so-tx-filter-btn');
      if (soTxFilterBtn) soTxFilterBtn.addEventListener('click', populateSuperownerTransactions);
      const ownerSupplierSelect = document.getElementById('owner-supplier-select');
      if (ownerSupplierSelect) {
        // Listener ini memastikan data tampil saat supplier DIPILIH
        ownerSupplierSelect.addEventListener('change', fetchAndDisplayOwnerSupplierHistory);
      }
      const chartFilterBtn = document.getElementById('chart-filter-btn');
      if (chartFilterBtn) {
        chartFilterBtn.addEventListener('click', fetchAndDrawCharts);
      }
      const ownerHistoryFilterBtn = document.getElementById('owner-history-filter-btn');
      if (ownerHistoryFilterBtn) {
        // Listener ini memastikan data ter-filter saat tombol DIKLIK
        ownerHistoryFilterBtn.addEventListener('click', fetchAndDisplayOwnerSupplierHistory);
      }
      /*const searchInput = document.getElementById('product-search-input');
      if (searchInput) {
          searchInput.addEventListener('input', filterReportTables);
      }*/
      // Tambahkan ini di dalam DOMContentLoaded
      modals.billDetail = new bootstrap.Modal(document.getElementById("bill-detail-modal"));
      modals.supplierBillDetail = new bootstrap.Modal(document.getElementById("supplier-bill-detail-modal"));
      // Tambahkan ini
      modals.editProduct = new bootstrap.Modal(document.getElementById("edit-product-modal"));
      document.getElementById("edit-product-form").addEventListener("submit", handleEditProductSubmit);
      manageFooterVisibility();
      handleAuthRouting();
      updateDate();
    });
    // Fungsi untuk memfilter baris tabel berdasarkan input pencarian
    document.addEventListener('DOMContentLoaded', function () {
      const searchInput = document.getElementById('main-report-search-input');
      if (!searchInput) return;

      searchInput.addEventListener('input', function () {
        const filter = this.value.toLowerCase();
        const tables = document.querySelectorAll('#report-tables-container table tbody');

        tables.forEach(tbody => {
          const rows = tbody.querySelectorAll('tr');
          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(filter) ? '' : 'none';
          });
        });
      });
    });

  </script>
</body>

</html>